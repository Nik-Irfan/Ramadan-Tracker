<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Ibadah Tracker - Public</title>
    
    <!-- Public Version -->
    <meta name="version" content="Public-release">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ramadan Tracker">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2319/2319914.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        accent: 'var(--accent-color)',
                        main: 'var(--text-main)',
                        muted: 'var(--text-muted)',
                    }
                }
            }
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&family=Lateef:wght@400;700&family=Harmattan:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s, color 0.3s; min-height: 100vh; }
        
        /* Layout Fix for Responsive Center */
        .app-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
        }

        body {
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }
        
        .dark body {
            background-color: #020617;
        }

        /* Fixed Navigation Center Fix */
        .nav-fixed {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 418px; /* 450px - 32px padding */
            z-index: 50;
        }

                
        /* Theme Variables */
        :root {
            --bg-main: #fcfcfc;
            --bg-card: #ffffff;
            --bg-inset: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --border-color: #f1f5f9;
            --accent-gradient: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            --accent-soft: #f0fdf4;
            --accent-color: #22c55e;
            --accent-shadow: rgba(34, 197, 94, 0.2);
        }

        .dark {
            --bg-main: #000000;
            --bg-card: #1a1a1a;
            --bg-inset: #000000;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --border-color: #374151;
            --accent-soft: rgba(34, 197, 94, 0.1);
        }

        .theme-rose {
            --accent-gradient: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);
            --accent-soft: #fff1f2;
            --accent-color: #e11d48;
            --accent-shadow: rgba(225, 29, 72, 0.2);
        }

        .theme-ocean {
            --accent-gradient: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
            --accent-soft: #f0f9ff;
            --accent-color: #0284c7;
            --accent-shadow: rgba(2, 132, 199, 0.2);
        }

        .theme-purple {
            --accent-gradient: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%);
            --accent-soft: #faf5ff;
            --accent-color: #7e22ce;
            --accent-shadow: rgba(126, 34, 206, 0.2);
        }

        .theme-pink {
            --accent-gradient: linear-gradient(135deg, #f472b6 0%, #db2777 100%);
            --accent-soft: #fdf2f8;
            --accent-color: #db2777;
            --accent-shadow: rgba(219, 39, 119, 0.2);
        }

        .theme-gold {
            --accent-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --accent-soft: #fffbeb;
            --accent-color: #d97706;
            --accent-shadow: rgba(217, 119, 6, 0.2);
        }

        .theme-navy {
            --accent-gradient: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            --accent-soft: #eff6ff;
            --accent-color: #8b5cf6;
            --accent-shadow: rgba(139, 92, 246, 0.2);
        }

        body { background-color: var(--bg-main); color: var(--text-main); }
        .bg-card { background-color: var(--bg-card); }
        .bg-inset { background-color: var(--bg-inset); }
        .text-main { color: var(--text-main); }
        .text-muted { color: var(--text-muted); }
        .border-theme { border-color: var(--border-color); }
        .gradient-accent { background: var(--accent-gradient); }
        .accent-soft { background: var(--accent-soft); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        .ring-accent { --tw-ring-color: var(--accent-color); }
        .shadow-accent { box-shadow: 0 10px 15px -3px var(--accent-shadow), 0 4px 6px -4px var(--accent-shadow); }

        .gradient-green { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }
        .gradient-yellow { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
        .gradient-red { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
        .gradient-blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .gradient-purple { background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%); }
        .gradient-green-soft { background: var(--accent-soft); }
        .text-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        [x-cloak] { display: none !important; }
        .custom-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .btn-active { background: var(--accent-gradient); color: white; transform: scale(1.02); box-shadow: 0 4px 12px var(--accent-shadow); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-active { color: var(--accent-color); }
        .nav-active i { transform: translateY(-4px); transition: transform 0.3s; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .animate-shimmer { animation: shimmer 3s ease-in-out infinite; }
        
        @keyframes epic-glow {
            0%, 100% { 
                box-shadow: 0 0 20px var(--accent-color), 
                           0 0 40px var(--accent-shadow),
                           0 0 60px var(--accent-color),
                           inset 0 0 20px var(--accent-shadow);
                transform: scale(1.02);
                opacity: 1;
            }
            25% { 
                box-shadow: 0 0 25px var(--accent-color), 
                           0 0 50px var(--accent-shadow),
                           0 0 70px var(--accent-color),
                           inset 0 0 25px var(--accent-shadow);
                transform: scale(1.03);
                opacity: 0.8;
            }
            50% { 
                box-shadow: 0 0 30px var(--accent-color), 
                           0 0 60px var(--accent-shadow),
                           0 0 80px var(--accent-color),
                           inset 0 0 30px var(--accent-shadow);
                transform: scale(1.04);
                opacity: 0.6;
            }
            75% { 
                box-shadow: 0 0 25px var(--accent-color), 
                           0 0 50px var(--accent-shadow),
                           0 0 70px var(--accent-color),
                           inset 0 0 25px var(--accent-shadow);
                transform: scale(1.03);
                opacity: 0.8;
            }
        }
        .epic-glow { animation: epic-glow 2s ease-in-out infinite; }

        @keyframes rotate-glow {
            0% { transform: rotate(0deg) scale(1.02); }
            100% { transform: rotate(360deg) scale(1.02); }
        }
        .rotate-glow { animation: rotate-glow 8s linear infinite; }

        @keyframes pulse-ring {
            0%, 100% { 
                box-shadow: 0 0 0 0 var(--accent-color), 
                           0 0 0 0 var(--accent-shadow);
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 0 10px var(--accent-color), 
                           0 0 0 20px var(--accent-shadow);
                opacity: 0.5;
            }
        }
        .pulse-ring { animation: pulse-ring 2s ease-out infinite; }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes rainbow-border {
            0% { border-color: rgba(251, 191, 36, 0.8); }
            25% { border-color: rgba(251, 146, 60, 0.8); }
            50% { border-color: rgba(239, 68, 68, 0.8); }
            75% { border-color: rgba(147, 51, 234, 0.8); }
            100% { border-color: rgba(251, 191, 36, 0.8); }
        }
        .rainbow-border { animation: rainbow-border 3s linear infinite !important; }

        @keyframes rotate-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .rotating-gradient { 
            background: linear-gradient(-45deg, #fbbf24, #fb923c, #ef4444, #9333ea, #fbbf24) !important;
            background-size: 400% 400% !important;
            animation: rotate-gradient 4s ease infinite !important;
        }
        .epic-glow { animation: epic-glow 1.5s ease-in-out infinite !important; }

        /* Friday special overrides - MUST override bg-card and transition-all */
        .friday-special-override {
            background: linear-gradient(-45deg, #fbbf24, #fb923c, #ef4444, #9333ea, #fbbf24) !important;
            background-size: 400% 400% !important;
            animation: rotate-gradient 4s ease infinite !important;
            transition: none !important;
        }
        .friday-special-override.epic-glow {
            animation: epic-glow 1.5s ease-in-out infinite, rotate-gradient 4s ease infinite !important;
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        /* Page Management Fixes */
        .app-container {
            height: 100vh;
            overflow: hidden;
        }
        
        .page-wrapper {
            position: relative;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .page-view {
            overflow-y: auto;
            padding: 1rem 1rem 10rem;
            width: 100%;
            height: 100%;
        }
        
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="antialiased" x-data="trackerApp()" x-init="init(); setTimeout(() => { if (!this.initialized) { this.initialized = true; } }, 1000)" :class="{ 'dark': darkMode, 'theme-rose': theme === 'rose', 'theme-ocean': theme === 'ocean', 'theme-purple': theme === 'purple', 'theme-pink': theme === 'pink', 'theme-gold': theme === 'gold', 'theme-navy': theme === 'navy' }">
    
    <!-- Gamified Loading Page -->
    <div x-show="!appReady" x-cloak class="fixed inset-0 z-[400] bg-gradient-to-br from-purple-900 via-indigo-900 to-black flex items-center justify-center">
        <div class="text-center px-6">
            <!-- Animated Logo -->
            <div class="mb-8 relative">
                <div class="w-32 h-32 mx-auto relative">
                    <!-- Outer Glow Ring -->
                    <div class="absolute inset-0 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 animate-pulse opacity-20"></div>
                    <div class="absolute inset-2 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 animate-pulse opacity-40"></div>
                    <div class="absolute inset-4 rounded-full bg-gradient-to-r from-purple-500 to-indigo-500 animate-pulse opacity-60"></div>
                    
                    <!-- Main Logo Circle -->
                    <div class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 shadow-2xl flex items-center justify-center animate-float">
                        <div class="text-white">
                            <i data-lucide="moon" class="w-16 h-16"></i>
                        </div>
                    </div>
                    
                    <!-- Orbiting Particles -->
                    <div class="absolute inset-0">
                        <div class="absolute top-0 left-1/2 w-2 h-2 bg-yellow-400 rounded-full animate-spin" style="animation-duration: 3s; transform-origin: center 64px;"></div>
                        <div class="absolute top-1/2 right-0 w-2 h-2 bg-green-400 rounded-full animate-spin" style="animation-duration: 4s; transform-origin: center -64px;"></div>
                        <div class="absolute bottom-0 left-1/2 w-2 h-2 bg-blue-400 rounded-full animate-spin" style="animation-duration: 5s; transform-origin: center 64px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Title -->
            <h1 class="text-5xl font-black text-white mb-2 tracking-tighter animate-float" style="animation-delay: 0.2s;">
                Ibadah Tracker
            </h1>
            <p class="text-2xl font-bold text-purple-200 mb-8 animate-float" style="animation-delay: 0.4s;">
                Ramadan Version
            </p>
            
            <!-- Loading Progress -->
            <div class="max-w-md mx-auto mb-8">
                <div class="bg-white/10 rounded-full h-3 overflow-hidden backdrop-blur-sm">
                    <div class="h-full bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full transition-all duration-1000 ease-out"
                         :style="`width: ${loadingProgress}%`"></div>
                </div>
                <p class="text-purple-200 text-sm mt-2 animate-pulse" x-text="loadingText"></p>
            </div>
            
            <!-- Features -->
            <div class="grid grid-cols-3 gap-4 max-w-lg mx-auto mb-8">
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 animate-float" style="animation-delay: 0.6s;">
                    <i data-lucide="moon" class="w-8 h-8 text-purple-300 mx-auto mb-2"></i>
                    <p class="text-white text-xs font-bold">Track Ibadah</p>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 animate-float" style="animation-delay: 0.8s;">
                    <i data-lucide="trophy" class="w-8 h-8 text-purple-300 mx-auto mb-2"></i>
                    <p class="text-white text-xs font-bold">Earn XP</p>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 animate-float" style="animation-delay: 1s;">
                    <i data-lucide="users" class="w-8 h-8 text-purple-300 mx-auto mb-2"></i>
                    <p class="text-white text-xs font-bold">Family Mode</p>
                </div>
            </div>
            
            <!-- Ramadan Theme -->
            <div class="text-purple-300 text-sm animate-pulse">
                <p class="mb-2">üåô Welcome to Ramadan 2026</p>
                <p class="text-xs opacity-75">Preparing your spiritual journey...</p>
            </div>
        </div>
    </div>
    <div class="app-container" x-show="appReady" style="min-height: 100vh;">
        <!-- Onboarding Screen -->
    <div x-show="view === 'onboarding'" x-cloak class="fixed inset-0 z-[100] bg-card overflow-y-auto px-6 py-12 max-w-[450px] mx-auto">
        <div class="max-w-md mx-auto">
            <div class="text-center mb-12">
                <div class="w-20 h-20 gradient-accent rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-accent animate-float">
                    <i data-lucide="moon" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-main mb-2 tracking-tighter">Ramadan Journey</h1>
                <p class="text-muted font-medium">Mulakan pengembaraan ibadah anda</p>
                <div class="mt-4">
                    <span class="text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-[0.3em] bg-slate-900 text-slate-100 border border-slate-700 shadow-sm">Public Release</span>
                </div>
            </div>

            <div class="space-y-8">
                <div>
                    <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-3 ml-2">Nama Hero</label>
                    <input type="text" x-model="onboarding.name" placeholder="Contoh: Ayah / Ibu / Ahmad" 
                        class="w-full p-5 bg-inset rounded-[2rem] border-none focus:ring-4 ring-accent font-bold text-lg transition-all text-main focus:ring-opacity-20"
                        :class="onboardingError ? 'ring-4 ring-red-500 ring-opacity-50' : ''"
                        id="heroNameInput">
                    <p x-show="onboardingError" class="text-red-500 text-[9px] font-bold mt-2 ml-2" x-text="onboardingError"></p>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-3 ml-2">Pilih Tahap Cabaran</label>
                    <div class="grid grid-cols-1 gap-4">
                        <template x-for="(data, mode) in templates" :key="mode">
                            <button @click="onboarding.mode = mode" 
                                class="p-6 rounded-[2.5rem] border-4 text-left transition-all duration-300 relative overflow-hidden"
                                :class="onboarding.mode === mode ? 'border-accent accent-soft' : 'border-transparent bg-inset'">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-black text-xl uppercase tracking-tighter" 
                                        :class="onboarding.mode === mode ? 'text-accent' : 'text-muted'" x-text="modeLabel(mode)"></span>
                                    <i data-lucide="shield-check" class="w-6 h-6 text-accent" x-show="onboarding.mode === mode"></i>
                                </div>
                                <p class="text-xs font-medium text-muted leading-relaxed pr-8" x-text="data.description"></p>
                            </button>
                        </template>
                    </div>
                </div>

                <button @click="createProfile()" 
                    class="w-full py-6 gradient-accent text-white font-black text-lg rounded-[2.5rem] shadow-accent active:scale-95 transition-transform mt-4 flex items-center justify-center gap-3">
                    <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                    Mula Kumpul XP
                </button>
                
                <button x-show="allProfiles.length > 0" @click="view = 'profiles'" class="w-full py-4 text-muted font-bold text-sm">
                    <span x-text="lang === 'en' ? 'Back to Profile List' : 'Kembali ke Senarai Profil'"></span>
                </button>

                <!-- Version Timestamp -->
                <div class="text-center mt-8">
                    <p class="text-[8px] font-black text-slate-300 uppercase tracking-[0.3em]">Last Updated: 2026-02-27 00:05</p>
                </div>
            </div>
        </div>
    </div>
 
    <!-- Page Wrapper for all main pages -->
    <div class="page-wrapper">
        <!-- Main Tracker Page -->
        <div id="view-tracker" x-show="view === 'tracker'" x-cloak class="page-view">
        <!-- Gamified Header -->
        <header class="flex justify-between items-start mb-4 relative">
            <div class="flex gap-4">
                <button @click="showUserMenu = !showUserMenu" class="relative group">
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 gradient-accent rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg relative transition-transform group-active:scale-95" style="box-shadow: var(--accent-shadow) 0 0 22px, var(--accent-shadow) 0 0 10px;">
                            <span x-text="getUserLevel().isMaxLevel ? 'Max Level' : getUserLevel().level"></span>
                        </div>
                        <div class="-mt-0.1 bg-card px-1.5 py-0.5 rounded-full text-[7px] font-black text-accent shadow-sm border border-accent/20 uppercase tracking-tighter">Level</div>
                    </div>
                </button>
                <div>
                    <h1 class="text-xl font-black text-main tracking-tighter flex items-center gap-2">
                        <span x-text="activeProfile?.name"></span>
                        <button @click="showUserMenu = !showUserMenu" class="p-1 rounded-lg hover:bg-inset transition-all">
                            <i data-lucide="chevron-down" class="w-4 h-4 text-muted"></i>
                        </button>
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-24 h-2 bg-inset rounded-full overflow-hidden">
                            <div class="h-full gradient-accent transition-all duration-1000" :style="`width: ${getUserLevel().progress}%`"></div>
                        </div>
                        <span class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="getUserLevel().isMaxLevel ? 'XP: ‚àû' : `XP: ${activeProfile?.totalXP || 0}`"></span>
                    </div>
                    <!-- User Menu Dropdown -->
                    <div x-show="showUserMenu" @click.away="showUserMenu = false" x-transition 
                        class="absolute top-12 left-0 w-48 bg-card rounded-2xl shadow-xl border border-theme z-[100] p-2 mt-1">
                        <button @click="view = 'profiles'; showUserMenu = false" class="w-full text-left p-3 hover:bg-inset rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="users" class="w-4 h-4 text-accent"></i>
                            <span class="text-xs font-bold text-main">Tukar Akaun</span>
                        </button>
                        <button @click="view = 'onboarding'; showUserMenu = false" class="w-full text-left p-3 hover:bg-inset rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="user-plus" class="w-4 h-4 text-accent"></i>
                            <span class="text-xs font-bold text-main">Tambah Akaun</span>
                        </button>
                        <button @click="logout(); showUserMenu = false" class="w-full text-left p-3 hover:bg-inset rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="log-out" class="w-4 h-4 text-red-500"></i>
                            <span class="text-xs font-bold text-red-500">Log Keluar</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div class="bg-orange-50 dark:bg-orange-900/10 px-3 py-2 rounded-2xl flex items-center gap-2 border border-orange-100 dark:border-orange-900/30">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 fill-current"></i>
                    <span class="text-xs font-black text-orange-600 dark:text-orange-400" x-text="`${calculateStreak()} Day Streak`"></span>
                </div>
            </div>
        </header>

        <!-- Day Selector -->
        <div class="mb-2">
            <div class="flex justify-between items-center mb-2 px-2">
                <h3 class="text-[10px] font-black text-muted uppercase tracking-[0.2em]" x-text="t('pilih_tarikh')"></h3>
                <button @click="showCalendar = !showCalendar" class="flex items-center gap-2 text-[10px] font-black text-accent uppercase tracking-widest bg-card px-3 py-1.5 rounded-full border border-theme shadow-sm">
                    <i :data-lucide="showCalendar ? 'list' : 'calendar'" class="w-3 h-3"></i>
                    <span x-text="showCalendar ? 'List View' : 'Calendar View'"></span>
                </button>
            </div>

            <!-- List View (Default) -->
            <div x-show="!showCalendar" x-transition:enter class="flex items-center bg-card rounded-[2rem] p-3 custom-shadow overflow-x-auto whitespace-nowrap gap-3 scrollbar-hide border border-theme">
                    <template x-for="day in 30" :key="day">
                    <button @click="currentDay = day" :data-day="day"
                        class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300 font-bold relative"
                        :class="[
                            currentDay === day ? 'gradient-accent text-white shadow-accent scale-110' : 'bg-inset text-muted',
                            isStreakDay(day) ? 'ring-2 ring-orange-300 ring-opacity-80' : ''
                        ]"
                        x-text="day">
                        <div x-show="$data.calculateTotal(day) >= 50" class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-white"></div>
                        <div x-show="isStreakDay(day)" class="absolute -bottom-1 -left-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-white"></div>
                    </button>
                </template>
            </div>

            <!-- Calendar View -->
            <div x-show="showCalendar" x-transition:enter class="bg-card rounded-[2.5rem] p-6 custom-shadow border border-theme">
                <div class="grid grid-cols-7 gap-2">
                    <template x-for="dayName in ['AHAD', 'ISNIN', 'SELASA', 'RABU', 'KHAMIS', 'JUMAAT', 'SABTU']">
                        <div class="text-[10px] font-black text-muted text-center py-2" x-text="dayName"></div>
                    </template>
                    <!-- Ramadan 2026: 1 Ramadan (Thursday, Feb 19) starts at column 4 (KHAMIS) -->
                    <!-- Add empty cells for alignment: Sunday, Monday, Tuesday, Wednesday -->
                    <template x-for="i in 4" :key="`empty-${i}`">
                        <div></div>
                    </template>
                    <template x-for="day in 30" :key="day">
                        <button @click="currentDay = day; showCalendar = false" 
                            class="aspect-square rounded-xl flex flex-col items-center justify-center transition-all relative border p-1"
                            :class="[
                                currentDay === day ? 'border-accent ring-2 ring-accent ring-opacity-20' : 'border-transparent bg-inset',
                                calculateTotal(day) > 0 ? 'opacity-100' : 'opacity-60',
                                isStreakDay(day) ? 'ring-2 ring-orange-300 ring-opacity-70' : '',
                                // Highlight Friday (Jumaat) days
                                ((day + 3) % 7 === 5) ? 'ring-2 ring-yellow-400 ring-opacity-30' : ''
                            ]">
                            <span class="text-[10px] font-black leading-none mb-1" :class="currentDay === day ? 'text-accent' : 'text-main'" x-text="day"></span>
                            
                            <!-- Friday indicator -->
                            <div x-show="(day + 3) % 7 === 5" class="absolute top-0 right-0 w-2 h-2 bg-yellow-400 rounded-full"></div>
                            
                            <!-- Percentage Text -->
                            <span class="text-[8px] font-black leading-none" :class="getDailyPct(day) > 0 ? (getDailyPct(day) >= 80 ? 'text-green-500' : (getDailyPct(day) >= 40 ? 'text-yellow-500' : 'text-red-500')) : 'text-muted/30'" x-text="`${getDailyPct(day)}%`"></span>
                            
                            <!-- Perfect Day Star -->
                            <div x-show="$data.calculateTotal(day) >= $data.getMaxScore(day)" class="absolute top-0.5 right-0.5">
                                <i data-lucide="star" class="w-2 h-2 text-yellow-400 fill-current"></i>
                            </div>

                            <div x-show="isStreakDay(day)" class="absolute bottom-0.5 left-0.5">
                                <i data-lucide="flame" class="w-2 h-2 text-orange-500 fill-current"></i>
                            </div>
                        </button>
                    </template>
                </div>
                <div class="mt-6 flex justify-center gap-4 text-[8px] font-black text-muted uppercase tracking-widest">
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-red"></div> Rendah</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-yellow"></div> Sederhana</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-green"></div> Tinggi</div>
                </div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="bg-card rounded-[2.5rem] p-8 custom-shadow mb-2 relative overflow-hidden border border-theme">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <span class="accent-soft text-accent text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest" x-text="`Ramadan Day ${currentDay}`"></span>
                    <div class="mt-2 text-[9px] font-bold text-muted uppercase tracking-widest" x-text="getMasihiDate(currentDay)"></div>
                    <h2 class="text-muted text-xs font-bold uppercase mt-4 tracking-tighter" x-text="t('misi_harian')"></h2>
                </div>
                <div class="text-right">
                    <span class="text-5xl font-black text-gradient" x-text="`${getDailyPct(currentDay)}%`"></span>
                </div>
            </div>
            <div class="h-4 bg-inset rounded-full overflow-hidden mb-3">
                <div class="h-full transition-all duration-700 ease-out" 
                     :class="getProgressColor(calculateTotal(currentDay))"
                     :style="`width: ${getDailyPct(currentDay)}%`"></div>
            </div>
            <div class="flex justify-between text-[10px] font-bold text-muted uppercase">
                <span x-text="`${calculateTotal(currentDay)} / ${getMaxScore(currentDay)} Points`"></span>
                <span x-show="getDailyPct(currentDay) === 100" class="text-yellow-500 font-black flex items-center gap-1">
                    <i data-lucide="crown" class="w-3 h-3 fill-current"></i> Perfect Day!
                </span>
            </div>
        </div>

        <!-- Combo Bonus Notification -->
        <div x-show="checkFullSolatBonus()" x-transition class="bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 p-4 rounded-3xl mb-6 flex items-center gap-4">
            <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center shadow-lg shadow-blue-100">
                <i data-lucide="zap" class="w-5 h-5 text-white fill-current"></i>
            </div>
            <div>
                <p class="text-xs font-black text-blue-600 dark:text-blue-400 uppercase tracking-tighter">Full Solat Bonus Activated!</p>
                <p class="text-[10px] font-bold text-blue-400 dark:text-blue-500 uppercase tracking-widest">+50 Bonus XP Earned</p>
            </div>
        </div>

        <!-- Ibadah List -->
        <div class="grid grid-cols-1 gap-4">
            <template x-for="(item, index) in activeProfile?.ibadahList" :key="item.id">
                <!-- Only show friday_special on Friday -->
                <div x-show="item.id !== 'friday_special' || isFriday()" 
                     :class="item.id === 'friday_special' ? 'friday-special-override rounded-[2rem] p-5 custom-shadow border border-theme relative group' : 'bg-card rounded-[2rem] p-5 custom-shadow transition-all border border-theme relative group'" 
                     :style="item.id === 'friday_special' ? 'background: var(--bg-card) !important; border: 3px solid var(--accent-color) !important; transform: scale(1.02) !important; margin-top: 1rem !important;' : ''"
                     :class="[
                         getScore(item.id) > 0 ? 'ring-2 ring-accent ring-opacity-10' : '',
                         item.id === 'friday_special' ? getFridaySpecialEffect() : ''
                     ]">
                    <!-- Edit Mode Controls -->
                    <div x-show="editMode" class="absolute -top-2 -right-2 flex gap-2 z-10">
                        <button @click="const newName = prompt('Nama baru:', item.name); if(newName) item.name = newName; save();" 
                            class="w-8 h-8 bg-accent text-white rounded-full shadow-lg flex items-center justify-center">
                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                        </button>
                        <button @click="if(confirm('Padam misi ini?')) { activeProfile.ibadahList.splice(index, 1); save(); }" 
                            class="w-8 h-8 bg-red-500 text-white rounded-full shadow-lg flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-xl accent-soft">
                                <i :data-lucide="item.icon || 'star'" class="w-4 h-4 text-accent"></i>
                            </div>
                            <div>
                                <!-- Special handling for Friday special -->
                                <template x-if="item.id === 'friday_special'">
                                    <div>
                                        <h3 class="font-bold text-sm text-main">Surah Al-Kahfi ‚≠ê</h3>
                                        <p class="text-[10px] text-muted font-medium" x-text="lang === 'en' ? 'Weekly Event' : 'Event Mingguan'"></p>
                                    </div>
                                </template>
                                <!-- Regular items -->
                                <template x-if="item.id !== 'friday_special'">
                                    <h3 class="font-bold text-sm text-main" x-text="item.name"></h3>
                                </template>
                            </div>
                        </div>
                        <span x-show="getScore(item.id) > 0" class="text-[9px] font-black text-accent accent-soft px-2 py-1 rounded-lg uppercase tracking-tighter" x-text="`Earned +${getScore(item.id)} XP`"></span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="option in item.options" :key="option.v">
                            <button @click="updateScore(item.id, option.v)"
                                class="flex-1 min-w-[70px] py-3 px-2 rounded-[1.2rem] text-[10px] font-black transition-all duration-300 border-2 flex flex-col items-center justify-center"
                                :class="getScore(item.id) === option.v ? 'btn-active border-transparent' : 'bg-inset border-transparent text-muted hover:border-accent hover:border-opacity-30'">
                                <span class="opacity-40 mb-0.5" x-text="`+${option.v}`"></span>
                                <span class="uppercase truncate w-full text-center px-1" x-text="option.l"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Add New Ibadah (Only in Edit Mode) -->
            <button x-show="editMode" @click="view = 'settings'; $nextTick(() => { document.querySelector('[x-model=\'newItem.name\']').scrollIntoView({behavior: 'smooth'}) })" 
                class="w-full py-8 border-4 border-dashed border-accent/20 rounded-[2rem] text-accent/40 font-black text-sm hover:border-accent hover:text-accent transition-all flex flex-col items-center justify-center gap-2">
                <i data-lucide="plus-circle" class="w-8 h-8"></i>
                Tambah Misi Baru
            </button>
        </div>

        <div class="mt-6">
            <button @click="editMode = !editMode" class="w-full py-4 rounded-[2rem] font-black text-[11px] uppercase tracking-widest transition-all flex items-center justify-center gap-3 border"
                :class="editMode ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-card text-muted border-theme'">
                <i :data-lucide="editMode ? 'check' : 'edit-3'" class="w-4 h-4"></i>
                <span x-text="editMode ? 'Selesai Edit' : 'Edit'"></span>
            </button>
        </div>
        </div>

    <!-- Stats Page -->
    <div x-show="view === 'stats'" x-cloak class="page-view text-center">
        <header class="mb-12 text-left">
            <h1 class="text-3xl font-black text-main tracking-tighter">Achievement</h1>
            <p class="text-muted font-medium"><span x-text="t('profil_title')"></span> <span class="text-accent font-bold" x-text="activeProfile?.name"></span></p>
        </header>

            <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme">
                <div class="absolute -top-4 -right-4 opacity-5">
                    <i data-lucide="award" class="w-32 h-32 text-accent"></i>
                </div>
                <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Total Experience</h2>
                <div class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6" x-text="`${t('setakat')} ${getMasihiDate(currentDay)}`"></div>
                <div class="text-7xl font-black text-gradient mb-2" x-text="activeProfile?.totalXP || 0"></div>
                <p class="text-[10px] font-black text-accent opacity-60 uppercase tracking-widest mb-8">XP Points Collected</p>
            
            <div class="grid grid-cols-2 gap-8 pt-8 border-t border-theme">
                <div>
                    <p class="text-3xl font-black text-main" x-text="calculateStreak()"></p>
                    <p class="text-[10px] font-bold text-muted uppercase tracking-widest mt-1">Current Streak</p>
                </div>
                <div>
                    <p class="text-3xl font-black text-main" x-text="getBestDay()"></p>
                    <p class="text-[10px] font-bold text-muted uppercase tracking-widest mt-1">Best Score</p>
                </div>
            </div>
        </div>

        <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme text-left">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="egg" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Companion</h2>
            <p class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6" x-text="t('telur_retro')"></p>

            <template x-if="!activeProfile?.pet || !activeProfile.pet.line">
                <div class="space-y-4">
                    <p class="text-xs font-bold text-main" x-text="t('pilih_jenis_telur')"></p>
                    <div class="grid grid-cols-3 gap-3">
                        <button @click="choosePetLine('flame')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="flame" class="w-6 h-6 text-orange-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Flame</p>
                        </button>
                        <button @click="choosePetLine('ocean')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="droplets" class="w-6 h-6 text-sky-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Ocean</p>
                        </button>
                        <button @click="choosePetLine('forest')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="leaf" class="w-6 h-6 text-emerald-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Forest</p>
                        </button>
                    </div>
                </div>
            </template>

            <template x-if="activeProfile?.pet && activeProfile.pet.line">
                <div>
                    <div class="flex items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-3xl flex items-center justify-center text-white shadow-accent"
                                :class="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).bgClass">
                                <i :data-lucide="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).icon" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="`Line: ${activeProfile.pet.line}`"></p>
                                <p class="text-xl font-black text-main tracking-tighter" x-text="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).name"></p>
                                <p class="text-[10px] font-bold text-muted" x-text="activeProfile.pet.hatched ? 'Hatched' : 'Belum menetas'" :class="activeProfile.pet.hatched ? 'text-green-600' : 'text-orange-600'"></p>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-[9px] font-black text-muted uppercase tracking-widest">Stage</p>
                            <p class="text-3xl font-black text-accent" x-text="getPetStage(getUserLevel().level) + 1"></p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="flex justify-between text-[10px] font-black text-muted uppercase tracking-widest mb-2">
                            <span x-text="'Progress Evolusi'"></span>
                            <span x-text="petProgressLabel(getUserLevel().level)"></span>
                        </div>
                        <div class="h-3 bg-inset rounded-full overflow-hidden">
                            <div class="h-full gradient-accent transition-all duration-700" :style="`width: ${petProgressPct(getUserLevel().level)}%`"></div>
                        </div>
                    </div>

                    <div class="mt-6" x-show="!activeProfile.pet.hatched">
                        <button @click="hatchPet()" class="w-full py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border"
                            :class="canHatchPet() ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'"
                            :disabled="!canHatchPet()">
                            <span x-text="canHatchPet() ? 'Hatch Sekarang' : 'Capai LVL 3 untuk hatch'"></span>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="book-open" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Quran Khatam Journey</h2>
            <div class="flex justify-between items-end mb-6">
                <div class="text-left">
                    <span class="text-5xl font-black text-gradient" x-text="calculateTotalJuz()"></span>
                    <span class="text-muted font-black text-xs uppercase ml-1">/ 30 Juz</span>
                </div>
                <div class="text-right">
                    <span class="text-xl font-black text-accent" x-text="`${Math.round((calculateTotalJuz() / 30) * 100)}%`"></span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="h-3 bg-inset rounded-full overflow-hidden mb-8">
                <div class="h-full gradient-accent transition-all duration-1000" :style="`width: ${(calculateTotalJuz() / 30) * 100}%`"></div>
            </div>

            <!-- Juzu' Grid -->
            <div class="grid grid-cols-10 gap-1.5">
                <template x-for="j in 30" :key="j">
                    <div class="aspect-square rounded-md flex items-center justify-center text-[8px] font-black transition-all duration-500"
                         :class="calculateTotalJuz() >= j ? 'gradient-accent text-white shadow-sm scale-105' : 'bg-inset text-muted/30'"
                         x-text="j">
                    </div>
                </template>
            </div>
            <p class="text-[8px] font-bold text-muted uppercase tracking-[0.2em] mt-6 text-center">
                <i data-lucide="info" class="w-3 h-3 inline-block mr-1 -mt-0.5 opacity-50"></i>
                <span x-text="t('juzu_unlocked')"></span>
            </p>
        </div>

        <!-- Badge Showcase -->
        <div class="mb-10 px-2">
            <h3 class="font-black text-main uppercase text-xs tracking-widest text-left ml-2 mb-6 flex items-center gap-2">
                <i data-lucide="award" class="w-4 h-4 text-accent"></i>
                <span x-text="t('koleksi_badge')"></span>
            </h3>
            <div class="grid grid-cols-4 gap-3">
                <template x-for="badge in badgeDefinitions" :key="badge.id">
                    <button @click="selectedBadge = badge" class="flex flex-col items-center gap-2 transition-transform active:scale-90">
                        <div class="w-16 h-16 rounded-[1.5rem] flex items-center justify-center transition-all duration-500 relative group"
                             :class="hasBadge(badge.id) ? badge.colorClass : 'bg-slate-100 dark:bg-slate-800 grayscale opacity-40'">
                            <i :data-lucide="badge.icon" class="w-8 h-8 text-white"></i>
                        </div>
                        <span class="text-[8px] font-black text-muted uppercase tracking-tighter text-center leading-tight" x-text="badge.name"></span>
                    </button>
                </template>
            </div>
        </div>

        <div class="space-y-4 text-left px-2">
            <h3 class="font-black text-main uppercase text-xs tracking-widest ml-2" x-text="t('prestasi_fasa')"></h3>
            <div class="grid grid-cols-1 gap-3">
                <template x-for="part in [1, 2, 3]" :key="part">
                    <div class="bg-card p-6 rounded-[2.5rem] custom-shadow flex items-center justify-between border border-theme">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-inset flex items-center justify-center font-black text-accent" x-text="part"></div>
                            <div>
                                <p class="text-xs font-black text-main uppercase tracking-tighter" x-text="part === 1 ? (lang === 'en' ? 'Ar-Rahmah' : 'Fasa Rahmat') : (part === 2 ? (lang === 'en' ? 'Al-Maghfirah' : 'Fasa Maghfirah') : (lang === 'en' ? 'Al-Itqu minan Nar' : 'Fasa Pembebasan'))"></p>
                                <p class="text-[9px] font-bold text-muted uppercase" x-text="`Day ${part*10-9} to ${part*10}`"></p>
                                <p class="text-[8px] font-bold text-muted mt-1" x-text="part === 1 ? (lang === 'en' ? 'Phase of love' : 'Fasa kasih sayang') : (part === 2 ? (lang === 'en' ? 'Forgiveness' : 'Keampunan') : (lang === 'en' ? 'Freedom from hellfire' : 'Pembebasan daripada api neraka'))"></p>
                            </div>
                        </div>
                        <p class="text-2xl font-black text-accent" x-text="`${calculatePartAverage(part)}%`"></p>
                    </div>
                </template>
            </div>
        </div>

        <div class="mt-10 bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme text-left">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <p class="text-[9px] font-black text-muted uppercase tracking-[0.2em]" x-text="lang === 'en' ? 'Daily Reminder' : 'Peringatan Harian'"></p>
                    <h2 class="text-lg font-black text-main tracking-tighter" x-text="lang === 'en' ? 'Islamic Quote' : 'Quote Islam'"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="copyIslamicQuote()" class="px-3 py-2 rounded-2xl bg-inset border border-theme text-[9px] font-black uppercase tracking-widest text-muted hover:text-accent transition-all flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        <span x-text="lang === 'en' ? 'Copy' : 'Salin'"></span>
                    </button>
                    <button @click="randomizeIslamicQuote(true)" class="px-3 py-2 rounded-2xl bg-inset border border-theme text-[9px] font-black uppercase tracking-widest text-muted hover:text-accent transition-all flex items-center gap-2">
                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                        <span x-text="lang === 'en' ? 'Random' : 'Rawak'"></span>
                    </button>
                </div>
            </div>

            <div class="p-5 bg-inset rounded-2xl border border-theme">
                <p class="text-sm font-bold text-main leading-relaxed" x-text="getIslamicQuote().text"></p>
                <div class="mt-4 pt-4 border-t border-theme">
                    <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="getIslamicQuote().source"></p>
                    <p class="text-[10px] font-bold text-muted" x-text="getIslamicQuote().ref"></p>
                </div>
                <p class="text-[9px] font-black text-accent mt-4" x-show="quoteCopyStatus" x-text="quoteCopyStatus"></p>
            </div>
        </div>
    </div>

    <!-- Clean Profile Selection Screen (Outside Page Wrapper) -->
    <div x-show="view === 'profiles'" x-cloak class="fixed inset-0 z-[200] bg-card overflow-y-auto px-6 py-12">
        <div class="max-w-md mx-auto">
            <div class="text-center mb-12">
                <div class="w-20 h-20 gradient-accent rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-accent animate-float">
                    <i data-lucide="users" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-main mb-2 tracking-tighter" x-text="t('arena_keluarga')"></h1>
                <p class="text-muted font-medium" x-text="t('pilih_karakter')"></p>
            </div>

            <div class="grid grid-cols-1 gap-4 mb-12">
                <template x-for="p in allProfiles" :key="p.id">
                    <button @click="switchProfile(p.id)" 
                        class="p-6 rounded-[2.5rem] bg-card border border-theme custom-shadow flex items-center justify-between transition-all relative overflow-hidden"
                        :class="activeProfileId === p.id ? 'ring-4 ring-accent ring-opacity-30 scale-[1.02]' : 'opacity-70'">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-3xl flex items-center justify-center font-black text-2xl text-white uppercase shadow-accent"
                                 :class="activeProfileId === p.id ? 'gradient-accent' : 'bg-inset'" x-text="p.name[0]"></div>
                            <div class="text-left">
                                <p class="font-black text-xl text-main tracking-tighter" x-text="p.name"></p>
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-black text-white gradient-accent px-2.5 py-1 rounded-full uppercase shadow-sm border border-white/10" x-text="`LVL ${Math.floor((p.totalXP || 0) / 500) + 1}`"></span>
                                    <span class="text-[9px] font-bold text-muted uppercase tracking-widest" x-text="modeLabel(p.mode)"></span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-black text-accent tracking-tighter" x-text="p.totalXP || 0"></p>
                            <p class="text-[9px] font-bold text-muted uppercase tracking-widest">Total XP</p>
                        </div>
                    </button>
                </template>
            </div>

            <div class="text-center">
                <button @click="view = 'tracker'" class="text-muted text-sm font-medium hover:text-accent transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                    <span x-text="t('kembali')"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Community Page -->
    <div x-show="view === 'community'" x-cloak class="page-view">
        <header class="mb-12">
            <h1 class="text-3xl font-black text-main tracking-tighter" x-text="t('komuniti_title')"></h1>
            <p class="text-muted font-medium" x-text="lang === 'en' ? 'Connect with Ramadan community' : 'Hubung dengan komuniti Ramadan'"></p>
        </header>

        <div class="max-w-2xl mx-auto">
            <!-- Internal Release Notice -->
            <div class="accent-soft rounded-2xl p-6 border border-accent/30 mb-8">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-3 h-3 bg-accent rounded-full animate-pulse"></div>
                    <span class="text-accent font-black text-sm uppercase tracking-wider">For Internal Release</span>
                </div>
                <p class="text-main text-sm" x-text="lang === 'en' ? 'Community features are currently under development for internal testing.' : 'Komuniti features are currently under development for internal testing.'"></p>
            </div>

            <!-- Features Overview -->
            <div class="bg-card rounded-2xl p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-8 text-center">Community Features</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Mosque Detection -->
                    <div class="text-center">
                        <div class="w-16 h-16 accent-soft rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="map-pin" class="w-8 h-8 text-accent"></i>
                        </div>
                        <h3 class="font-black text-main text-sm">Mosque Detection</h3>
                    </div>

                    <!-- Forum -->
                    <div class="text-center">
                        <div class="w-16 h-16 accent-soft rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="message-circle" class="w-8 h-8 text-accent"></i>
                        </div>
                        <h3 class="font-black text-main text-sm">Community Forum</h3>
                    </div>

                    <!-- Musafir Detection -->
                    <div class="text-center">
                        <div class="w-16 h-16 accent-soft rounded-2xl flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="users" class="w-8 h-8 text-accent"></i>
                        </div>
                        <h3 class="font-black text-main text-sm">Musafir Detection</h3>
                    </div>
                </div>

                <!-- Coming Soon Notice -->
                <div class="mt-8 text-center">
                    <div class="inline-flex items-center gap-2 bg-accent/10 px-4 py-2 rounded-full">
                        <i data-lucide="clock" class="w-4 h-4 text-accent"></i>
                        <span class="text-accent font-black text-sm">Coming Soon - Public Release</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Page -->
    <div x-show="view === 'settings'" x-cloak class="page-view">
        <header class="mb-12">
            <h1 class="text-3xl font-black text-main tracking-tighter" x-text="t('settings_title')"></h1>
            <p class="text-muted font-medium" x-text="t('profil_anda')"></p>
        </header>

        <div class="space-y-6">
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="languages" class="w-5 h-5 text-accent"></i>
                    <span x-text="t('bahasa')"></span>
                </h2>
                <div class="flex gap-3">
                    <button @click="lang = 'ms'; save();" class="flex-1 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border transition-all"
                        :class="lang === 'ms' ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'">BM</button>
                    <button @click="lang = 'en'; save();" class="flex-1 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border transition-all"
                        :class="lang === 'en' ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'">EN</button>
                </div>
            </div>
            <!-- Theme Settings -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="palette" class="w-5 h-5 text-accent"></i>
                    <span x-text="t('penampilan')"></span>
                </h2>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-main">Dark Mode</span>
                        <button @click="darkMode = !darkMode" 
                                class="w-12 h-6 rounded-full transition-colors relative"
                                :class="darkMode ? 'gradient-accent' : 'bg-inset'">
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"
                                 :class="darkMode ? 'translate-x-6' : ''"></div>
                        </button>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-muted uppercase tracking-widest block mb-3" x-text="t('warna_tema')"></span>
                        <div class="flex flex-wrap gap-4">
                            <button @click="theme = 'emerald'" class="w-10 h-10 rounded-full bg-emerald-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'emerald' ? 'ring-emerald-200 scale-110' : ''"></button>
                            <button @click="theme = 'navy'" class="w-10 h-10 rounded-full bg-[#1e3a8a] ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'navy' ? 'ring-blue-200 scale-110' : ''"></button>
                            <button @click="theme = 'rose'" class="w-10 h-10 rounded-full bg-rose-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'rose' ? 'ring-rose-200 scale-110' : ''"></button>
                            <button @click="theme = 'ocean'" class="w-10 h-10 rounded-full bg-sky-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'ocean' ? 'ring-sky-200 scale-110' : ''"></button>
                            <button @click="theme = 'purple'" class="w-10 h-10 rounded-full bg-purple-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'purple' ? 'ring-purple-200 scale-110' : ''"></button>
                            <button @click="theme = 'pink'" class="w-10 h-10 rounded-full bg-pink-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'pink' ? 'ring-pink-200 scale-110' : ''"></button>
                            <button @click="theme = 'gold'" class="w-10 h-10 rounded-full bg-amber-400 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'gold' ? 'ring-amber-200 scale-110' : ''"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Actions -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest" x-text="t('akaun')"></h2>
                <div class="space-y-3">
                    <button @click="view = 'profiles'" class="w-full py-5 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-accent hover:border-opacity-20">
                        <i data-lucide="users" class="w-5 h-5 text-accent"></i>
                        <span x-text="t('tukar_akaun')"></span>
                    </button>
                    <button @click="logout()" class="w-full py-5 bg-red-50 dark:bg-red-900/20 text-red-500 font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-red-200">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        Logout Hero
                    </button>
                </div>
            </div>

            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-accent"></i>
                    <span x-text="t('misi_kustom')"></span>
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-2 ml-1" x-text="t('nama_ibadah')"></label>
                        <input type="text" x-model="newItem.name" :placeholder="t('contoh_selawat')" 
                            class="w-full p-5 bg-inset rounded-2xl border-none font-bold text-sm text-main focus:ring-2 ring-accent ring-opacity-20 transition-all"
                            :class="!newItem.name || newItem.name.trim() === '' ? 'ring-2 ring-red-500' : ''">
                        <p x-show="!newItem.name || newItem.name.trim() === ''" class="text-red-500 text-[8px] font-bold mt-1 ml-2" x-text="lang === 'en' ? 'Please enter worship name' : 'Sila masukkan nama ibadah'"></p>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-2 ml-1" x-text="t('skor_deskripsi')"></label>
                        <div class="space-y-3">
                            <template x-for="(opt, index) in newItem.options" :key="index">
                                <div class="flex gap-2">
                                    <div class="w-20">
                                        <input type="number" x-model.number="opt.v" placeholder="XP" min="0" max="5" 
                                            @input="if(opt.v > 5) opt.v = 5"
                                            class="w-full p-4 bg-inset rounded-xl border-none text-xs font-black text-center text-accent"
                                            :class="opt.v > 5 || opt.v < 0 ? 'ring-2 ring-red-500' : (opt.v > 0 ? 'ring-2 ring-green-500' : '')">
                                    </div>
                                    <div class="flex-1">
                                        <input type="text" x-model="opt.l" placeholder="Deskripsi (Contoh: Ya / 2 Rakaat)" 
                                            class="w-full p-4 bg-inset rounded-xl border-none text-xs font-bold text-main">
                                    </div>
                                    <button @click="newItem.options.splice(index, 1)" x-show="newItem.options.length > 2" 
                                        :disabled="newItem.options.length <= 2"
                                        class="p-2 text-red-400 hover:text-red-500 transition-colors"
                                        :class="newItem.options.length <= 2 ? 'opacity-50 cursor-not-allowed' : ''">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div class="flex justify-between ml-2">
                                    <p x-show="opt.v > 5" class="text-red-500 text-[8px] font-bold">‚ö†Ô∏è Maksimum 5 point!</p>
                                    <p x-show="opt.v < 0" class="text-red-500 text-[8px] font-bold">‚ö†Ô∏è Minimum 0 point!</p>
                                    <p x-show="opt.v >= 1 && opt.v <= 5" class="text-green-500 text-[8px] font-bold">‚úì Valid</p>
                                </div>
                            </template>
                        </div>
                        <button @click="newItem.options.length < 5 ? newItem.options.push({v: 1, l: ''}) : null" 
                            :class="newItem.options.length >= 5 ? 'opacity-50 cursor-not-allowed' : ''"
                            class="mt-3 w-full py-3 border-2 border-dashed border-theme rounded-xl text-[10px] font-black text-muted hover:text-accent hover:border-accent transition-all flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span x-text="newItem.options.length >= 5 ? (lang === 'en' ? 'Maximum 5 options only' : 'Maksimum 5 pilihan sahaja') : t('tambah_pilihan_skor')"></span>
                        </button>
                        <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                            <p class="text-blue-700 text-[8px] font-bold" x-text="t('petua_skor')"></p>
                        </div>
                    </div>

                    <button @click="addItem()" class="w-full py-5 gradient-accent text-white font-black rounded-2xl shadow-accent active:scale-95 transition-transform mt-4" x-text="t('simpan_misi')"></button>
                </div>
            </div>

            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest flex justify-between items-center">
                    <span x-text="t('senarai_misi_semasa')"></span>
                    <button @click="syncTemplate()" class="text-[8px] bg-accent/10 text-accent px-2 py-1 rounded-md hover:bg-accent hover:text-white transition-all">
                        <i data-lucide="refresh-cw" class="w-2 h-2 inline-block mr-1"></i> Sync Template
                    </button>
                </h2>
                <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 scrollbar-hide">
                    <template x-for="(item, index) in activeProfile?.ibadahList" :key="item.id">
                        <!-- Only show friday_special on Friday in settings -->
                        <div x-show="item.id !== 'friday_special' || isFriday()" 
                             class="flex items-center justify-between p-4 bg-inset rounded-2xl">
                            <div>
                                <!-- Special handling for Friday special -->
                                <template x-if="item.id === 'friday_special'">
                                    <div>
                                        <p class="font-black text-main text-sm">Surah Al-Kahfi ‚≠ê</p>
                                        <p class="text-[9px] text-muted font-medium" x-text="lang === 'en' ? 'Weekly Event' : 'Event Mingguan'"></p>
                                    </div>
                                </template>
                                <!-- Regular items -->
                                <template x-if="item.id !== 'friday_special'">
                                    <p class="font-black text-main text-sm" x-text="item.name"></p>
                                </template>
                                <p class="text-[9px] text-muted font-black uppercase tracking-widest" x-text="`${item.options.length - 1} Pilihan`"></p>
                            </div>
                            <button @click="removeItem(index)" class="p-2 text-red-300 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="deleteActiveProfile()" class="w-full py-5 bg-red-50 dark:bg-red-900/10 text-red-500 font-black rounded-[2rem] border-2 border-dashed border-red-100 dark:border-red-900/30">
                <span x-text="t('padam_profil')"></span> <span x-text="activeProfile?.name"></span>
            </button>

            <!-- Support & Credits -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme mt-6">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest flex items-center gap-2">
                    <i data-lucide="coffee" class="w-5 h-5 text-orange-400"></i>
                    <span x-text="t('sokongan_kredit')"></span>
                </h2>
                <p class="text-[10px] font-bold text-muted uppercase tracking-widest leading-relaxed mb-6" x-text="lang === 'en' ? 'Built with ‚ù§Ô∏è for the benefit of the ummah. If this app helps you, you can support the developer here:' : 'Dibina dengan ‚ù§Ô∏è untuk manfaat ummah. Jika aplikasi ini membantu anda, anda boleh menyokong pembangun di sini:'"></p>
                <div class="space-y-3">
                    <a href="https://buymeacoffee.com/nikirfan" target="_blank" class="w-full py-5 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-orange-200">
                        <i data-lucide="coffee" class="w-5 h-5"></i>
                        Buy Me a Coffee
                    </a>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="https://github.com/Nik-Irfan/Ramadan-Tracker" target="_blank" class="py-4 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-2 text-[10px] border border-transparent hover:border-theme">
                            <i data-lucide="github" class="w-4 h-4"></i>
                            GitHub
                        </a>
                        <a href="https://my.linkedin.com/in/nikirfan98" target="_blank" class="py-4 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-2 text-[10px] border border-transparent hover:border-theme">
                            <i data-lucide="linkedin" class="w-4 h-4"></i>
                            LinkedIn
                        </a>
                    </div>
                </div>
            </div>

            <!-- Version Timestamp -->
            <div class="text-center py-8">
                <p class="text-[8px] font-black text-slate-300 dark:text-slate-600 uppercase tracking-[0.3em]">Last Updated: 2026-02-27 02:35</p>
            </div>
        </div>
    </div>

    <!-- Badge Description Modal -->
    <div x-show="selectedBadge" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="selectedBadge = null" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme animate-float">
            <div class="text-center">
                <div class="w-24 h-24 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6"
                     :class="hasBadge(selectedBadge?.id) ? selectedBadge?.colorClass : 'bg-slate-100 dark:bg-slate-800 grayscale opacity-40'">
                    <i :data-lucide="selectedBadge?.icon" class="w-12 h-12 text-white"></i>
                </div>
                <h3 class="text-2xl font-black text-main mb-2 tracking-tighter" x-text="selectedBadge?.name"></h3>
                <div class="mb-6">
                    <template x-if="hasBadge(selectedBadge?.id)">
                        <span class="bg-green-100 text-green-600 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Unlocked</span>
                    </template>
                    <template x-if="!hasBadge(selectedBadge?.id)">
                        <span class="bg-slate-100 text-slate-400 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Locked</span>
                    </template>
                </div>
                <p class="text-sm font-medium text-muted leading-relaxed mb-8" x-text="selectedBadge?.desc"></p>
                <button @click="selectedBadge = null" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent">Faham!</button>
            </div>
        </div>
    </div>

    <!-- Hafazan Juz Detail Modal -->
    <div x-show="selectedHafazanJuz" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="selectedHafazanJuz = null" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div class="text-left">
                    <p class="text-[9px] font-black text-muted uppercase tracking-[0.2em]">Hafazan Detail</p>
                    <h3 class="text-2xl font-black text-main tracking-tighter" x-text="`Juz ${selectedHafazanJuz}`"></h3>
                </div>
                <button @click="selectedHafazanJuz = null" class="p-2 rounded-xl bg-inset text-muted hover:text-red-500">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="p-4 bg-inset rounded-2xl border border-theme mb-4 text-left">
                <template x-if="hafazanStatsForJuz(selectedHafazanJuz).count === 0">
                    <p class="text-[10px] font-bold text-muted">Belum ada rekod ujian untuk Juz ini.</p>
                </template>
                <template x-if="hafazanStatsForJuz(selectedHafazanJuz).count > 0">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-main" x-text="`Purata: ${hafazanStatsForJuz(selectedHafazanJuz).avg}%`"></p>
                        <p class="text-[10px] font-bold text-muted" x-text="`Success Rate: ${hafazanStatsForJuz(selectedHafazanJuz).successRate}%`"></p>
                        <p class="text-[10px] font-bold text-muted" x-text="`Jumlah attempt: ${hafazanStatsForJuz(selectedHafazanJuz).count}`"></p>
                    </div>
                </template>
            </div>

            <div class="max-h-60 overflow-y-auto space-y-2 text-left">
                <template x-for="h in (activeProfile?.hafazanHistory || []).filter(x => x && x.juz === selectedHafazanJuz).slice(0, 30)" :key="h.ts">
                    <div class="p-3 rounded-2xl border border-theme flex items-center justify-between" :class="h.success ? 'bg-green-50' : 'bg-red-50'">
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-widest" :class="h.success ? 'text-green-700' : 'text-red-700'" x-text="h.success ? 'Success' : 'Try Again'"></p>
                            <p class="text-[10px] font-bold text-muted" x-text="`${new Date(h.ts).toLocaleString()}`"></p>
                            <p class="text-[10px] font-bold text-muted" x-text="`Mode: ${h.mode}`"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-black" :class="h.success ? 'text-green-700' : 'text-red-700'" x-text="`${h.score || 0}%`"></p>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="selectedHafazanJuz = null" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent mt-6">Tutup</button>
        </div>
    </div>

    <!-- Beta Notice Modal -->
    <div x-show="showBetaModal" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="showBetaModal = false" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme">
            <div class="text-center">
                <div class="w-20 h-20 gradient-purple rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-accent animate-float">
                    <i data-lucide="mic" class="w-10 h-10 text-white"></i>
                </div>
                <h3 class="text-2xl font-black text-main tracking-tighter mb-4">Available in Beta Release</h3>
                <p class="text-muted font-medium text-sm mb-6">Untuk Beta Release</p>
                <p class="text-[10px] font-bold text-muted mb-8 leading-relaxed">Fungsi ujian suara akan tersedia dalam versi akan datang. Sila gunakan mod MCQ untuk masa ini.</p>
                <button @click="showBetaModal = false" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent">
                    OK
                </button>
            </div>
        </div>
    </div>
    </div> <!-- Close page-wrapper -->

    <!-- Bottom Nav -->
    <nav x-show="view !== 'onboarding'" class="nav-fixed bg-card/90 backdrop-blur-2xl rounded-[3rem] p-4 custom-shadow flex justify-around items-center border border-theme">
        <button @click="view = 'tracker'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'tracker' ? 'nav-active' : 'text-muted'">
            <i data-lucide="list-checks" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_amalan')"></span>
        </button>
                <button @click="view = 'stats'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'stats' ? 'nav-active' : 'text-muted'">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_karakter')"></span>
        </button>
        <button @click="view = 'profiles'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'profiles' ? 'nav-active' : 'text-muted'">
            <i data-lucide="swords" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_arena')"></span>
        </button>
        <button @click="view = 'community'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'community' ? 'nav-active' : 'text-muted'">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('community')"></span>
        </button>
        <button @click="view = 'settings'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'settings' ? 'nav-active' : 'text-muted'">
            <i data-lucide="settings-2" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_tetapan')"></span>
        </button>
    </nav>

    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }

        function trackerApp() {
            console.log('[DEBUG] trackerApp initializing...');
            const templates = {
                'EASY': {
                    description: 'Mode untuk mula konsisten dengan mengutamakan amalan utama.',
                    list: [
                        { id: 'friday_special', name: 'Event Mingguan: Surah Al-Kahfi ‚≠ê', icon: 'book-open', options: [{v:0, l:'0 - Tiada'}, {v:20, l:'20 Ayat'}, {v:40, l:'Full Surah'}] },
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'2 rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'Bersahur'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0 - Tiada'}, {v:2, l:'2 rakaat'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0.5, l:'0.5 - Sendiri'}, {v:1, l:'Awal Waktu'}, {v:2, l:'Berjemaah'}] },
                        { id: 'rawatib_zohor', name: 'Rawatib Zohor', icon: 'clock', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'2 Rakaat'}, {v:3, l:'6 Rakaat'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0.5, l:'0.5 - Sendiri'}, {v:1, l:'Awal Waktu'}, {v:2, l:'Berjemaah'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0.5, l:'0.5 - Sendiri'}, {v:1, l:'Awal Waktu'}, {v:2, l:'Berjemaah'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'Berdoa'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0.5, l:'0.5 - Sendiri'}, {v:1, l:'Awal Waktu'}, {v:2, l:'Berjemaah'}] },
                        { id: 'rawatib_isyak', name: 'Rawatib Isyak', icon: 'clock', options: [{v:0, l:'0 - Tiada'}, {v:2, l:'2 rakaat'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0.5, l:'0.5 - Sendiri'}, {v:2, l:'Berjemaah'}, {v:3, l:'Sempurna'}] },
                        { id: 'tarawih', name: 'Terawih', icon: 'moon', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'8 Rakaat'}, {v:2, l:'8 + 3 Rakaat'}] },
                        { id: 'al_quran', name: 'Al-Quran', icon: 'book-open', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'5 m/s'}, {v:2, l:'10 m/s'}] },
                        { id: 'zikir', name: 'Zikir', icon: 'message-circle', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'100x'}, {v:2, l:'200x'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'15x'}, {v:2, l:'30x'}] },
                        { id: 'sedekah', name: 'Sedekah', icon: 'heart', options: [{v:0, l:'0 - Tiada'}, {v:1, l:'Bersedekah'}] }
                    ]
                },
                'MED': {
                    description: 'Kombinasi seimbang antara fardu, sunat rawatib dan amalan harian.',
                    list: [
                        { id: 'friday_special', name: 'Event Mingguan: Surah Al-Kahfi ‚≠ê', icon: 'book-open', options: [{v:0, l:'0'}, {v:20, l:'20 Ayat'}, {v:40, l:'Full Surah'}] },
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0'}, {v:1, l:'2 rakaat'}, {v:2, l:'4 rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}] },
                        { id: 'dhuha', name: 'Dhuha', icon: 'sun', options: [{v:0, l:'0'}, {v:1, l:'2 Rakaat'}, {v:2, l:'4 rakaat'}] },
                        { id: 'rawatib_zohor', name: 'Rawatib Zohor', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'4 Rakaat'}, {v:3, l:'6 Rakaat'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'rawatib_maghrib', name: 'Rawatib Maghrib', icon: 'clock', options: [{v:0, l:'0'}, {v:1, l:'2 Rakaat'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}] },
                        { id: 'rawatib_isyak', name: 'Rawatib Isyak', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Sempurna'}] },
                        { id: 'tarawih', name: 'Tarawih', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'8 + 3 Rakaat'}, {v:3, l:'20 Rakaat'}, {v:4, l:'20 + 3 Rakaat'}] },
                        { id: 'al_quran', name: 'Al-Quran', icon: 'book-open', options: [{v:0, l:'0'}, {v:2, l:'10 m/s'}, {v:3, l:'1 Juz (20 m/s)'}] },
                        { id: 'zikir', name: 'Zikir', icon: 'message-circle', options: [{v:0, l:'0'}, {v:2, l:'200x'}, {v:5, l:'500x'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0'}, {v:2, l:'30x'}, {v:3, l:'60x'}] },
                        { id: 'selawat', name: 'Selawat', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'25x'}, {v:2, l:'50x'}] },
                        { id: 'sedekah', name: 'Sedekah', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] }
                    ]
                },
                'HARD': {
                    description: 'Cabaran ibadah penuh merangkumi rawatib lengkap, zikir dan tadabbur Quran.',
                    list: [
                        { id: 'friday_special', name: 'Event Mingguan: Surah Al-Kahfi ‚≠ê', icon: 'book-open', options: [{v:0, l:'0'}, {v:20, l:'20 Ayat'}, {v:40, l:'Full Surah'}] },
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'4 rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Berjemaah + Awal Waktu'}] },
                        { id: 'dhuha', name: 'Dhuha', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'4 rakaat'}] },
                        { id: 'rawatib_zohor', name: 'Rawatib Zohor', icon: 'clock', options: [{v:0, l:'0'}, {v:3, l:'6 Rakaat'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Berjemaah + Awal Waktu'}] },
                        { id: 'rawatib_asar', name: 'Rawatib Asar', icon: 'clock', options: [{v:0, l:'0'}, {v:1, l:'2 Rakaat'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Berjemaah + Awal Waktu'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'rawatib_maghrib', name: 'Rawatib Maghrib', icon: 'clock', options: [{v:0, l:'0'}, {v:1, l:'2 Rakaat'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Berjemaah + Awal Waktu'}] },
                        { id: 'rawatib_isyak', name: 'Rawatib Isyak', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0.5, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Berjemaah + Awal Waktu'}] },
                        { id: 'tarawih', name: 'Tarawih', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'8 + 3 Rakaat'}, {v:3, l:'20 Rakaat'}, {v:4, l:'20 + 3 Rakaat'}] },
                        { id: 'al_quran', name: 'Al-Quran', icon: 'book-open', options: [{v:0, l:'0'}, {v:3, l:'1 Juz (20 m/s)'}, {v:4, l:'2 Juz (40 m/s)'}] },
                        { id: 'zikir', name: 'Zikir', icon: 'message-circle', options: [{v:0, l:'0'}, {v:5, l:'500x'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0'}, {v:3, l:'60x'}, {v:4, l:'120x'}, {v:5, l:'240x'}] },
                        { id: 'selawat', name: 'Selawat', icon: 'heart', options: [{v:0, l:'0'}, {v:2, l:'50x'}, {v:3, l:'100x'}] },
                        { id: 'sedekah', name: 'Sedekah', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] }
                    ]
                }
            };

            const badgeDefinitions = [
                { id: 'baitul_jannah', name: 'Baitul Jannah', icon: 'home', colorClass: 'gradient-green', desc: 'Lengkapkan sekurang-kurangnya 12 Rakaat Solat Sunat dalam sehari.' },
                { id: 'ramadan_rookie', name: 'Ramadan Rookie', icon: 'award', colorClass: 'gradient-blue', desc: 'Mula menjejak ibadah untuk hari pertama Ramadan.' },
                { id: 'fast_learner', name: 'Fast Learner', icon: 'zap', colorClass: 'gradient-purple', desc: 'Capai Level 5 dengan mengumpul XP melalui ibadah.' },
                { id: 'streak_starter', name: 'Streak Starter', icon: 'flame', colorClass: 'gradient-yellow', desc: 'Istiqamah beribadah selama 3 hari berturut-turut.' },
                { id: 'perfect_day', name: 'Perfect Day', icon: 'crown', colorClass: 'gradient-red', desc: 'Lengkapkan kesemua misi harian dengan skor 100%.' },
                { id: 'gold_hero', name: 'Gold Hero', icon: 'star', colorClass: 'gradient-yellow', desc: 'Kumpul jumlah keseluruhan sebanyak 5,000 XP.' },
                { id: 'silver_hero', name: 'Silver Hero', icon: 'star', colorClass: 'gradient-blue', desc: 'Kumpul jumlah keseluruhan sebanyak 2,500 XP.' },
                { id: 'bronze_hero', name: 'Bronze Hero', icon: 'star', colorClass: 'gradient-red', desc: 'Kumpul jumlah keseluruhan sebanyak 1,000 XP.' }
            ];

            return {
                initialized: false,
                view: 'onboarding',
                currentDay: 1,
                activeProfileId: null,
                allProfiles: [],
                lang: 'ms',
                showBetaModal: false,
                
                // Enemy System
                enemy: {
                    active: false,
                    name: '',
                    type: '',
                    description: '',
                    hadith: '',
                    xpToLose: 0
                },
                
                enemies: [
                    {
                        type: 'takabbur',
                        name: 'Takabbur',
                        description: 'Menunjuk-nunjuk dan merasa lebih baik dari orang lain, menyembunyikan pahala amalan.',
                        hadith: 'Rasulullah SAW bersabda: "Tidak masuk syurga orang yang di dalam hatinya ada sebiji genggam takabbur." (HR. Tirmidzi)',
                        xpToLose: 100
                    },
                    {
                        type: 'sumah',
                        name: 'Sum\'ah',
                        description: 'Menceritakan amal ibadah yang telah dilakukan kepada orang lain untuk mendapatkan pujian.',
                        hadith: '"Sesiapa yang melakukan amal kerana sum\'ah (ingin didengar orang), nescaya Allah akan memperdengarkan aibnya. Dan sesiapa yang melakukan amal kerana riya\' (ingin dilihat orang), nescaya Allah akan memperlihatkan aibnya." (HR Bukhari & Muslim).',
                        xpToLose: 100
                    },
                    {
                        type: 'riak',
                        name: 'Riak',
                        description: 'Melakukan ibadah atau kebaikan bukan kerana Allah, tetapi untuk mendapat pujian manusia.',
                        hadith: '"Sesiapa yang melakukan amal kerana sum\'ah (ingin didengar orang), nescaya Allah akan memperdengarkan aibnya. Dan sesiapa yang melakukan amal kerana riya\' (ingin dilihat orang), nescaya Allah akan memperlihatkan aibnya." (HR Bukhari & Muslim).',
                        xpToLose: 100
                    },
                    {
                        type: 'ujub',
                        name: 'Ujub',
                        description: 'Membanggakan diri sendiri dan merasa hebat dengan amalan yang dilakukan.',
                        hadith: '"Ketika seorang lelaki berjalan dengan memakai dua helai pakaian (yang indah) sambil mengagumi dirinya sendiri (ujub) dan rambutnya disisir rapi, tiba-tiba Allah menenggelamkannya ke dalam bumi, maka dia terus terbenam di dalamnya sehingga hari kiamat." (HR Bukhari & Muslim).',
                        xpToLose: 100
                    }
                ],
                islamicQuoteIndex: 0,
                islamicQuoteDateKey: '',
                quoteCopyStatus: '',
                islamicQuotes: [
                    {
                        text: {
                            ms: '‚ÄúSesungguhnya dengan mengingati Allah hati menjadi tenang.‚Äù',
                            en: '‚ÄúSurely in the remembrance of Allah do hearts find comfort.‚Äù'
                        },
                        source: 'Quran',
                        ref: 'Surah Ar-Ra\u2019d 13:28'
                    },
                    {
                        text: {
                            ms: '‚ÄúDan bersabarlah; sesungguhnya Allah bersama orang-orang yang sabar.‚Äù',
                            en: '‚ÄúAnd be patient. Indeed, Allah is with the patient.‚Äù'
                        },
                        source: 'Quran',
                        ref: 'Surah Al-Anfal 8:46'
                    },
                    {
                        text: {
                            ms: '‚ÄúAmalan yang paling dicintai Allah ialah amalan yang berterusan walaupun sedikit.‚Äù',
                            en: '‚ÄúThe most beloved deeds to Allah are those that are consistent, even if small.‚Äù'
                        },
                        source: 'Hadith (Sahih)',
                        ref: 'Sahih al-Bukhari & Sahih Muslim (meaning)'
                    },
                    {
                        text: {
                            ms: '‚ÄúSesiapa yang beriman kepada Allah dan Hari Akhirat, hendaklah dia berkata baik atau diam.‚Äù',
                            en: '‚ÄúWhoever believes in Allah and the Last Day should speak good or remain silent.‚Äù'
                        },
                        source: 'Hadith (Sahih)',
                        ref: 'Sahih al-Bukhari & Sahih Muslim (meaning)'
                    },
                    {
                        text: {
                            ms: '‚ÄúWahai orang-orang yang beriman, bertakwalah kepada Allah dan lihatlah apa yang telah kamu sediakan untuk hari esok.‚Äù',
                            en: '‚ÄúO believers, be mindful of Allah and let every soul look to what it has sent forth for tomorrow.‚Äù'
                        },
                        source: 'Quran',
                        ref: 'Surah Al-Hashr 59:18'
                    }
                ],
                templates: templates,
                badgeDefinitions: badgeDefinitions,
                onboarding: { name: '', mode: 'EASY' },
                onboardingError: '',
                newItem: { name: '', options: [{v: 0, l: 'Tiada'}, {v: 1, l: 'Ya'}] },
                darkMode: false,
                theme: 'navy',
                selectedBadge: null,
                selectedHafazanJuz: null,
                showCalendar: false,
                editMode: false,
                showUserMenu: false,

                init() {
                    try {
                    const saved = localStorage.getItem('ramadan_rpg_data');
                    console.log('[DEBUG] Loading saved data:', saved);
                    if (saved) {
                        const data = JSON.parse(saved);
                        console.log('[DEBUG] Parsed data:', data);
                        console.log('[DEBUG] Active ID from saved:', data.activeId);
                        this.allProfiles = data.profiles || [];
                        this.activeProfileId = data.activeId;
                        console.log('[DEBUG] Setting activeProfileId to:', data.activeId);
                        this.darkMode = data.darkMode || false;
                        this.theme = this.normalizeTheme(data.theme || 'emerald');
                        this.lang = data.lang || 'ms';
                        this.islamicQuoteIndex = Number.isFinite(data.islamicQuoteIndex) ? data.islamicQuoteIndex : 0;
                        this.islamicQuoteDateKey = data.islamicQuoteDateKey || '';
                        console.log('[DEBUG] Data loaded, profiles count:', this.allProfiles.length);
                    }
                    // Ensure Friday special is at the top for all existing profiles
                    (this.allProfiles || []).forEach(p => {
                        this.ensurePet(p);
                        
                        // Check if friday_special exists and is not at the top
                        if (p.ibadahList && p.ibadahList.length > 0) {
                            const fridaySpecialIndex = p.ibadahList.findIndex(item => item.id === 'friday_special');
                            if (fridaySpecialIndex > 0) {
                                // Move friday_special to the top
                                const fridaySpecial = p.ibadahList.splice(fridaySpecialIndex, 1)[0];
                                p.ibadahList.unshift(fridaySpecial);
                            }
                            
                            // Update friday_special to use new Al-Kahfi options
                            const fridaySpecial = p.ibadahList.find(item => item.id === 'friday_special');
                            if (fridaySpecial) {
                                fridaySpecial.name = 'Event Mingguan: Surah Al-Kahfi ‚≠ê';
                                fridaySpecial.icon = 'book-open';
                                fridaySpecial.options = [
                                    {v:0, l:'0'}, 
                                    {v:5, l:'10 Ayat Awal Al-Kahfi'}, 
                                    {v:10, l:'Full Surah Al-Kahfi'}
                                ];
                            }
                        }
                        this.save();
                    });

                    this.ensureDailyIslamicQuote();
                    
                    // Auto-sync Ramadan Date
                    // Calculate current day based on actual date
                    // Ramadan 2026: February 19 (1st) to March 20 (30th)
                    const ramadanStart = new Date('2026-02-19T00:00:00+08:00'); // Malaysia timezone
                    const now = new Date();
                    const diffTime = now - ramadanStart;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    this.currentDay = Math.max(1, Math.min(30, diffDays + 1)); // Ensure between 1-30

                    this.$nextTick(() => {
                        lucide.createIcons();
                        this.scrollToCurrentDay();
                        // #region agent log
                        try {
                            const trackerEl = document.getElementById('view-tracker');
                            const mushafEl = document.getElementById('view-mushaf');
                            console.log('[DEBUG:init_nextTick]', {
                                view: this.view,
                                scrollY: window.scrollY,
                                innerHeight: window.innerHeight,
                                docHeight: document.documentElement.scrollHeight,
                                trackerTop: trackerEl ? trackerEl.getBoundingClientRect().top : null,
                                mushafTop: mushafEl ? mushafEl.getBoundingClientRect().top : null
                            });
                        } catch (e) {}
                        // #endregion
                    });
                    this.$watch('view', (newView, oldView) => this.$nextTick(() => {
                        lucide.createIcons();
                        // #region agent log
                        try {
                            const trackerEl = document.getElementById('view-tracker');
                            const mushafEl = document.getElementById('view-mushaf');
                            console.log('[DEBUG:view_watch]', {
                                oldView,
                                newView,
                                scrollY: window.scrollY,
                                innerHeight: window.innerHeight,
                                docHeight: document.documentElement.scrollHeight,
                                trackerTop: trackerEl ? trackerEl.getBoundingClientRect().top : null,
                                mushafTop: mushafEl ? mushafEl.getBoundingClientRect().top : null,
                                trackerInnerLength: trackerEl ? trackerEl.innerHTML.length : null,
                                hasActiveProfile: !!this.activeProfile,
                                ibadahCount: this.activeProfile?.ibadahList?.length ?? null
                            });
                        } catch (e) {}
                        // #endregion
                        // Always reset scroll position when switching "pages"
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        document.documentElement.scrollTop = 0;
                        document.body.scrollTop = 0;
                    }));
                    this.$watch('currentDay', () => this.$nextTick(() => { lucide.createIcons(); this.scrollToCurrentDay(); }));
                    this.$watch('darkMode', () => this.saveGlobal());
                    this.$watch('theme', () => this.saveGlobal());
                    this.$watch('lang', () => this.saveGlobal());
                    this.$watch('selectedBadge', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('selectedHafazanJuz', () => this.$nextTick(() => lucide.createIcons()));

                    // Complete loading
                    this.loadingText = 'Ready!';
                    this.loadingProgress = 100;
                    
                    // Show app after a short delay
                    setTimeout(() => {
                        this.appReady = true;
                    }, 1000);
                } catch (e) {
                    console.error('Init error:', e);
                    this.appReady = true;
                }
                    
                // Run Self-Tests on startup
                this.runTests();
                
                // Mark app as initialized
                this.initialized = true;
            },

            normalizeTheme(themeValue) {
                    if (typeof themeValue !== 'string') return 'emerald';
                    const normalized = themeValue.startsWith('theme-') ? themeValue.replace('theme-', '') : themeValue;
                    const allowed = ['emerald', 'navy', 'rose', 'ocean', 'purple', 'pink', 'gold'];
                    return allowed.includes(normalized) ? normalized : 'emerald';
                },

            get activeProfile() {
                    const profile = this.allProfiles.find(p => p.id === this.activeProfileId);
                    console.log('[DEBUG] activeProfileId:', this.activeProfileId, 'found profile:', profile);
                    console.log('[DEBUG] allProfiles count:', this.allProfiles.length);
                    console.log('[DEBUG] activeProfile.ibadahList length:', profile?.ibadahList?.length || 'undefined');
                    return profile;
                },

                randomizeIslamicQuote(persistForToday = false) {
                    const len = (this.islamicQuotes || []).length;
                    if (!len) {
                        this.islamicQuoteIndex = 0;
                        return;
                    }
                    this.islamicQuoteIndex = Math.floor(Math.random() * len);
                    if (persistForToday) {
                        this.islamicQuoteDateKey = this.getTodayKey();
                        this.save();
                    }
                    this.$nextTick(() => lucide.createIcons());
                },

                getTodayKey() {
                    const d = new Date();
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                },

                ensureDailyIslamicQuote() {
                    const today = this.getTodayKey();
                    const len = (this.islamicQuotes || []).length;
                    if (!len) {
                        this.islamicQuoteDateKey = today;
                        this.islamicQuoteIndex = 0;
                        return;
                    }
                    if (this.islamicQuoteDateKey !== today || !Number.isFinite(this.islamicQuoteIndex) || this.islamicQuoteIndex < 0 || this.islamicQuoteIndex >= len) {
                        this.islamicQuoteIndex = Math.floor(Math.random() * len);
                        this.islamicQuoteDateKey = today;
                        this.save();
                    }
                    this.$nextTick(() => lucide.createIcons());
                },

                async copyIslamicQuote() {
                    const q = this.getIslamicQuote();
                    const text = `${q.text}\n\n${q.source}\n${q.ref}`.trim();
                    const setStatus = (msg) => {
                        this.quoteCopyStatus = msg;
                        setTimeout(() => { this.quoteCopyStatus = ''; }, 1400);
                    };
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(text);
                            setStatus(this.lang === 'en' ? 'Copied!' : 'Disalin!');
                            return;
                        }
                    } catch (e) {}

                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.setAttribute('readonly', '');
                        ta.style.position = 'fixed';
                        ta.style.left = '-9999px';
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        setStatus(this.lang === 'en' ? 'Copied!' : 'Disalin!');
                    } catch (e) {
                        setStatus(this.lang === 'en' ? 'Copy failed' : 'Gagal salin');
                    }
                },

                getIslamicQuote() {
                    const q = (this.islamicQuotes || [])[this.islamicQuoteIndex] || (this.islamicQuotes || [])[0] || null;
                    if (!q) return { text: '', source: '', ref: '' };
                    const textObj = q.text || {};
                    const text = (this.lang === 'en' ? (textObj.en || textObj.ms) : (textObj.ms || textObj.en)) || '';
                    return { text, source: q.source || '', ref: q.ref || '' };
                },

                t(key) {
                    const dict = {
                        ms: {
                            nav_amalan: 'Amalan',
                            nav_quran: 'Al-Quran',
                            nav_karakter: 'Profil',
                            nav_arena: 'Karakter',
                            nav_tetapan: 'Tetapan',
                            settings_title: 'Tetapan',
                            urus_ibadah: 'Uruse Ibadah',
                            profil_anda: 'Profil Anda',
                            bahasa: 'Bahasa',
                            penampilan: 'Penampilan',
                            warna_tema: 'Warna Tema',
                            akaun: 'Akaun',
                            tukar_akaun: 'Tukar Akaun',
                            misi_kustom: 'Misi Kustom',
                            nama_ibadah: 'Nama Ibadah',
                            contoh_selawat: 'Contoh: Selawat 100x',
                            skor_deskripsi: 'Skor & Deskripsi',
                            tiada: 'Tiada',
                            ya: 'Ya',
                            tambah_pilihan_skor: 'Tambah Pilihan Skor',
                            petua_skor: 'Petua: Setiap pilihan skor maksimum 5 point',
                            simpan_misi: 'Simpan Misi',
                            senarai_misi_semasa: 'Senarai Misi Semasa',
                            padam_profil: 'Padam Profil',
                            sokongan_kredit: 'Sokongan & Kredit',
                            community: 'Komuniti',
                            komuniti_title: 'Komuniti',
                            arena_keluarga: 'Arena Keluarga',
                            pilih_karakter: 'Pilih karakter untuk teruskan misi',
                            kembali: 'Kembali',
                            pilih_tarikh: 'Pilih Tarikh',
                            misi_harian: 'Misi Harian',
                            profil_title: 'Profil',
                            setakat: 'Setakat',
                            telur_retro: 'Telur retro akan evolve ikut level',
                            pilih_jenis_telur: 'Pilih jenis telur',
                            juzu_unlocked: 'Setiap juzu\' akan \'unlocked\' secara automatik mengikut rekod bacaan harian anda.',
                            koleksi_badge: 'Koleksi Badge',
                            prestasi_fasa: 'Prestasi mengikut fasa'
                        },
                        en: {
                            nav_amalan: 'Tracker',
                            nav_quran: 'Quran',
                            nav_karakter: 'Profile',
                            nav_arena: 'Character',
                            nav_tetapan: 'Settings',
                            settings_title: 'Settings',
                            urus_ibadah: 'Manage Worship',
                            profil_anda: 'Your Profile',
                            bahasa: 'Language',
                            penampilan: 'Appearance',
                            warna_tema: 'Theme Color',
                            akaun: 'Account',
                            tukar_akaun: 'Switch Account',
                            misi_kustom: 'Custom Mission',
                            nama_ibadah: 'Worship Name',
                            contoh_selawat: 'Example: Selawat 100x',
                            skor_deskripsi: 'Score & Description',
                            tiada: 'None',
                            ya: 'Yes',
                            tambah_pilihan_skor: 'Add Score Option',
                            petua_skor: 'Tip: Each score option maximum 5 points',
                            simpan_misi: 'Save Mission',
                            senarai_misi_semasa: 'Current Mission List',
                            padam_profil: 'Delete Profile',
                            sokongan_kredit: 'Support & Credits',
                            community: 'Community',
                            komuniti_title: 'Community',
                            arena_keluarga: 'Family Arena',
                            pilih_karakter: 'Choose character to continue mission',
                            kembali: 'Back',
                            pilih_tarikh: 'Select Date',
                            misi_harian: 'Daily Mission',
                            profil_title: 'Profile',
                            setakat: 'Progress',
                            telur_retro: 'Retro egg will evolve according to level',
                            pilih_jenis_telur: 'Choose egg type',
                            juzu_unlocked: 'Each juzu\' will be \'unlocked\' automatically according to your daily reading record.',
                            koleksi_badge: 'Badge Collection',
                            prestasi_fasa: 'Performance by Phase'
                        }
                    };
                    const lang = this.lang || 'ms';
                    return (dict[lang] && dict[lang][key]) ? dict[lang][key] : key;
                },

                ensurePet(p) {
                    if (!p) return;
                    if (!p.pet || typeof p.pet !== 'object') {
                        p.pet = { line: '', hatched: false, ts: null };
                    }
                    if (typeof p.pet.line !== 'string') p.pet.line = '';
                    if (typeof p.pet.hatched !== 'boolean') p.pet.hatched = false;
                },

                choosePetLine(line) {
                    const p = this.activeProfile;
                    if (!p) return;
                    this.ensurePet(p);
                    p.pet.line = line;
                    p.pet.hatched = false;
                    p.pet.ts = Date.now();
                    this.save();
                    this.$nextTick(() => lucide.createIcons());
                },

                canHatchPet() {
                    const p = this.activeProfile;
                    if (!p) return false;
                    this.ensurePet(p);
                    const lvl = this.getUserLevel().level || 1;
                    return !!p.pet.line && lvl >= 3;
                },

                hatchPet() {
                    const p = this.activeProfile;
                    if (!p) return;
                    this.ensurePet(p);
                    if (!this.canHatchPet()) return;
                    p.pet.hatched = true;
                    p.pet.hatchedAt = Date.now();
                    this.save();
                },

                getPetStage(level) {
                    const lvl = Number(level || 1);
                    if (lvl >= 12) return 4;
                    if (lvl >= 8) return 3;
                    if (lvl >= 5) return 2;
                    if (lvl >= 3) return 1;
                    return 0;
                },

                getPetMeta(line, stage) {
                    const l = (line || '').toString();
                    const s = Number(stage || 0);
                    const base = {
                        flame: {
                            bg: 'gradient-red',
                            stages: [
                                { name: 'Telur Bara', icon: 'egg' },
                                { name: 'Retak Api', icon: 'egg' },
                                { name: 'Pyro Cub', icon: 'flame' },
                                { name: 'Inferno Rogue', icon: 'swords' },
                                { name: 'Phoenix Lord', icon: 'crown' }
                            ]
                        },
                        ocean: {
                            bg: 'gradient-blue',
                            stages: [
                                { name: 'Telur Ombak', icon: 'egg' },
                                { name: 'Retak Air', icon: 'egg' },
                                { name: 'Aqua Sprite', icon: 'droplets' },
                                { name: 'Tidal Knight', icon: 'shield' },
                                { name: 'Leviathan', icon: 'award' }
                            ]
                        },
                        forest: {
                            bg: 'gradient-green',
                            stages: [
                                { name: 'Telur Rimba', icon: 'egg' },
                                { name: 'Retak Daun', icon: 'egg' },
                                { name: 'Mossling', icon: 'leaf' },
                                { name: 'Wild Ranger', icon: 'target' },
                                { name: 'Ancient Guardian', icon: 'shield-check' }
                            ]
                        }
                    };
                    const picked = base[l] || base.forest;
                    const meta = picked.stages[Math.min(Math.max(s, 0), 4)];
                    return { name: meta.name, icon: meta.icon, bgClass: picked.bg };
                },

                petProgressPct(level) {
                    const lvl = Number(level || 1);
                    const bands = [1, 3, 5, 8, 12];
                    const s = this.getPetStage(lvl);
                    const start = bands[s] || 1;
                    const end = bands[s + 1] || (start + 1);
                    const pct = Math.max(0, Math.min(1, (lvl - start) / (end - start)));
                    return Math.round(pct * 100);
                },

                petProgressLabel(level) {
                    const lvl = Number(level || 1);
                    const s = this.getPetStage(lvl);
                    const nextReq = [3, 5, 8, 12, null][s];
                    if (!nextReq) return 'MAX';
                    return `LVL ${lvl} / ${nextReq}`;
                },

                isStreakDay(day) {
                    const d = Number(day);
                    const scores = this.activeProfile?.scores || {};
                    const startDay = (() => {
                        let anchor = this.currentDay;
                        if (!scores[anchor] || Object.keys(scores[anchor] || {}).length === 0) {
                            anchor = Math.max(1, anchor - 1);
                        }
                        const len = this.calculateStreak();
                        return Math.max(1, anchor - len + 1);
                    })();
                    const endDay = (() => {
                        let anchor = this.currentDay;
                        if (!scores[anchor] || Object.keys(scores[anchor] || {}).length === 0) {
                            anchor = Math.max(1, anchor - 1);
                        }
                        return anchor;
                    })();
                    if (!Number.isFinite(d)) return false;
                    return d >= startDay && d <= endDay && (this.getDailyPct(d) > 0);
                },

                modeLabel(mode) {
                    const m = (mode || '').toString().toUpperCase();
                    const labels = {
                        ms: { EASY: 'Permulaan', MED: 'Sederhana', HARD: 'Intensif' },
                        en: { EASY: 'Beginner', MED: 'Medium', HARD: 'Intensive' }
                    };
                    const lang = this.lang || 'ms';
                    return (labels[lang] && labels[lang][m]) ? labels[lang][m] : m;
                },

                createProfile() {
                    if (!this.onboarding.name || this.onboarding.name.trim() === '') {
                        this.onboardingError = 'Sila isi nama hero terlebih dahulu';
                        document.getElementById('heroNameInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        document.getElementById('heroNameInput').focus();
                        return;
                    }
                    
                    this.onboardingError = '';
                    
                    // Security: Sanitize name
                    const sanitizedName = this.onboarding.name.replace(/<[^>]*>?/gm, '').substring(0, 20);
                    const id = 'p_' + Date.now();
                    const newProfile = {
                        id: id,
                        name: sanitizedName,
                        mode: this.onboarding.mode,
                        totalXP: 0,
                        dayData: {},
                        badges: [],
                        createdAt: Date.now(),
                        ibadahList: JSON.parse(JSON.stringify(this.templates[this.onboarding.mode].list))
                    };
                    
                    this.allProfiles.push(newProfile);
                    this.activeProfileId = id;
                    this.onboarding = { name: '', mode: 'EASY' };
                    this.view = 'tracker';
                    this.save();
                },

                switchProfile(id) {
                    const p = this.allProfiles.find(x => x.id === id);
                    if (confirm(`Masuk sebagai ${p.name}?`)) {
                        this.activeProfileId = id;
                        this.view = 'tracker';
                        this.save();
                    }
                },

                logout() {
                    this.activeProfileId = null;
                    this.view = 'onboarding';
                    this.save();
                },

                showBetaNotice() {
                    this.showBetaModal = true;
                },

                deleteActiveProfile() {
                    if (confirm(`Padam profil ${this.activeProfile.name}?`)) {
                        this.allProfiles = this.allProfiles.filter(p => p.id !== this.activeProfileId);
                        this.activeProfileId = this.allProfiles.length > 0 ? this.allProfiles[0].id : null;
                        this.view = this.activeProfileId ? 'profiles' : 'onboarding';
                        this.save();
                    }
                },

                updateScore(itemId, value) {
                    const profile = this.activeProfile;
                    if (!profile) {
                        console.error('No active profile found');
                        return;
                    }
                    if (!profile.scores) profile.scores = {};
                    if (!profile.scores[this.currentDay]) profile.scores[this.currentDay] = {};
                    
                    console.log(`[DEBUG] Updating score: ${itemId} = ${value} (was ${profile.scores[this.currentDay][itemId] || 0})`);
                    
                    profile.scores[this.currentDay][itemId] = value;
                    this.recalculateTotalXP();
                    this.checkBadges();
                    
                    // Trigger enemy attack after updating score
                    this.triggerEnemyAttack();
                    
                    // Force Alpine reactivity update
                    this.$nextTick(() => {
                        console.log('[DEBUG] Alpine reactivity triggered');
                    });
                    
                    this.save();
                },

                getScore(itemId) {
                    return (this.activeProfile?.scores[this.currentDay] && this.activeProfile.scores[this.currentDay][itemId]) || 0;
                },

                calculateTotal(day, profileId = null) {
                    const p = profileId ? this.allProfiles.find(x => x.id === profileId) : this.activeProfile;
                    if (!p || !p.scores[day]) return 0;

                    const availableIds = new Set(this.getAvailableIbadahList(day, p).map(item => item.id));
                    return Object.entries(p.scores[day])
                        .filter(([itemId]) => availableIds.has(itemId))
                        .reduce((total, [, value]) => total + (Number(value) || 0), 0);
                },

                getAvailableIbadahList(day, profile = null) {
                    const p = profile || this.activeProfile;
                    if (!p || !Array.isArray(p.ibadahList)) return [];

                    return p.ibadahList.filter(item => item.id !== 'friday_special' || this.isFriday(day));
                },

                getMaxScore(day) {
                    const p = this.activeProfile;
                    if (!p) return 0;

                    const availableIbadah = this.getAvailableIbadahList(day, p);
                    let maxScore = 0;

                    availableIbadah.forEach(item => {
                        const maxOption = Math.max(...item.options.map(opt => Number(opt.v) || 0));
                        maxScore += maxOption;
                    });

                    return maxScore;
                },

                getDailyPct(day) {
                    const maxScore = this.getMaxScore(day);
                    if (maxScore <= 0) return 0;

                    const currentScore = this.calculateTotal(day);
                    return Math.min(Math.round((currentScore / maxScore) * 100), 100);
                },

                getQuizStats(type, value) {
                    const history = this.activeProfile?.hafazanHistory || [];
                    const filtered = history.filter(h => {
                        if (type === 'juz') return h.juz === value;
                        if (type === 'surah') return h.surah === value;
                        if (type === 'page') return h.page === value;
                        return false;
                    });
                    
                    if (filtered.length === 0) return { percentage: 0, total: 0, success: 0 };
                    
                    const success = filtered.filter(h => h.success).length;
                    const percentage = Math.round((success / filtered.length) * 100);
                    
                    return { percentage, total: filtered.length, success };
                },

                getProgressColor(total) {
                    const pct = (total / 50) * 100;
                    if (pct < 40) return 'gradient-red';
                    if (pct < 80) return 'gradient-yellow';
                    return 'gradient-green';
                },

                recalculateTotalXP() {
                    const p = this.activeProfile;
                    let xp = 0;
                    for (let d = 1; d <= 30; d++) {
                        xp += this.calculateTotal(d);
                        // Full Solat Bonus (+50 XP)
                        const solatIds = ['subuh', 'zohor', 'asar', 'maghrib', 'isyak'];
                        const hasAllSolat = solatIds.every(id => (p.scores[d] && p.scores[d][id] > 0));
                        if (hasAllSolat) xp += 50;
                    }
                    p.totalXP = xp;
                },

                getUserLevel(customXP = null) {
                    const xp = customXP !== null ? customXP : (this.activeProfile?.totalXP || 0);
                    const maxLevel = 12; // Maximum level for full pet evolution
                    const uncappedLevel = Math.floor(xp / 500) + 1;
                    const level = Math.min(uncappedLevel, maxLevel);
                    const progress = uncappedLevel >= maxLevel ? 100 : ((xp % 500) / 500) * 100;
                    return { level, progress, isMaxLevel: uncappedLevel >= maxLevel };
                },

                runTests() {
                    console.group('üõ†Ô∏è Ramadan RPG Self-Test Suite');
                    const tests = [
                        { name: 'Level 1 at 0 XP', result: this.getUserLevel(0).level === 1 },
                        { name: 'Level 2 at 500 XP', result: this.getUserLevel(500).level === 2 },
                        { name: 'Level 3 at 1200 XP', result: this.getUserLevel(1200).level === 3 },
                        { name: 'Progress 50% at 250 XP', result: this.getUserLevel(250).progress === 50 },
                        { name: 'Masihi Date Feb 19 for Day 1', result: this.getMasihiDate(1).includes('19 Feb') },
                        { name: 'Masihi Date Mar 20 for Day 30', result: this.getMasihiDate(30).includes('20 Mac') }
                    ];

                    tests.forEach(t => console.log(`${t.result ? '‚úÖ' : '‚ùå'} ${t.name}`));
                    console.groupEnd();
                    return tests.every(t => t.result);
                },

                calculateStreak() {
                    const scores = this.activeProfile?.scores || {};
                    let streak = 0;
                    // Check backwards from current day (or day before if today empty)
                    for (let d = 30; d >= 1; d--) {
                        if (this.calculateTotal(d) > 0) {
                            streak++;
                        } else if (streak > 0) {
                            break;
                        }
                    }
                    return streak;
                },

                checkFullSolatBonus() {
                    const p = this.activeProfile;
                    const solatIds = ['subuh', 'zohor', 'asar', 'maghrib', 'isyak'];
                    return solatIds.every(id => (p?.scores[this.currentDay] && p.scores[this.currentDay][id] > 0));
                },

                checkBadges() {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (!p.badges) p.badges = [];

                    // 1. Baitul Jannah (12 Rakaat Sunat)
                    const sunatIds = ['tahajud', 'sunat_subuh', 'dhuha', 'rawatib_zohor', 'rawatib_asar', 'rawatib_maghrib', 'rawatib_isyak', 'tarawih', 'witir'];
                    let totalSunat = 0;
                    sunatIds.forEach(id => {
                        const score = p.scores[this.currentDay]?.[id] || 0;
                        totalSunat += score;
                    });
                    if (totalSunat >= 12 && !p.badges.includes('baitul_jannah')) p.badges.push('baitul_jannah');

                    // 2. Rookie (Tracked 1 day)
                    if (this.getTotalDaysTracked() >= 1 && !p.badges.includes('ramadan_rookie')) p.badges.push('ramadan_rookie');

                    // 3. Fast Learner (Level 5)
                    if (this.getUserLevel().level >= 5 && !p.badges.includes('fast_learner')) p.badges.push('fast_learner');

                    // 4. Streak Starter (3 Days)
                    if (this.calculateStreak() >= 3 && !p.badges.includes('streak_starter')) p.badges.push('streak_starter');

                    // 5. Perfect Day
                    if (this.getDailyPct(this.currentDay) >= 100 && !p.badges.includes('perfect_day')) p.badges.push('perfect_day');

                    // Tiers
                    if (p.totalXP >= 5000 && !p.badges.includes('gold_hero')) p.badges.push('gold_hero');
                    if (p.totalXP >= 2500 && !p.badges.includes('silver_hero')) p.badges.push('silver_hero');
                    if (p.totalXP >= 1000 && !p.badges.includes('bronze_hero')) p.badges.push('bronze_hero');
                },

                hasBadge(id) {
                    return this.activeProfile?.badges?.includes(id);
                },

                calculateMonthlyAverage(profileId = null) {
                    let totalPct = 0;
                    let count = 0;
                    for (let i = 1; i <= 30; i++) {
                        const dayTotal = this.calculateTotal(i, profileId);
                        if (dayTotal > 0) {
                            totalPct += (dayTotal / 50) * 100;
                            count++;
                        }
                    }
                    return count === 0 ? 0 : Math.round(totalPct / count);
                },

                getTotalDaysTracked() {
                    return Object.keys(this.activeProfile?.scores || {}).filter(d => this.calculateTotal(d) > 0).length;
                },

                getBestDay() {
                    let max = 0;
                    for (let i = 1; i <= 30; i++) {
                        max = Math.max(max, this.calculateTotal(i));
                    }
                    return max;
                },

                calculateTotalJuz() {
                    const p = this.activeProfile;
                    if (!p) return 0;
                    let totalJuz = 0;
                    for (let d = 1; d <= 30; d++) {
                        // Support both 'quran' (Juz unit) and 'quran_ms' (Page unit)
                        const juzVal = p.scores[d]?.quran || 0;
                        const msVal = p.scores[d]?.quran_ms || 0;
                        
                        totalJuz += juzVal;
                        if (msVal > 0) {
                            // In Easy mode, 10ms = 1pt, 20ms = 2pt. 
                            // 1 Juz is approx 20 pages. So 10ms = 0.5 Juz, 20ms = 1 Juz.
                            totalJuz += (msVal * 10) / 20; 
                        }
                    }
                    return Math.min(totalJuz, 30);
                },

                hafazanStatsForJuz(juzNum) {
                    const history = this.activeProfile?.hafazanHistory || [];
                    const entries = history.filter(h => h && h.juz === juzNum);
                    if (entries.length === 0) return { count: 0, avg: 0, last: null, successRate: 0 };

                    const avg = Math.round(entries.reduce((a, e) => a + (e.score || 0), 0) / entries.length);
                    const successCount = entries.filter(e => e.success).length;
                    const last = entries[0];
                    const successRate = Math.round((successCount / entries.length) * 100);
                    return { count: entries.length, avg, last, successRate };
                },

                hafazanBoxClass(avg) {
                    if (avg >= 80) return 'bg-green-500 text-white shadow-sm scale-105';
                    if (avg >= 60) return 'bg-emerald-400 text-white';
                    if (avg >= 40) return 'bg-yellow-400 text-white';
                    if (avg > 0) return 'bg-red-400 text-white';
                    return 'bg-inset text-muted/30';
                },

                calculatePartAverage(part) {
                    let totalPct = 0;
                    let count = 0;
                    const start = (part - 1) * 10 + 1;
                    const end = part * 10;
                    for (let i = start; i <= end; i++) {
                        const dayTotal = this.calculateTotal(i);
                        if (dayTotal > 0) {
                            totalPct += (dayTotal / 50) * 100;
                            count++;
                        }
                    }
                    return count === 0 ? 0 : Math.round(totalPct / count);
                },

                addItem() {
                    // Validation: Check if name is provided
                    if (!this.newItem.name || this.newItem.name.trim() === '') {
                        alert('Sila masukkan nama ibadah terlebih dahulu.');
                        return;
                    }
                    
                    // Validation: Check minimum 2 variations
                    if (this.newItem.options.length < 2) {
                        alert('Minimum 2 pilihan skor diperlukan.');
                        return;
                    }
                    
                    // Validation: Check max 5 variations
                    if (this.newItem.options.length > 5) {
                        alert('Maksimum 5 pilihan skor dibenarkan.');
                        return;
                    }
                    
                    // Validation: Check max 5 points per option
                    const hasInvalidPoints = this.newItem.options.some(opt => opt.v > 5 || opt.v < 0);
                    if (hasInvalidPoints) {
                        alert('Maksimum 5 point dan minimum 0 point dibenarkan setiap pilihan.');
                        return;
                    }
                    
                    // Security: Sanitize custom item name
                    const sanitizedItemName = this.newItem.name.replace(/<[^>]*>?/gm, '').substring(0, 30);
                    const id = 'c_' + Date.now();
                    // Ensure options have content
                    const cleanOptions = this.newItem.options.filter(o => o.l.trim() !== '');
                    if (cleanOptions.length === 0) {
                        alert('Sila tambah sekurang-kurangnya satu pilihan skor dengan deskripsi.');
                        return;
                    }
                    // Sanitize option labels
                    const sanitizedOptions = cleanOptions.map(o => ({
                        v: Math.min(5, Math.max(0, o.v || 0)), // Ensure 0-5 range
                        l: o.l.replace(/<[^>]*>?/gm, '').substring(0, 20)
                    }));
                    // Sort by value and ensure 0 point option exists
                    sanitizedOptions.sort((a, b) => a.v - b.v);
                    if (sanitizedOptions[0]?.v !== 0) {
                        sanitizedOptions.unshift({v: 0, l: 'Tiada'});
                    }

                    this.activeProfile.ibadahList.push({ 
                        id: id, 
                        name: sanitizedItemName, 
                        icon: 'star', 
                        options: sanitizedOptions 
                    });
                    this.newItem = { name: '', options: [{v: 0, l: 'Tiada'}, {v: 1, l: 'Ya'}] };
                    this.save();
                },

                isFriday(day = this.currentDay) {
                    // Check if selected Ramadan day falls on Friday (Malaysia timezone)
                    const ramadanStart = new Date('2026-02-19T00:00:00+08:00');
                    const targetDate = new Date(ramadanStart);
                    targetDate.setUTCDate(ramadanStart.getUTCDate() + (Number(day) - 1));

                    const weekdayInMalaysia = new Intl.DateTimeFormat('en-US', {
                        weekday: 'short',
                        timeZone: 'Asia/Kuala_Lumpur'
                    }).format(targetDate);

                    return weekdayInMalaysia === 'Fri';
                },

                getFridaySpecialEffect() {
                    const isFriday = this.isFriday();
                    console.log('getFridaySpecialEffect called, isFriday:', isFriday);
                    if (!isFriday) return '';
                    
                    const effect = `
                        epic-glow
                        rotate-glow
                        pulse-ring
                        shadow-lg 
                        ring-2 ring-accent ring-opacity-30
                        transform scale-102
                    `;
                    console.log('Friday special effect applied:', effect);
                    return effect;
                },

                triggerEnemyAttack() {
                    if (Math.random() < 0.1) { // 10% chance per interaction
                        const randomEnemy = this.enemies[Math.floor(Math.random() * this.enemies.length)];
                        this.enemy.type = randomEnemy.type;
                        this.enemy.name = randomEnemy.name;
                        this.enemy.description = randomEnemy.description;
                        this.enemy.hadith = randomEnemy.hadith;
                        this.enemy.xpToLose = randomEnemy.xpToLose;
                        this.enemy.active = true;
                    }
                },

                handleEnemyResponse(accept) {
                    if (!this.enemy.active) return;
                    
                    // Set enemy name for tracking
                    const enemyData = this.enemies.find(e => e.type === this.enemy.type);
                    if (enemyData) {
                        this.enemy.name = enemyData.name;
                    }
                    
                    if (accept) {
                        // User accepts the bad feeling - XP can be reduced
                        if (this.activeProfile && this.activeProfile.totalXP >= this.enemy.xpToLose) {
                            this.activeProfile.totalXP -= this.enemy.xpToLose;
                            this.save(); // Save immediately after XP deduction
                            this.showEnemyNotification(false, `Ya, saya rasa ${this.enemy.name}.\n\n${this.enemy.hadith}\n\nAkibatnya, anda kehilangan ${this.enemy.xpToLose} XP.\n\nMuhasabah: Perbaiki niat dan kembali kepada Allah.`);
                        } else {
                            this.showEnemyNotification(true, `Ya, saya rasa ${this.enemy.name} tetapi XP tidak mencukupi.\n\n${this.enemy.hadith}\n\nBeruntunglah, Allah masih melindungi amalan anda.`);
                        }
                    } else {
                        // User resists the bad feeling - XP stays safe
                        this.showEnemyNotification(true, `Tidak, saya lawan ${this.enemy.name}.\n\n${this.enemy.hadith}\n\nAlhamdulillah, anda berjaya melawan nafsu dan amalan anda kekal diberkati.`);
                    }
                    
                    // Reset enemy state
                    this.enemy.active = false;
                    this.enemy.name = '';
                    this.enemy.type = '';
                    this.enemy.description = '';
                    this.enemy.hadith = '';
                    this.enemy.xpToLose = 0;
                    this.save();
                },

                interchangeWords(text) {
                    if (!text || typeof text !== 'string') return text;
                    
                    // Check language and provide appropriate translations
                    const isBM = this.lang === 'ms';
                    
                    if (isBM) {
                        // Return original Malay text for BM mode
                        return text;
                    } else {
                        // English translations
                        const translations = {
                            // Enemy names - keep Arabic for title, translate others
                            'Takabbur': 'Takabbur (ÿßŸÑÿ™ŸÉÿ®ÿ±)',
                            'Sum\'ah': 'Sum\'ah (ÿßŸÑÿ≥ŸÖÿπÿ©)',
                            'Riak': 'Riak (ÿßŸÑÿ±Ÿäÿßÿ°)',
                            'Ujub': 'Ujub (ÿßŸÑÿπÿ¨ÿ®)',
                            'Musuh': 'Musuh (ÿßŸÑÿπÿØŸà)',
                            
                            // Common phrases
                            '‚ö†Ô∏è Penyakit Hati': '‚ö†Ô∏è Heart Disease',
                            '1 / 4': '1 / 4',
                            'Kesemua -100 XP': 'All -100 XP',
                            'üìú Hadith:': 'üìú Hadith:',
                            '‚ö†Ô∏è Anda akan kehilangan': '‚ö†Ô∏è You will lose',
                            'XP!': 'XP!',
                            'Ya, saya rasa ini': 'Yes, I do this',
                            'Tidak, saya lawan': 'No, I resist this',
                            
                            // Enemy descriptions
                            'Menunjuk-nunjuk dan merasa lebih baik dari orang lain, menyembunyikan pahala amalan.': 'Showing off and feeling superior to others, hiding the rewards of deeds.',
                            'Menceritakan amal ibadah yang telah dilakukan kepada orang lain untuk mendapatkan pujian.': 'Telling others about worship deeds to get praise.',
                            'Melakukan ibadah atau kebaikan bukan kerana Allah, tetapi untuk mendapat pujian manusia.': 'Doing worship or good deeds not for Allah, but to get human praise.',
                            'Membanggakan diri sendiri dan merasa hebat dengan amalan yang dilakukan.': 'Being proud of oneself and feeling great with the deeds done.',
                            
                            // Hadith translations
                            'Rasulullah SAW bersabda: "Tidak masuk syurga orang yang di dalam hatinya ada sebiji genggam takabbur." (HR. Tirmidzi)': 'The Prophet (PBUH) said: "A person who has a speck of arrogance in their heart will not enter Paradise." (HR. Tirmidzi)',
                            '"Sesiapa yang melakukan amal kerana sum\'ah (ingin didengar orang), nescaya Allah akan memperdengarkan aibnya. Dan sesiapa yang melakukan amal kerana riya\' (ingin dilihat orang), nescaya Allah akan memperlihatkan aibnya." (HR Bukhari & Muslim).': '"Whoever does deeds to be heard (sum\'ah), Allah will expose their faults. And whoever does deeds to be seen (riya\'), Allah will expose their faults." (HR Bukhari & Muslim).',
                            '"Ketika seorang lelaki berjalan dengan memakai dua helai pakaian (yang indah) sambil mengagumi dirinya sendiri (ujub) dan rambutnya disisir rapi, tiba-tiba Allah menenggelamkannya ke dalam bumi, maka dia terus terbenam di dalamnya sehingga hari kiamat." (HR Bukhari & Muslim).': '"When a man was walking wearing two garments (beautiful) while admiring himself (ujub) and his hair was neatly combed, suddenly Allah caused him to sink into the earth, so he continued to sink in it until the Day of Judgment." (HR Bukhari & Muslim).'
                        };
                        
                        // Check if text exists in translations
                        if (translations[text]) {
                            return translations[text];
                        }
                    }
                    
                    // For any other text, return as-is
                    return text;
                },

                showEnemyNotification(success, message) {
                    // Create a simple notification system
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 z-[400] p-4 rounded-xl shadow-xl transform transition-all duration-500 max-w-sm ${
                        success 
                            ? 'bg-gradient-to-r from-green-500 to-green-600 text-white' 
                            : 'bg-gradient-to-r from-red-500 to-red-600 text-white'
                    }`;
                    notification.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0">
                                <i data-lucide="${success ? 'check-circle' : 'alert-triangle'}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-black text-sm mb-1">${success ? 'Victory!' : 'Defeat!'}</p>
                                <p class="text-xs opacity-90 whitespace-pre-line">${message}</p>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Initialize icons
                    lucide.createIcons();
                    
                    // Auto-remove after 8 seconds
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.style.opacity = '0';
                            notification.style.transform = 'translateX(100%)';
                            setTimeout(() => notification.remove(), 500);
                        }
                    }, 8000);
                },

                getMasihiDate(day) {
                    const ramadanStart = new Date('2026-02-19T00:00:00');
                    const targetDate = new Date(ramadanStart.getTime() + (day - 1) * 24 * 60 * 60 * 1000);
                    const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];
                    return `${targetDate.getDate()} ${months[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
                },

                removeItem(index) {
                    if (confirm('Padam ibadah ini?')) {
                        this.activeProfile.ibadahList.splice(index, 1);
                        this.save();
                    }
                },

                async fetchJuzData(juz) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 15000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Source 1: Quran.com API (Primary - More Reliable)
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?juz_number=${juz}`);
                        const data = await res.json();
                        if (data.verses && data.verses.length > 0) {
                            return data.verses.map(v => ({
                                text: v.text_uthmani,
                                surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                numberInSurah: v.verse_key.split(':')[1],
                                number: v.id
                            }));
                        }
                    } catch (e) { console.warn('Quran.com API failed, trying AlQuran.cloud...'); }

                    // Source 2: AlQuran.cloud (Fallback 1)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/juz/${juz}/quran-uthmani`);
                        const data = await res.json();
                        if (data.code === 200) return data.data.verses;
                    } catch (e) { console.warn('AlQuran.cloud Uthmani failed'); }

                    // Source 3: AlQuran.cloud (Fallback 2 - Simple)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/juz/${juz}`);
                        const data = await res.json();
                        if (data.code === 200) return data.data.verses;
                    } catch (e) { console.error('All Quran API sources failed'); }

                    throw new Error('Semua sumber API gagal dicapai.');
                },

                async fetchSurahList() {
                    try {
                        const res = await fetch('https://api.alquran.cloud/v1/surah');
                        const data = await res.json();
                        if (data.code === 200) {
                            this.mushaf.surahs = data.data;
                        }
                    } catch (e) { console.error('Failed to fetch surahs:', e); }
                },

                async fetchSurahData(surahId) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Source 1: Quran.com API (Primary)
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahId}`);
                        const data = await res.json();
                        if (data.verses && data.verses.length > 0) {
                            return data.verses.map(v => ({
                                text: v.text_uthmani,
                                surah: { name: 'Surah ' + surahId },
                                numberInSurah: v.verse_key.split(':')[1],
                                number: v.id
                            }));
                        }
                    } catch (e) { console.warn('Quran.com Surah API failed, trying AlQuran.cloud...'); }

                    // Source 2: AlQuran.cloud (Fallback)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${surahId}/quran-uthmani`);
                        const data = await res.json();
                        if (data.code === 200) {
                            return data.data.verses.map(v => ({
                                text: v.text,
                                surah: { name: data.data.name },
                                numberInSurah: v.numberInSurah,
                                number: v.number
                            }));
                        }
                    } catch (e) { console.error('Surah API failed:', e); }
                    return [];
                },

                async fetchMushaf(resetPage = true) {
                    this.mushaf.loading = true;
                    try {
                        if (this.mushaf.selectionMode === 'page') {
                            this.mushaf.verses = await this.fetchPageData(this.mushaf.currentPage);
                        } else if (this.mushaf.selectionMode === 'juz') {
                            this.mushaf.verses = await this.fetchJuzData(this.mushaf.currentJuz);
                            if (resetPage) this.mushaf.currentPage = 1;
                        } else {
                            this.mushaf.verses = await this.fetchSurahData(this.mushaf.currentSurah);
                            if (resetPage) this.mushaf.currentPage = 1;
                        }
                    } catch (e) {
                        console.error('Mushaf Error:', e);
                        alert('Gagal memuatkan Quran. Sila periksa internet.');
                    } finally {
                        this.mushaf.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                // Tajweed words data
                tajweedWords: null,
                
                // Quran Complex V1 Layout API for accurate page layouts
                quranLayout: null,
                allQuranVerses: null, // Store all Quran verses here
                quranBySurah: null, // Group verses by surah
                
                // Loading page variables
                appReady: false,
                loadingProgress: 0,
                loadingText: 'Initializing...',
                
                async loadAllQuranVerses() {
                    try {
                        this.loadingText = 'Loading Quran verses...';
                        this.loadingProgress = 20;
                        
                        console.log('Loading all Quran verses...');
                        const response = await fetch('https://api.quran.com/api/v4/quran/verses/uthmani');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.verses && data.verses.length > 0) {
                                this.allQuranVerses = data.verses;
                                this.loadingProgress = 50;
                                console.log('All Quran verses loaded:', data.verses.length, 'verses');
                                console.log('Estimated size:', JSON.stringify(data.verses).length, 'characters');
                                
                                // Group verses by surah for easier access
                                this.quranBySurah = {};
                                data.verses.forEach(verse => {
                                    const surahId = verse.chapter_id;
                                    if (!this.quranBySurah[surahId]) {
                                        this.quranBySurah[surahId] = [];
                                    }
                                    this.quranBySurah[surahId].push(verse);
                                });
                                this.loadingProgress = 70;
                                console.log('Quran grouped by', Object.keys(this.quranBySurah).length, 'surahs');
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load all Quran verses:', error);
                        this.allQuranVerses = [];
                        this.quranBySurah = {};
                    }
                },
                
                async loadTajweedWords() {
                    try {
                        this.loadingText = 'Loading Tajweed rules...';
                        this.loadingProgress = 80;
                        
                        const response = await fetch('https://qul.tarteel.ai/tajweed_words');
                        if (response.ok) {
                            const data = await response.json();
                            this.tajweedWords = data;
                            this.loadingProgress = 90;
                            console.log('Tajweed words loaded:', data);
                        }
                    } catch (error) {
                        console.error('Failed to load tajweed words:', error);
                        this.tajweedWords = [];
                    }
                },

                async fetchPageData(page) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 15000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Check cache first
                    const cacheKey = `mushaf_layout_${page}`;
                    const cachedLayout = localStorage.getItem(cacheKey);
                    
                    if (cachedLayout) {
                        console.log(`Using cached mushaf layout for page ${page}`);
                        try {
                            const layoutData = JSON.parse(cachedLayout);
                            if (layoutData && layoutData.pages && layoutData.pages[page]) {
                                return layoutData.pages[page].map(v => ({
                                    text: v.text_uthmani,
                                    surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                    numberInSurah: v.verse_key.split(':')[1],
                                    number: v.id
                                }));
                            }
                        } catch (e) {
                            console.warn('Failed to parse cached layout:', e);
                        }
                    }

                    // Fetch from Tarteel AI API
                    try {
                        const res = await fetchWithTimeout(`https://qul.tarteel.ai/resources/mushaf-layout/10`);
                        if (res.ok) {
                            const data = await res.json();
                            console.log('Tarteel AI mushaf layout response:', data);
                            
                            if (data && data.pages && data.pages[page]) {
                                // Cache the layout data
                                localStorage.setItem(cacheKey, JSON.stringify(data));
                                
                                return data.pages[page].map(v => ({
                                    text: v.text_uthmani,
                                    surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                    numberInSurah: v.verse_key.split(':')[1],
                                    number: v.id
                                }));
                            }
                        }
                    } catch (e) {
                        console.error('Tarteel AI API failed:', e);
                    }

                    // Fallback to original APIs if Tarteel fails
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?page_number=${page}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.verses && data.verses.length > 0) {
                                return data.verses.map(v => ({
                                    text: v.text_uthmani,
                                    surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                    numberInSurah: v.verse_key.split(':')[1],
                                    number: v.id
                                }));
                            }
                        }
                    } catch (e) { console.warn('Quran.com Page API failed, trying AlQuran.cloud...'); }

                    // Fallback to AlQuran.cloud
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
                        if (!res.ok) throw new Error('Bad response');
                        const data = await res.json();
                        if (data.code === 200) {
                            return data.data.verses.map(v => ({
                                text: v.text,
                                surah: { name: v.surah.name },
                                numberInSurah: v.numberInSurah,
                                number: v.number
                            }));
                        }
                    } catch (e) { console.error('Page API failed:', e); }

                    throw new Error('Semua sumber API gagal dicapai.');
                },

                get filteredSurahs() {
                    if (!this.mushaf.searchSurah) return this.mushaf.surahs;
                    return this.mushaf.surahs.filter(s => 
                        s.englishName.toLowerCase().includes(this.mushaf.searchSurah.toLowerCase()) ||
                        s.name.includes(this.mushaf.searchSurah)
                    );
                },

                get paginatedVerses() {
                    if (this.mushaf.viewMode === 'list' || this.mushaf.selectionMode === 'page') return this.mushaf.verses;
                    const perPage = 10;
                    const start = (this.mushaf.currentPage - 1) * perPage;
                    return this.mushaf.verses.slice(start, start + perPage);
                },

                get totalMushafPages() {
                    if (this.mushaf.selectionMode === 'page') return 604;
                    const perPage = 10;
                    return Math.ceil(this.mushaf.verses.length / perPage) || 1;
                },

                checkMcqAnswer(index) {
                    if (this.quiz.status !== 'idle') return;
                    
                    this.quiz.selectedMcqIndex = index;
                    const phase = this.quiz.mcqPhases[this.quiz.mcqPhase];
                    if (!phase) return;

                    if (index === phase.correctIndex) {
                        if (phase.correctText) {
                            this.quiz.mcqBuiltText = (this.quiz.mcqBuiltText ? (this.quiz.mcqBuiltText + ' ') : '') + phase.correctText;
                        }

                        if (this.quiz.mcqPhase < 2) {
                            this.quiz.mcqPhase++;
                            const next = this.quiz.mcqPhases[this.quiz.mcqPhase];
                            this.quiz.mcqOptions = next?.options || [];
                            this.quiz.mcqCorrectIndex = next?.correctIndex ?? -1;
                            this.quiz.selectedMcqIndex = -1;
                            return;
                        }

                        this.quiz.status = 'success';
                        this.quiz.feedback = 'Masha Allah! Jawapan anda tepat.';
                        this.quiz.session.correct++;
                        this.activeProfile.totalXP += 5;
                    } else {
                        this.quiz.status = 'error';
                        this.quiz.feedback = 'Jawapan kurang tepat. Sila cuba lagi.';
                        this.quiz.session.wrong++;
                    }

                    this.save();
                    this.$nextTick(() => lucide.createIcons());
                },

                unlockHintWord() {
                    const target = (this.quiz.targetContinuationText || '').trim();
                    if (!target) return;
                    const displayed = (this.quiz.verse?.text || '').trim();
                    const continuation = target.startsWith(displayed) ? target.slice(displayed.length).trim() : target;
                    const words = continuation.split(/\s+/).filter(Boolean);
                    this.quiz.hintWordsUnlocked = Math.min(words.length, (this.quiz.hintWordsUnlocked || 0) + 1);
                },

                buildContinuationTarget(verses, startIdx, targetWords = 6, finishAyahThreshold = 20) {
                    const parts = [];
                    let running = '';

                    for (let i = startIdx; i < verses.length; i++) {
                        const t = (verses[i]?.text || '').trim();
                        if (!t) continue;
                        const next = running ? (running + ' ' + t) : t;
                        const wordCount = next.split(/\s+/).filter(Boolean).length;

                        // Simple word count rule with tajweed stopping
                        if (wordCount <= 5) {
                            // Don't slice short ayahs
                            parts.push(t);
                            running = next;
                            continue;
                        }

                        if (wordCount <= 10) {
                            // Cut at 4 words for medium ayahs
                            const words = next.split(/\s+/);
                            const cutIndex = Math.min(4, words.length - 1);
                            const partial = words.slice(0, cutIndex + 1).join(' ');
                            parts.push(partial);
                            running = next;
                            break;
                        }

                        // For longer ayahs, cut at 6 words with Quran layout awareness
                        const words = next.split(/\s+/);
                        let cutIndex = Math.min(6, words.length - 1);
                        
                        // Use Quran layout API to determine proper stopping points
                        if (this.quranLayout && this.quranLayout.length > 0) {
                            // Find the verse in Quran layout that matches our current text
                            const currentVerseInLayout = this.quranLayout.find(v => 
                                v.verses && v.verses.some(verse => 
                                    verse.text && verse.text.includes(t.trim())
                                )
                            );
                            
                            if (currentVerseInLayout) {
                                // Get the verse number and ayah number from layout
                                const verseKey = currentVerseInLayout.verse_key;
                                const [surahNum, ayahNum] = verseKey.split(':').map(n => parseInt(n));
                                
                                // Find all ayahs for this surah in the layout
                                const surahAyahs = this.quranLayout
                                    .filter(v => v.verses && v.chapter_id === surahNum)
                                    .flatMap(v => v.verses || [])
                                    .map(v => ({
                                        text: v.text,
                                        number: v.verse_number,
                                        ayah: v.verse_number
                                    }));
                                
                                // Find current ayah in the layout
                                const currentAyahInLayout = surahAyahs.find(v => v.ayah === ayahNum);
                                
                                if (currentAyahInLayout) {
                                    // Determine if we should stop at this ayah
                                    const remainingAyahsInSurah = surahAyahs.filter(v => v.ayah > ayahNum);
                                    
                                    if (remainingAyahsInSurah.length === 0) {
                                        // End of surah - stop here
                                        cutIndex = words.length - 1;
                                    } else {
                                        // Stop at current ayah if there are more ayahs remaining
                                        cutIndex = Math.min(6, words.length - 1);
                                    }
                                }
                            }
                        }
                        
                        const partial = words.slice(0, cutIndex + 1).join(' ');
                        parts.push(partial);
                        running = next;
                        break;
                    }

                    return parts.join(' ').trim();
                },

                normalizeArabic(str) {
                    return (str || '')
                        .replace(/[\u064B-\u0652\u06D6-\u06ED]/g, "")
                        .replace(/[ÿ•ÿ£ÿ¢ÿß]/g, "ÿß")
                        .replace(/ÿ©/g, "Ÿá")
                        .replace(/Ÿâ/g, "Ÿä")
                        .replace(/\s+/g, ' ')
                        .trim();
                },

                computeOrderedMatchScore(userText, targetText) {
                    const u = this.normalizeArabic(userText).split(/\s+/).filter(Boolean);
                    const t = this.normalizeArabic(targetText).split(/\s+/).filter(Boolean);
                    if (t.length === 0) return { score: 0, matched: 0, total: 0 };

                    let ti = 0;
                    let matched = 0;
                    for (const w of u) {
                        while (ti < t.length) {
                            const tw = t[ti];
                            if (tw.includes(w) || w.includes(tw)) {
                                matched++;
                                ti++;
                                break;
                            }
                            ti++;
                        }
                        if (ti >= t.length) break;
                    }

                    return { score: matched / t.length, matched, total: t.length };
                },

                recordHafazanAttempt(success, score) {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (!p.hafazanHistory) p.hafazanHistory = [];
                    p.hafazanHistory.unshift({
                        ts: Date.now(),
                        juz: this.quiz.selectionMode === 'juz' ? this.quiz.currentJuz : (this.quiz.verse?.juz || null),
                        mode: this.quiz.testMode,
                        success: !!success,
                        score: Math.round((score || 0) * 100)
                    });
                    p.hafazanHistory = p.hafazanHistory.slice(0, 500);
                    this.save();
                },

                randomizeAyat() {
                    this.randomizeAyatWithinScope();
                },

                async randomizeAyatWithinScope() {
                    this.quiz.status = 'idle';
                    this.quiz.transcript = '';
                    this.quiz.matchedWords = [];
                    this.quiz.selectedMcqIndex = -1;
                    this.quiz.loading = true;

                    try {
                        let verses;

                        if (this.mushaf.selectionMode === 'page') {
                            verses = await this.fetchPageData(this.mushaf.currentPage);
                            this.quiz.selectionMode = 'page';
                        } else if (this.mushaf.selectionMode === 'juz') {
                            verses = await this.fetchJuzData(this.mushaf.currentJuz);
                            this.quiz.selectionMode = 'juz';
                            this.quiz.currentJuz = this.mushaf.currentJuz;
                        } else {
                            verses = await this.fetchSurahData(this.mushaf.currentSurah);
                            this.quiz.selectionMode = 'surah';
                            this.quiz.currentSurah = this.mushaf.currentSurah;
                        }

                        if (!verses || verses.length < 2) throw new Error('Not enough verses');

                        this.generateThreeLineQuiz(verses);
                        
                        this.quiz.session.total++;
                    } catch (e) {
                        console.error('Randomize Ayat Error:', e);
                        alert('Gagal memuatkan ayat. Sila periksa internet anda.');
                    } finally {
                        this.quiz.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                generateThreeLineQuiz(verses) {
                    let startIndex = Math.floor(Math.random() * (verses.length - 2));
                    
                    const verse1 = verses[startIndex];
                    const verse2 = verses[startIndex + 1];
                    const verse3 = verses[startIndex + 2];
                    
                    if (!verse3) {
                        this.quiz.verse = {
                            text: verse1.text,
                            nextText: verse2 ? verse2.text : '',
                            surah: verse1.surah?.name,
                            numberInSurah: verse1.numberInSurah,
                            juz: verse1.juz || this.quiz.currentJuz || null
                        };
                        
                        if (this.quiz.testMode === 'mcq') {
                            this.generateShortSurahMCQ(verses, startIndex);
                        }
                    } else {
                        this.quiz.verse = {
                            text: verse1.text,
                            nextText: verse2.text,
                            surah: verse1.surah?.name,
                            numberInSurah: verse1.numberInSurah,
                            juz: verse1.juz || this.quiz.currentJuz || null
                        };
                        
                        if (this.quiz.testMode === 'mcq') {
                            this.generateThreeLineMCQ(verse1.text, verse2.text, verse3.text, verses, startIndex);
                        }
                    }
                },

                generateThreeLineMCQ(questionText, option1Text, option2Text, allVerses, currentIndex) {
                    // Create multiple phases for 2-3 answers
                    const phases = [];
                    
                    // Phase 1: First continuation (option1Text is correct)
                    phases.push({
                        correctText: option1Text,
                        options: [questionText, option1Text, option2Text],
                        correctIndex: 1
                    });
                    
                    // Phase 2: Second continuation (need to find verse4)
                    const verse4 = allVerses[currentIndex + 3];
                    if (verse4) {
                        // Use verse3 as question, verse4 as correct answer
                        phases.push({
                            correctText: verse4.text,
                            options: [option2Text, verse4.text, verse4.text + ' ...'], // Add distractor
                            correctIndex: 1
                        });
                    }
                    
                    // Phase 3: Optional third phase
                    const verse5 = allVerses[currentIndex + 4];
                    if (verse5 && verse4) {
                        // Use verse4 as question, verse5 as correct answer
                        phases.push({
                            correctText: verse5.text,
                            options: [verse4.text, verse5.text, '...'], // Simple distractor
                            correctIndex: 1
                        });
                    }
                    
                    this.quiz.mcqPhases = phases;
                    this.quiz.mcqPhase = 0;
                    this.quiz.mcqOptions = phases[0]?.options || [];
                    this.quiz.mcqCorrectIndex = phases[0]?.correctIndex ?? -1;
                    this.quiz.mcqBuiltText = '';
                },

                generateShortSurahMCQ(verses, currentIndex) {
                    const currentVerse = verses[currentIndex];
                    const questionText = currentVerse.text;
                    
                    const distractors = verses
                        .filter((_, i) => i !== currentIndex)
                        .map(v => v.text)
                        .filter(Boolean);
                    
                    let options = [questionText];
                    
                    let attempts = 0;
                    while (options.length < 3 && attempts < 10 && distractors.length > 0) {
                        const candidate = distractors[Math.floor(Math.random() * distractors.length)];
                        if (!options.includes(candidate)) {
                            options.push(candidate);
                        }
                        attempts++;
                    }
                    
                    while (options.length < 3) {
                        const generic = `...${options.length}`;
                        if (!options.includes(generic)) {
                            options.push(generic);
                        }
                    }
                    
                    const correctIndex = 0;
                    
                    this.quiz.mcqOptions = options;
                    this.quiz.mcqCorrectIndex = correctIndex;
                    this.quiz.mcqPhase = 0;
                    this.quiz.mcqPhases = [{
                        correctText: questionText,
                        options: options,
                        correctIndex: correctIndex
                    }];
                    this.quiz.mcqBuiltText = '';
                },

                toggleRecitation() {
                    if (this.quiz.recording) {
                        this.stopRecitation();
                    } else {
                        this.startRecitation();
                    }
                },

                startRecitation() {
                    // Check for MediaRecorder support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Maaf, pelayar anda tidak menyokong rakaman audio. Sila gunakan Chrome atau Edge.');
                        return;
                    }

                    // Start audio recording
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            this.mediaRecorder = new MediaRecorder(stream);
                            this.audioChunks = [];
                            
                            this.mediaRecorder.ondataavailable = (event) => {
                                this.audioChunks.push(event.data);
                            };
                            
                            this.mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                                await this.transcribeWithWhisper(audioBlob);
                                stream.getTracks().forEach(track => track.stop());
                            };
                            
                            this.mediaRecorder.start();
                            this.quiz.recording = true;
                            this.quiz.voiceStage = 'recording';
                            this.quiz.status = 'idle';
                            this.quiz.transcript = '';
                            this.resetQuizIdleTimer();
                        })
                        .catch(error => {
                            console.error('Error accessing microphone:', error);
                            alert('Tidak dapat mengakses mikrofon. Sila periksa kebenaran mikrofon.');
                        });
                },

                resetQuizIdleTimer() {
                    if (this.quiz.idleTimer) clearTimeout(this.quiz.idleTimer);
                    this.quiz.idleTimer = setTimeout(() => {
                        if (this.quiz.recording) {
                            this.stopRecitation();
                        }
                    }, 5000); // 5 seconds of silence = finish
                },

                stopRecitation() {
                    if (this.quiz.idleTimer) clearTimeout(this.quiz.idleTimer);
                    this.quiz.recording = false;
                    
                    if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                        this.mediaRecorder.stop();
                    }

                    if (this.quiz.recitedText && this.quiz.recitedText.trim()) {
                        this.quiz.voiceStage = 'review';
                    } else {
                        this.quiz.voiceStage = 'idle';
                    }
                },

                async transcribeWithWhisper(audioBlob) {
                    try {
                        this.quiz.loading = true;
                        
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('model', 'whisper-large-v3-turbo');
                        formData.append('language', 'ar');
                        formData.append('response_format', 'json');
                        
                        const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer YOUR_OPENAI_API_KEY' // Replace with actual API key
                            },
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Whisper API request failed');
                        }
                        
                        const result = await response.json();
                        const seg = (result.text || '').trim();
                        this.quiz.detectedSegment = seg;
                        this.quiz.transcript = seg;

                        if (seg) {
                            this.quiz.recitedText = (this.quiz.recitedText ? (this.quiz.recitedText + ' ') : '') + seg;
                        }

                        this.quiz.voiceStage = 'review';
                        
                        const target = this.quiz.targetContinuationText || this.quiz.verse?.text || '';
                        const scoreObj = this.computeOrderedMatchScore(this.quiz.recitedText, target);
                        this.quiz.voiceProgress = Math.min(1, scoreObj.score);

                        const recitedLen = (this.quiz.recitedText || '').trim().length;
                        const targetLen = (target || '').trim().length;
                        const remaining = Math.max(0, targetLen - recitedLen);
                        const charHit = recitedLen >= 200;
                        const nearEnd = remaining > 0 && remaining <= 20;
                        this.quiz.voiceCompleted = !!(charHit || nearEnd || scoreObj.score >= 0.72);
                        
                    } catch (error) {
                        console.error('Whisper API Error:', error);
                        this.quiz.status = 'error';
                        this.quiz.feedback = 'Ralat transkripsi. Sila cuba lagi.';
                    } finally {
                        this.quiz.loading = false;
                    }
                },

                async analyzeWithTarteel(audioBlob) {
                    try {
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('reference_text', this.quiz.verse.text);
                        
                        const response = await fetch('https://api.tarteel.ai/v1/analyze', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer YOUR_TARTEEL_API_KEY', // Replace with actual API key
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                audio: await this.blobToBase64(audioBlob),
                                reference_text: this.quiz.verse.text,
                                analysis_type: 'recitation_errors'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Tarteel API request failed');
                        }
                        
                        const result = await response.json();
                        
                        // Process Tarteel analysis results
                        if (result.errors && result.errors.length > 0) {
                            this.quiz.feedback = `Ditemui ${result.errors.length} ralat bacaan. Sila perbaiki: ${result.errors.slice(0, 3).join(', ')}`;
                            this.quiz.status = 'warning';
                        } else {
                            this.quiz.feedback = 'Betul!';
                            this.quiz.status = 'success';
                            this.quiz.session.correct++;
                            this.activeProfile.totalXP += 5;
                        }
                        
                        this.save();
                        
                    } catch (error) {
                        console.error('Tarteel API Error:', error);
                        // Fallback to basic text comparison if Tarteel fails
                        this.checkQuizAnswer(this.quiz.transcript);
                    }
                },

                blobToBase64(blob) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                },

                checkQuizAnswer(userText) {
                    const target = (this.quiz.targetContinuationText || this.quiz.verse?.text || '').trim();
                    const scoreObj = this.computeOrderedMatchScore(userText, target);

                    if (scoreObj.score >= 0.72) {
                        this.quiz.status = 'success';
                        this.quiz.feedback = `Betul!`;
                        this.quiz.session.correct++;
                        this.activeProfile.totalXP += 10;
                        this.recordHafazanAttempt(true, scoreObj.score);
                        this.save();
                    } else {
                        this.quiz.status = 'error';
                        this.quiz.feedback = `Hampir tepat! Cuba sambung lagi sebelum semak.`;
                        this.quiz.session.wrong++;
                        this.recordHafazanAttempt(false, scoreObj.score);
                    }

                    this.$nextTick(() => lucide.createIcons());
                },

                syncTemplate() {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (confirm(`Kemaskini senarai amalan untuk ${p.name} kepada template ${p.mode} yang terbaru? (Amalan kustom anda tidak akan dipadam)`)) {
                        const templateList = JSON.parse(JSON.stringify(this.templates[p.mode].list));
                        
                        // Keep custom items (those starting with c_)
                        const customItems = p.ibadahList.filter(item => item.id.startsWith('c_'));
                        
                        // Replace standard items with template, then add back custom ones
                        p.ibadahList = [...templateList, ...customItems];
                        this.save();
                        alert('Senarai amalan telah dikemaskini!');
                        location.reload(); // Reload to refresh icons and UI
                    }
                },

                scrollToCurrentDay() {
                    const el = document.querySelector(`[data-day="${this.currentDay}"]`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                },

                saveGlobal() {
                    this.save();
                },

                save() {
                    localStorage.setItem('ramadan_rpg_data', JSON.stringify({
                        activeId: this.activeProfileId,
                        profiles: this.allProfiles,
                        darkMode: this.darkMode,
                        theme: this.theme,
                        lang: this.lang,
                        islamicQuoteIndex: this.islamicQuoteIndex,
                        islamicQuoteDateKey: this.islamicQuoteDateKey,
                        mushafFontSize: this.mushaf?.fontSize,
                        mushafFontFamily: this.mushaf?.fontFamily
                    }));
                }
            }
        }
    </script>
    </div>

    <!-- Enemy Attack Modal -->
    <div x-show="enemy.active" x-cloak class="fixed inset-0 z-[300] bg-black/30 backdrop-blur-[2px] flex items-center justify-center p-6">
        <div @click="handleEnemyResponse(false)" class="absolute inset-0 bg-black/10 backdrop-blur-[1px]"></div>
        <div class="bg-gradient-to-br from-white/95 to-red-50/90 dark:from-red-900/40 dark:to-slate-800/95 w-full max-w-xs rounded-[1rem] p-4 relative z-10 custom-shadow border border-red-500/30 shadow-2xl backdrop-blur-md">
            <div class="text-center mb-4">
                <!-- Icon with animation and glow -->
                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-xl ring-4 ring-red-500/20">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-white animate-pulse"></i>
                </div>
                
                <!-- Title with glow effect -->
                <h2 class="text-lg font-black text-red-600 dark:text-red-400 mb-1 drop-shadow-lg" x-text="interchangeWords(enemy.name || 'Musuh')"></h2>
                
                <!-- Subtitle with counter -->
                <div class="mb-3">
                    <p class="text-xs font-bold text-red-600 dark:text-red-300 mb-1 drop-shadow" x-text="interchangeWords('‚ö†Ô∏è Penyakit Hati')"></p>
                    <div class="flex items-center justify-center gap-2">
                        <span class="text-[10px] font-black text-red-500 bg-red-100/80 dark:bg-red-900/40 px-2 py-1 rounded-full backdrop-blur-sm" x-text="interchangeWords('1 / 4')"></span>
                        <span class="text-[10px] font-bold text-red-600 dark:text-red-300 drop-shadow" x-text="interchangeWords('Kesemua -100 XP')"></span>
                    </div>
                </div>
                
                <!-- Description -->
                <p class="text-xs text-muted mb-3 leading-relaxed" x-text="interchangeWords(enemy.description)"></p>
                
                <!-- Hadith Section with glass effect -->
                <div class="bg-gradient-to-r from-red-50/80 to-orange-50/80 dark:from-red-900/40 dark:to-orange-900/30 p-2 rounded-2xl mb-3 border border-red-200/50 backdrop-blur-sm">
                    <p class="text-[10px] font-bold text-red-700 dark:text-red-300 mb-1" x-text="interchangeWords('üìú Hadith:')"></p>
                    <p class="text-xs text-muted italic leading-relaxed" x-text="interchangeWords(enemy.hadith)"></p>
                </div>
                
                <!-- Warning Message with enhanced styling -->
                <div class="bg-gradient-to-r from-red-100/90 to-red-50/90 dark:from-red-900/50 dark:to-red-800/40 p-2 rounded-xl mb-3 border border-red-200/50 backdrop-blur-sm">
                    <p class="text-xs font-bold text-red-700 dark:text-red-300 text-center drop-shadow">
                        <span x-text="interchangeWords('‚ö†Ô∏è Anda akan kehilangan')"></span> <span x-text="enemy.xpToLose" class="font-black text-red-600 text-sm"></span> <span x-text="interchangeWords('XP!')"></span>
                    </p>
                </div>
                
                <!-- Action Buttons with enhanced effects -->
                <div class="flex gap-2 justify-center">
                    <button @click="handleEnemyResponse(true)" 
                        class="px-3 py-1 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-black hover:from-red-600 hover:to-red-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 backdrop-blur-sm text-xs">
                        <span x-text="interchangeWords('Ya, saya rasa ini')"></span>
                    </button>
                    <button @click="handleEnemyResponse(false)" 
                        class="px-3 py-1 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-black hover:from-green-600 hover:to-green-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 backdrop-blur-sm text-xs">
                        <span x-text="interchangeWords('Tidak, saya lawan')"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
