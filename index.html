<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Ibadah Tracker - BETA</title>
    
    <!-- BETA Version -->
    <meta name="version" content="beta-test">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ramadan Tracker">
    <meta name="theme-color" content="#8b5cf6">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2319/2319914.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        accent: 'var(--accent-color)',
                        main: 'var(--text-main)',
                        muted: 'var(--text-muted)',
                    }
                }
            }
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&family=Amiri:wght@400;700&family=Amiri+Quran&family=Scheherazade+New:wght@400;700&family=Lateef:wght@400;700&family=Harmattan:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s, color 0.3s; min-height: 100vh; }
        
        /* Layout Fix for Responsive Center */
        .app-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            position: relative;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
        }

        body {
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
        }
        
        .dark body {
            background-color: #020617;
        }

        /* Fixed Navigation Center Fix */
        .nav-fixed {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 418px; /* 450px - 32px padding */
            z-index: 50;
        }

        .quran-card {
            background: #FDFBF7;
            border-radius: 2rem;
            box-shadow: 0 10px 25px rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .quran-text {
            font-family: 'Amiri Quran', 'Amiri Quran', serif;
            direction: rtl;
            text-align: center;
            line-height: 2.2;
            font-size: var(--quran-font-size, 2.2rem);
        }
        
        /* Theme Variables */
        :root {
            --bg-main: #fcfcfc;
            --bg-card: #ffffff;
            --bg-inset: #f1f5f9;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --border-color: #f1f5f9;
            --accent-gradient: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            --accent-soft: #f0fdf4;
            --accent-color: #22c55e;
            --accent-shadow: rgba(34, 197, 94, 0.2);
        }

        .dark {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-inset: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent-soft: rgba(34, 197, 94, 0.1);
        }

        .theme-rose {
            --accent-gradient: linear-gradient(135deg, #fb7185 0%, #e11d48 100%);
            --accent-soft: #fff1f2;
            --accent-color: #e11d48;
            --accent-shadow: rgba(225, 29, 72, 0.2);
        }

        .theme-ocean {
            --accent-gradient: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
            --accent-soft: #f0f9ff;
            --accent-color: #0284c7;
            --accent-shadow: rgba(2, 132, 199, 0.2);
        }

        .theme-purple {
            --accent-gradient: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%);
            --accent-soft: #faf5ff;
            --accent-color: #7e22ce;
            --accent-shadow: rgba(126, 34, 206, 0.2);
        }

        .theme-pink {
            --accent-gradient: linear-gradient(135deg, #f472b6 0%, #db2777 100%);
            --accent-soft: #fdf2f8;
            --accent-color: #db2777;
            --accent-shadow: rgba(219, 39, 119, 0.2);
        }

        .theme-gold {
            --accent-gradient: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --accent-soft: #fffbeb;
            --accent-color: #d97706;
            --accent-shadow: rgba(217, 119, 6, 0.2);
        }

        .theme-navy {
            --accent-gradient: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            --accent-soft: #eff6ff;
            --accent-color: #8b5cf6;
            --accent-shadow: rgba(139, 92, 246, 0.2);
        }

        body { background-color: var(--bg-main); color: var(--text-main); }
        .bg-card { background-color: var(--bg-card); }
        .bg-inset { background-color: var(--bg-inset); }
        .text-main { color: var(--text-main); }
        .text-muted { color: var(--text-muted); }
        .border-theme { border-color: var(--border-color); }
        .gradient-accent { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .accent-soft { background: var(--accent-soft); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        .ring-accent { --tw-ring-color: var(--accent-color); }
        .shadow-accent { box-shadow: 0 10px 15px -3px var(--accent-shadow), 0 4px 6px -4px var(--accent-shadow); }

        .gradient-green { background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); }
        .gradient-yellow { background: linear-gradient(135deg, #facc15 0%, #eab308 100%); }
        .gradient-red { background: linear-gradient(135deg, #f87171 0%, #ef4444 100%); }
        .gradient-blue { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); }
        .gradient-purple { background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%); }
        .gradient-green-soft { background: var(--accent-soft); }
        .text-gradient { background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        [x-cloak] { display: none !important; }
        .custom-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .btn-active { background: var(--accent-gradient); color: white; transform: scale(1.02); box-shadow: 0 4px 12px var(--accent-shadow); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-active { color: var(--accent-color); }
        .nav-active i { transform: translateY(-4px); transition: transform 0.3s; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        /* Page Management Fixes */
        .app-container {
            height: 100vh;
            overflow: hidden;
        }
        
        .page-wrapper {
            position: relative;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .page-view {
            overflow-y: auto;
            padding: 1rem 1rem 10rem;
            width: 100%;
            height: 100%;
        }
        
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="antialiased" x-data="trackerApp()" x-init="init()" :class="{ 'dark': darkMode, 'theme-rose': theme === 'rose', 'theme-ocean': theme === 'ocean', 'theme-purple': theme === 'purple', 'theme-pink': theme === 'pink', 'theme-gold': theme === 'gold', 'theme-navy': theme === 'navy' }">
    
    <div class="app-container">
        <!-- Onboarding Screen -->
    <div x-show="view === 'onboarding'" x-cloak class="fixed inset-0 z-[100] bg-card overflow-y-auto px-6 py-12 max-w-[450px] mx-auto">
        <div class="max-w-md mx-auto">
            <div class="text-center mb-12">
                <div class="w-20 h-20 gradient-accent rounded-[2.5rem] flex items-center justify-center mx-auto mb-6 shadow-accent animate-float">
                    <i data-lucide="moon" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-3xl font-black text-main mb-2 tracking-tighter">Ramadan Journey</h1>
                <p class="text-muted font-medium">Mulakan pengembaraan ibadah anda</p>
                <div class="mt-4">
                    <span class="text-[8px] font-black px-3 py-1 rounded-full uppercase tracking-[0.3em] bg-slate-900 text-slate-100 border border-slate-700 shadow-sm">Beta Release</span>
                </div>
            </div>

            <div class="space-y-8">
                <div>
                    <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-3 ml-2">Nama Hero</label>
                    <input type="text" x-model="onboarding.name" placeholder="Contoh: Ayah / Ibu / Ahmad" 
                        class="w-full p-5 bg-inset rounded-[2rem] border-none focus:ring-4 ring-accent font-bold text-lg transition-all text-main focus:ring-opacity-20">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-3 ml-2">Pilih Tahap Cabaran</label>
                    <div class="grid grid-cols-1 gap-4">
                        <template x-for="(data, mode) in templates" :key="mode">
                            <button @click="onboarding.mode = mode" 
                                class="p-6 rounded-[2.5rem] border-4 text-left transition-all duration-300 relative overflow-hidden"
                                :class="onboarding.mode === mode ? 'border-accent accent-soft' : 'border-transparent bg-inset'">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-black text-xl uppercase tracking-tighter" 
                                        :class="onboarding.mode === mode ? 'text-accent' : 'text-muted'" x-text="modeLabel(mode)"></span>
                                    <i data-lucide="shield-check" class="w-6 h-6 text-accent" x-show="onboarding.mode === mode"></i>
                                </div>
                                <p class="text-xs font-medium text-muted leading-relaxed pr-8" x-text="data.description"></p>
                            </button>
                        </template>
                    </div>
                </div>

                <button @click="createProfile()" 
                    class="w-full py-6 gradient-accent text-white font-black text-lg rounded-[2.5rem] shadow-accent active:scale-95 transition-transform mt-4 flex items-center justify-center gap-3">
                    <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                    Mula Kumpul XP
                </button>
                
                <button x-show="allProfiles.length > 0" @click="view = 'profiles'" class="w-full py-4 text-muted font-bold text-sm">
                    Kembali ke Senarai Profil
                </button>

                <!-- Version Timestamp -->
                <div class="text-center mt-8">
                    <p class="text-[8px] font-black text-slate-300 uppercase tracking-[0.3em]">Last Updated: 2026-02-27 00:05</p>
                </div>
            </div>
        </div>
    </div>
 
    <!-- Page Wrapper for all main pages -->
    <div class="page-wrapper">
        <!-- Main Tracker Page -->
        <div id="view-tracker" x-show="view === 'tracker'" x-cloak class="page-view">
        <!-- Gamified Header -->
        <header class="flex justify-between items-start mb-4 relative">
            <div class="flex gap-4">
                <button @click="showUserMenu = !showUserMenu" class="relative group">
                    <div class="flex flex-col items-center">
                        <div class="w-14 h-14 gradient-purple rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg relative transition-transform group-active:scale-95" style="box-shadow: -5px -5px 22px rgba(168, 85, 247, 0.12), -5px -5px 10px rgba(168, 85, 247, 0.10);">
                            <span x-text="getUserLevel().level"></span>
                        </div>
                        <div class="-mt-0.1 bg-card px-1.5 py-0.5 rounded-full text-[7px] font-black text-purple-600 shadow-sm border border-purple-100/60 uppercase tracking-tighter">Level</div>
                    </div>
                </button>
                <div>
                    <h1 class="text-xl font-black text-main tracking-tighter flex items-center gap-2">
                        <span x-text="activeProfile?.name"></span>
                        <button @click="showUserMenu = !showUserMenu" class="p-1 rounded-lg hover:bg-inset transition-all">
                            <i data-lucide="chevron-down" class="w-4 h-4 text-muted"></i>
                        </button>
                    </h1>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-24 h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full gradient-purple transition-all duration-1000" :style="`width: ${getUserLevel().progress}%`"></div>
                        </div>
                        <span class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="`XP: ${activeProfile?.totalXP || 0}`"></span>
                    </div>
                    <!-- User Menu Dropdown -->
                    <div x-show="showUserMenu" @click.away="showUserMenu = false" x-transition 
                        class="absolute top-12 left-0 w-48 bg-card rounded-2xl shadow-xl border border-theme z-[100] p-2 mt-1">
                        <button @click="view = 'profiles'; showUserMenu = false" class="w-full text-left p-3 hover:bg-inset rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="users" class="w-4 h-4 text-accent"></i>
                            <span class="text-xs font-bold text-main">Tukar Akaun</span>
                        </button>
                        <button @click="view = 'onboarding'; showUserMenu = false" class="w-full text-left p-3 hover:bg-inset rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="user-plus" class="w-4 h-4 text-blue-500"></i>
                            <span class="text-xs font-bold text-main">Tambah Akaun</span>
                        </button>
                        <button @click="logout(); showUserMenu = false" class="w-full text-left p-3 hover:bg-red-50 text-red-500 rounded-xl transition-all flex items-center gap-3">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span class="text-xs font-bold">Log Keluar</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div class="bg-orange-50 dark:bg-orange-900/10 px-3 py-2 rounded-2xl flex items-center gap-2 border border-orange-100 dark:border-orange-900/30">
                    <i data-lucide="flame" class="w-4 h-4 text-orange-500 fill-current"></i>
                    <span class="text-xs font-black text-orange-600 dark:text-orange-400" x-text="`${calculateStreak()} Day Streak`"></span>
                </div>

                <button x-show="prayer.enabled && (prayer.placement === 'tracker' || prayer.placement === 'both')" @click="showPrayerModal = true" class="bg-orange-50 dark:bg-orange-900/10 px-3 py-2 rounded-2xl flex items-center gap-2 border border-orange-100/60 dark:border-orange-900/30 custom-shadow text-left w-full">
                    <i data-lucide="clock" class="w-4 h-4 text-orange-500"></i>
                    <div>
                        <p class="text-[10px] font-black text-main" x-text="prayer.nextLabel || (lang === 'en' ? 'Loading...' : 'Memuat...')"></p>
                        <p class="text-[9px] font-bold text-muted" x-show="prayer.countdown" x-text="prayer.countdown"></p>
                    </div>
                </button>
            </div>
        </header>

        <!-- Day Selector -->
        <div class="mb-2">
            <div class="flex justify-between items-center mb-2 px-2">
                <h3 class="text-[10px] font-black text-muted uppercase tracking-[0.2em]">Pilih Tarikh</h3>
                <button @click="showCalendar = !showCalendar" class="flex items-center gap-2 text-[10px] font-black text-accent uppercase tracking-widest bg-card px-3 py-1.5 rounded-full border border-theme shadow-sm">
                    <i :data-lucide="showCalendar ? 'list' : 'calendar'" class="w-3 h-3"></i>
                    <span x-text="showCalendar ? 'List View' : 'Calendar View'"></span>
                </button>
            </div>

            <!-- List View (Default) -->
            <div x-show="!showCalendar" x-transition:enter class="flex items-center bg-card rounded-[2rem] p-3 custom-shadow overflow-x-auto whitespace-nowrap gap-3 scrollbar-hide border border-theme">
                    <template x-for="day in 30" :key="day">
                    <button @click="currentDay = day" :data-day="day"
                        class="flex-shrink-0 w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-300 font-bold relative"
                        :class="[
                            currentDay === day ? 'gradient-accent text-white shadow-accent scale-110' : 'bg-inset text-muted',
                            isStreakDay(day) ? 'ring-2 ring-orange-300 ring-opacity-80' : ''
                        ]"
                        x-text="day">
                        <div x-show="$data.calculateTotal(day) >= 50" class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-white"></div>
                        <div x-show="isStreakDay(day)" class="absolute -bottom-1 -left-1 w-3 h-3 bg-orange-500 rounded-full border-2 border-white"></div>
                    </button>
                </template>
            </div>

            <!-- Calendar View -->
            <div x-show="showCalendar" x-transition:enter class="bg-card rounded-[2.5rem] p-6 custom-shadow border border-theme">
                <div class="grid grid-cols-7 gap-2">
                    <template x-for="dayName in ['I', 'S', 'R', 'K', 'J', 'S', 'A']">
                        <div class="text-[10px] font-black text-muted text-center py-2" x-text="dayName"></div>
                    </template>
                    <template x-for="day in 30" :key="day">
                        <button @click="currentDay = day; showCalendar = false" 
                            class="aspect-square rounded-xl flex flex-col items-center justify-center transition-all relative border p-1"
                            :class="[
                                currentDay === day ? 'border-accent ring-2 ring-accent ring-opacity-20' : 'border-transparent bg-inset',
                                calculateTotal(day) > 0 ? 'opacity-100' : 'opacity-60',
                                isStreakDay(day) ? 'ring-2 ring-orange-300 ring-opacity-70' : ''
                            ]">
                            <span class="text-[10px] font-black leading-none mb-1" :class="currentDay === day ? 'text-accent' : 'text-main'" x-text="day"></span>
                            
                            <!-- Percentage Text -->
                            <span class="text-[8px] font-black leading-none" :class="getDailyPct(day) > 0 ? (getDailyPct(day) >= 80 ? 'text-green-500' : (getDailyPct(day) >= 40 ? 'text-yellow-500' : 'text-red-500')) : 'text-muted/30'" x-text="`${getDailyPct(day)}%`"></span>
                            
                            <!-- Perfect Day Star -->
                            <div x-show="$data.calculateTotal(day) >= 50" class="absolute top-0.5 right-0.5">
                                <i data-lucide="star" class="w-2 h-2 text-yellow-400 fill-current"></i>
                            </div>

                            <div x-show="isStreakDay(day)" class="absolute bottom-0.5 left-0.5">
                                <i data-lucide="flame" class="w-2 h-2 text-orange-500 fill-current"></i>
                            </div>
                        </button>
                    </template>
                </div>
                <div class="mt-6 flex justify-center gap-4 text-[8px] font-black text-muted uppercase tracking-widest">
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-red"></div> Rendah</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-yellow"></div> Sederhana</div>
                    <div class="flex items-center gap-1.5"><div class="w-2 h-2 rounded-full gradient-green"></div> Tinggi</div>
                </div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="bg-card rounded-[2.5rem] p-8 custom-shadow mb-2 relative overflow-hidden border border-theme">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <span class="accent-soft text-accent text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest" x-text="`Ramadan Day ${currentDay}`"></span>
                    <div class="mt-2 text-[9px] font-bold text-muted uppercase tracking-widest" x-text="getMasihiDate(currentDay)"></div>
                    <h2 class="text-muted text-xs font-bold uppercase mt-4 tracking-tighter">Misi Harian</h2>
                </div>
                <div class="text-right">
                    <span class="text-5xl font-black text-gradient" x-text="`${getDailyPct(currentDay)}%`"></span>
                </div>
            </div>
            <div class="h-4 bg-inset rounded-full overflow-hidden mb-3">
                <div class="h-full transition-all duration-700 ease-out" 
                     :class="getProgressColor(calculateTotal(currentDay))"
                     :style="`width: ${getDailyPct(currentDay)}%`"></div>
            </div>
            <div class="flex justify-between text-[10px] font-bold text-muted uppercase">
                <span x-text="`${calculateTotal(currentDay)} / 50 Points`"></span>
                <span x-show="getDailyPct(currentDay) === 100" class="text-yellow-500 font-black flex items-center gap-1">
                    <i data-lucide="crown" class="w-3 h-3 fill-current"></i> Perfect Day!
                </span>
            </div>
        </div>

        <!-- Combo Bonus Notification -->
        <div x-show="checkFullSolatBonus()" x-transition class="bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 p-4 rounded-3xl mb-6 flex items-center gap-4">
            <div class="w-10 h-10 gradient-blue rounded-xl flex items-center justify-center shadow-lg shadow-blue-100">
                <i data-lucide="zap" class="w-5 h-5 text-white fill-current"></i>
            </div>
            <div>
                <p class="text-xs font-black text-blue-600 dark:text-blue-400 uppercase tracking-tighter">Full Solat Bonus Activated!</p>
                <p class="text-[10px] font-bold text-blue-400 dark:text-blue-500 uppercase tracking-widest">+50 Bonus XP Earned</p>
            </div>
        </div>

        <!-- Ibadah List -->
        <div class="grid grid-cols-1 gap-4">
            <template x-for="(item, index) in activeProfile?.ibadahList" :key="item.id">
                <div class="bg-card rounded-[2rem] p-5 custom-shadow transition-all border border-theme relative group" :class="getScore(item.id) > 0 ? 'ring-2 ring-accent ring-opacity-10' : ''">
                    <!-- Edit Mode Controls -->
                    <div x-show="editMode" class="absolute -top-2 -right-2 flex gap-2 z-10">
                        <button @click="const newName = prompt('Nama baru:', item.name); if(newName) item.name = newName; save();" 
                            class="w-8 h-8 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center">
                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                        </button>
                        <button @click="if(confirm('Padam misi ini?')) { activeProfile.ibadahList.splice(index, 1); save(); }" 
                            class="w-8 h-8 bg-red-500 text-white rounded-full shadow-lg flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-xl accent-soft">
                                <i :data-lucide="item.icon || 'star'" class="w-4 h-4 text-accent"></i>
                            </div>
                            <h3 class="font-bold text-sm text-main" x-text="item.name"></h3>
                        </div>
                        <span x-show="getScore(item.id) > 0" class="text-[9px] font-black text-accent accent-soft px-2 py-1 rounded-lg uppercase tracking-tighter" x-text="`Earned +${getScore(item.id)} XP`"></span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="option in item.options" :key="option.v">
                            <button @click="updateScore(item.id, option.v)"
                                class="flex-1 min-w-[70px] py-3 px-2 rounded-[1.2rem] text-[10px] font-black transition-all duration-300 border-2 flex flex-col items-center justify-center"
                                :class="getScore(item.id) === option.v ? 'btn-active border-transparent' : 'bg-inset border-transparent text-muted hover:border-accent hover:border-opacity-30'">
                                <span class="opacity-40 mb-0.5" x-text="`+${option.v}`"></span>
                                <span class="uppercase truncate w-full text-center px-1" x-text="option.l"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Add New Ibadah (Only in Edit Mode) -->
            <button x-show="editMode" @click="view = 'settings'; $nextTick(() => { document.querySelector('[x-model=\'newItem.name\']').scrollIntoView({behavior: 'smooth'}) })" 
                class="w-full py-8 border-4 border-dashed border-accent/20 rounded-[2rem] text-accent/40 font-black text-sm hover:border-accent hover:text-accent transition-all flex flex-col items-center justify-center gap-2">
                <i data-lucide="plus-circle" class="w-8 h-8"></i>
                Tambah Misi Baru
            </button>
        </div>

        <div class="mt-6">
            <button @click="editMode = !editMode" class="w-full py-4 rounded-[2rem] font-black text-[11px] uppercase tracking-widest transition-all flex items-center justify-center gap-3 border"
                :class="editMode ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-card text-muted border-theme'">
                <i :data-lucide="editMode ? 'check' : 'edit-3'" class="w-4 h-4"></i>
                <span x-text="editMode ? 'Selesai Edit' : 'Edit'"></span>
            </button>
        </div>
        </div>

        <!-- Mushaf Page (Combined with Quiz) -->
        <div id="view-mushaf" x-show="view === 'mushaf'" x-cloak class="page-view">
        <header class="mb-6">
            <h1 class="text-3xl font-black text-main tracking-tighter">Al-Quran</h1>
            <p class="text-muted font-medium text-xs">Mushaf & Ujian Hafazan</p>
        </header>

        <!-- Mode Selector -->
        <div class="flex p-1.5 bg-inset rounded-[2rem] mb-6 border border-theme custom-shadow">
            <button @click="quiz.active = false" 
                class="flex-1 py-3.5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.15em] transition-all duration-300 flex items-center justify-center gap-2"
                :class="!quiz.active ? 'bg-card text-accent shadow-sm border border-theme' : 'text-muted hover:text-main'">
                <i data-lucide="book-open" class="w-3.5 h-3.5"></i>
                Baca Biasa
            </button>
            <button @click="quiz.active = true; startQuiz()" 
                class="flex-1 py-3.5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.15em] transition-all duration-300 flex items-center justify-center gap-2"
                :class="quiz.active ? 'bg-card text-accent shadow-sm border border-theme' : 'text-muted hover:text-main'">
                <i data-lucide="mic-2" class="w-3.5 h-3.5"></i>
                Mode Ujian
            </button>
        </div>

        <!-- Selection Mode Toggle (Juz vs Surah vs Page) -->
        <div class="flex gap-2 mb-6">
            <button @click="mushaf.selectionMode = 'juz'; quiz.selectionMode = 'juz'; quiz.currentJuz = mushaf.currentJuz; mushaf.showSelector = true;" 
                class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                :class="mushaf.selectionMode === 'juz' ? 'bg-accent text-white shadow-accent' : 'bg-card text-muted border border-theme'">
                <i data-lucide="grid" class="w-3 h-3"></i>
                Juz <span x-text="mushaf.currentJuz"></span>
            </button>
            <button @click="mushaf.selectionMode = 'surah'; quiz.selectionMode = 'surah'; quiz.currentSurah = mushaf.currentSurah; mushaf.showSelector = true;" 
                class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                :class="mushaf.selectionMode === 'surah' ? 'bg-accent text-white shadow-accent' : 'bg-card text-muted border border-theme'">
                <i data-lucide="list" class="w-3 h-3"></i>
                <span x-text="mushaf.surahNamesMalay[mushaf.surahs.find(s => s.number === mushaf.currentSurah)?.englishName] || 'Surah'"></span>
            </button>
            <button @click="mushaf.selectionMode = 'page'; quiz.selectionMode = 'page'; quiz.currentPage = mushaf.currentPage; mushaf.showSelector = true;" 
                class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                :class="mushaf.selectionMode === 'page' ? 'bg-accent text-white shadow-accent' : 'bg-card text-muted border border-theme'">
                <i data-lucide="book" class="w-3 h-3"></i>
                Page <span x-text="mushaf.currentPage"></span>
            </button>
        </div>

        <!-- Selection Overlay -->
        <div x-show="mushaf.showSelector" x-cloak class="fixed inset-0 z-[100] flex items-end justify-center max-w-[450px] mx-auto">
            <div @click="mushaf.showSelector = false" class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
            <div class="bg-card w-full max-w-md rounded-t-[3rem] p-8 relative z-10 shadow-2xl border-t border-theme animate-slide-up max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-sm font-black text-main uppercase tracking-widest" x-text="`Pilih ${mushaf.selectionMode}`"></h3>
                    <button @click="mushaf.showSelector = false" class="p-2 text-muted hover:text-main">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Juz Selector (Grid Style) -->
                <div x-show="mushaf.selectionMode === 'juz'" class="grid grid-cols-5 gap-3">
                    <template x-for="j in 30" :key="j">
                        <button @click="mushaf.currentJuz = j; quiz.selectionMode = 'juz'; quiz.currentJuz = j; mushaf.currentPage = mushaf.juzPages[j]; fetchMushaf(); mushaf.showSelector = false;" 
                            class="aspect-square rounded-xl flex flex-col items-center justify-center transition-all border-2"
                            :class="mushaf.currentJuz === j ? 'border-accent bg-accent/5 text-accent' : 'border-transparent bg-inset text-muted'">
                            <span class="font-black text-xs" x-text="j"></span>
                            <span class="text-[7px] font-bold opacity-50" x-text="`P. ${mushaf.juzPages[j]}`"></span>
                        </button>
                    </template>
                </div>

                <!-- Surah Selector (Grid with Search) -->
                <div x-show="mushaf.selectionMode === 'surah'">
                    <div class="mb-4 relative">
                        <input type="text" x-model="mushaf.searchSurah" placeholder="Cari surah (e.g. Yasin)..." 
                            class="w-full p-4 bg-inset rounded-xl border-none text-[10px] font-bold text-main focus:ring-2 ring-accent ring-opacity-10 transition-all">
                        <i data-lucide="search" class="absolute right-4 top-3.5 w-4 h-4 text-muted"></i>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <template x-for="s in filteredSurahs" :key="s.number">
                            <button @click="mushaf.currentSurah = s.number; quiz.selectionMode = 'surah'; quiz.currentSurah = s.number; fetchMushaf(); mushaf.showSelector = false;" 
                                class="p-3 rounded-xl flex items-center gap-3 transition-all border-2 text-left"
                                :class="mushaf.currentSurah === s.number ? 'border-accent bg-accent/5' : 'border-transparent bg-inset'">
                                <span class="w-6 h-6 rounded-lg bg-white dark:bg-slate-800 flex items-center justify-center text-[8px] font-black text-accent" x-text="s.number"></span>
                                <div class="min-w-0">
                                    <p class="text-[9px] font-black text-main truncate uppercase" x-text="mushaf.surahNamesMalay[s.englishName] || s.englishName"></p>
                                    <p class="text-[8px] font-bold text-muted truncate" x-text="s.name"></p>
                                </div>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Page Selector (Grid Style) -->
                <div x-show="mushaf.selectionMode === 'page'" class="grid grid-cols-6 gap-2">
                    <template x-for="p in 604" :key="p">
                        <button @click="mushaf.currentPage = p; quiz.selectionMode = 'page'; quiz.currentPage = p; fetchMushaf(false); mushaf.showSelector = false;" 
                            class="aspect-square rounded-lg flex items-center justify-center text-[8px] font-black transition-all border"
                            :class="mushaf.currentPage === p ? 'border-accent bg-accent/5 text-accent' : 'border-transparent bg-inset text-muted/50'"
                            x-text="p"></button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Quiz Section (Overlay when active) -->
        <div x-show="quiz.active" x-transition class="mb-6 space-y-4">
            <div class="relative overflow-visible">
                <div x-show="quiz.loading" class="absolute inset-0 bg-card/80 backdrop-blur-sm flex items-center justify-center z-10">
                    <div class="w-8 h-8 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                </div>
                
                <div class="flex flex-wrap justify-between items-start mb-6 gap-3">
                    <div class="flex items-center gap-3 shrink-0">
                        <span class="h-10 min-w-10 flex items-center justify-center text-[10px] font-black text-green-600 bg-green-50 px-3 rounded-xl border border-green-100" x-text="`${quiz.session.correct}`"></span>
                        <span class="h-10 min-w-10 flex items-center justify-center text-[10px] font-black text-red-500 bg-red-50 px-3 rounded-xl border border-red-100" x-text="`${quiz.session.wrong}`"></span>
                    </div>
                    <div class="flex flex-wrap gap-2 items-start justify-end">
                        <div class="flex items-center gap-2">
                            <select x-model="mushaf.fontFamily" class="h-10 bg-inset border border-theme rounded-2xl px-3 text-[10px] font-black text-main">
                                <option>Amiri Quran</option>
                                <option>Amiri</option>
                                <option>Scheherazade New</option>
                                <option>Lateef</option>
                                <option>Harmattan</option>
                                <option>Noto Naskh Arabic</option>
                            </select>
                            <div class="h-10 flex items-center gap-3 bg-inset px-3 rounded-2xl border border-theme">
                                <button @click="mushaf.fontSize = Math.max(20, mushaf.fontSize - 4)" class="text-muted hover:text-accent"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <span class="text-[10px] font-black text-main" x-text="`${mushaf.fontSize}px`"></span>
                                <button @click="mushaf.fontSize = Math.min(60, mushaf.fontSize + 4)" class="text-muted hover:text-accent"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <!-- Mode Toggle -->
                        <div class="h-10 flex bg-inset p-1 rounded-xl border border-theme">
                            <button @click="quiz.testMode = 'voice'; startQuiz()" 
                                class="w-9 h-9 flex items-center justify-center rounded-lg transition-all" :class="quiz.testMode === 'voice' ? 'bg-accent text-white shadow-sm' : 'text-muted'">
                                <i data-lucide="mic" class="w-4 h-4"></i>
                            </button>
                            <button @click="quiz.testMode = 'mcq'; startQuiz()" 
                                class="w-9 h-9 flex items-center justify-center rounded-lg transition-all" :class="quiz.testMode === 'mcq' ? 'bg-accent text-white shadow-sm' : 'text-muted'">
                                <i data-lucide="list-checks" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <button @click="randomizeAyat()" 
                            class="w-10 h-10 flex items-center justify-center bg-purple-50 text-purple-600 rounded-xl hover:bg-purple-100 transition-colors" 
                            title="Randomize Ayat">
                            <i data-lucide="shuffle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="text-center py-4">
                    <p class="text-muted text-[9px] font-black uppercase tracking-widest mb-4" x-text="quiz.testMode === 'voice' ? 'Sila Baca & Sambung Ayat Ini:' : 'Pilih Sambungan Ayat Yang Betul:'"></p>
                    <div class="quran-card quran-text text-main font-bold mb-8 px-4 py-6 flex flex-wrap justify-center gap-x-2 gap-y-1" :style="`font-family: '${mushaf.fontFamily}', serif; --quran-font-size: ${Math.max(20, ((quiz.verse?.text || '').length > 200 ? mushaf.fontSize - 6 : mushaf.fontSize))}px;`" dir="rtl">
                        <template x-for="word in quiz.verse?.text.split(' ')" :key="word + Math.random()">
                            <span :class="quiz.matchedWords.includes(word.replace(/[\u064B-\u0652\u06D6-\u06ED]/g, '')) ? 'text-accent scale-110' : 'text-main'" 
                                  class="transition-all duration-300" x-text="word"></span>
                        </template>
                    </div>
                    
                    <!-- Voice Mode UI -->
                    <div x-show="quiz.testMode === 'voice'" class="flex flex-col items-center gap-6">
                        <div class="relative w-24 h-24">
                            <!-- Progress Ring -->
                            <svg class="w-full h-full -rotate-90">
                                <circle cx="48" cy="48" r="44" class="stroke-accent/10 fill-none" stroke-width="4"></circle>
                                <circle cx="48" cy="48" r="44" class="stroke-accent fill-none transition-all duration-500" 
                                    stroke-width="4" stroke-dasharray="276" :stroke-dashoffset="276 - (quiz.recording ? 276 : 0)" stroke-linecap="round"></circle>
                            </svg>
                            <button @click="toggleRecitation()"
                                class="absolute inset-2 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg"
                                :class="quiz.recording ? 'bg-red-500 shadow-red-200' : 'gradient-accent shadow-accent'">
                                <i :data-lucide="quiz.recording ? 'square' : 'mic'" class="w-8 h-8 text-white"></i>
                            </button>
                        </div>
                        
                        <div class="w-full space-y-2">
                            <p class="text-[9px] font-black uppercase tracking-widest" :class="quiz.recording ? 'text-red-500 animate-pulse' : 'text-muted'" 
                               x-text="quiz.recording ? 'Sila Teruskan Membaca...' : 'Klik Mic Untuk Mula'"></p>
                            
                            <div class="p-4 bg-inset/50 rounded-2xl border border-theme/50 space-y-3">
                                <div>
                                    <p class="text-[9px] font-black text-muted uppercase tracking-widest">Dikesan (segmen)</p>
                                    <p class="text-sm font-bold text-main font-arabic leading-relaxed text-center" dir="rtl" x-text="quiz.detectedSegment || '...' "></p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-black text-muted uppercase tracking-widest">Bacaan anda (terkumpul)</p>
                                    <p class="text-sm font-bold text-main font-arabic leading-relaxed text-center" dir="rtl" x-text="quiz.recitedText || '...' "></p>
                                </div>
                            </div>

                            <div x-show="quiz.voiceStage === 'review'" class="grid grid-cols-2 gap-2">
                                <button @click="quiz.voiceStage='recording'; startRecitation();" class="py-3 bg-card border border-theme rounded-xl text-[10px] font-black uppercase tracking-widest text-accent">Teruskan</button>
                                <button @click="checkQuizAnswer(quiz.recitedText);" class="py-3 gradient-accent text-white rounded-xl text-[10px] font-black uppercase tracking-widest">Semak</button>
                            </div>

                            <div x-show="quiz.voiceCompleted" class="p-3 bg-green-50 text-green-700 rounded-xl border border-green-200 text-[10px] font-black uppercase tracking-widest text-center">
                                Complete
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button @click="unlockHintWord()" class="py-3 bg-purple-50 text-purple-700 rounded-xl text-[10px] font-black uppercase tracking-widest">Unlock Hint</button>
                                <button @click="stopRecitation()" class="py-3 bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase tracking-widest">Selesai</button>
                            </div>

                            <div x-show="quiz.hintWordsUnlocked > 0" class="p-3 bg-card rounded-xl border border-theme">
                                <p class="text-[9px] font-black text-muted uppercase tracking-widest mb-2">Hint sambungan</p>
                                <p class="text-sm font-bold text-main font-arabic px-1 py-1 leading-relaxed" dir="rtl" x-text="(quiz.verse?.nextText || '').split(/\s+/).filter(Boolean).slice(0, quiz.hintWordsUnlocked).join(' ')"></p>
                            </div>
                        </div>
                    </div>

                    <!-- MCQ Mode UI -->
                    <div x-show="quiz.testMode === 'mcq'" class="space-y-3">
                        <div class="p-4 bg-inset/50 rounded-2xl border border-theme/50" x-show="quiz.mcqBuiltText">
                            <p class="text-[9px] font-black text-muted uppercase tracking-widest mb-2" x-text="`Fasa ${quiz.mcqPhase + 1}/3`"></p>
                            <p class="text-sm font-bold text-main font-arabic leading-relaxed text-center" dir="rtl" x-text="quiz.mcqBuiltText"></p>
                        </div>
                        <template x-for="(opt, idx) in quiz.mcqOptions" :key="idx">
                            <button @click="checkMcqAnswer(idx)" 
                                class="w-full p-5 bg-inset hover:bg-accent/5 rounded-[1.5rem] border-2 border-transparent transition-all text-right font-arabic text-lg font-bold text-main flex justify-between items-center group"
                                :class="quiz.status !== 'idle' ? (idx === quiz.mcqCorrectIndex ? 'border-green-500 bg-green-50' : (idx === quiz.selectedMcqIndex ? 'border-red-400 bg-red-50' : 'opacity-50')) : 'hover:border-accent'">
                                <span class="w-6 h-6 rounded-full border border-theme flex items-center justify-center text-[10px] font-black text-muted group-hover:border-accent group-hover:text-accent" x-text="['A', 'B'][idx]"></span>
                                <span dir="rtl" x-text="opt"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- Feedback -->
                <div x-show="quiz.status !== 'idle'" x-transition class="mt-6 pt-6 border-t border-theme text-center">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <i :data-lucide="quiz.status === 'success' ? 'check-circle' : 'alert-circle'" 
                           :class="quiz.status === 'success' ? 'text-green-500' : 'text-red-500'" class="w-5 h-5"></i>
                        <h4 class="font-black text-main text-sm uppercase tracking-widest" x-text="quiz.status === 'success' ? 'Masha Allah!' : 'Cuba Lagi'"></h4 >
                    </div>
                    <p class="text-[10px] font-medium text-muted mb-4" x-text="quiz.feedback"></p>
                    <div class="p-3 bg-inset rounded-xl mb-4">
                        <p class="text-sm font-bold text-main font-arabic" dir="rtl" x-text="quiz.transcript || '...'"></p>
                    </div>
                    <button @click="startQuiz()" class="w-full py-3 bg-inset text-accent font-black rounded-xl text-[10px] uppercase tracking-widest">Ayat Seterusnya</button>
                </div>
            </div>
        </div>

        <!-- Mushaf Layout Controls -->
        <div x-show="!quiz.active" x-transition class="flex flex-col gap-4 mb-4">
            <div class="flex items-center justify-between px-2">
                <div class="flex gap-2">
                    <button @click="mushaf.viewMode = 'list'" class="p-2 rounded-lg transition-all" :class="mushaf.viewMode === 'list' ? 'bg-accent text-white' : 'bg-card text-muted border border-theme'">
                        <i data-lucide="list" class="w-4 h-4"></i>
                    </button>
                    <button @click="mushaf.viewMode = 'page'" class="p-2 rounded-lg transition-all" :class="mushaf.viewMode === 'page' ? 'bg-accent text-white' : 'bg-card text-muted border border-theme'">
                        <i data-lucide="book-open" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <select x-model="mushaf.fontFamily" class="bg-card border border-theme rounded-2xl px-4 py-2 text-[10px] font-black text-main custom-shadow">
                        <option>Amiri Quran</option>
                        <option>Amiri</option>
                        <option>Scheherazade New</option>
                        <option>Lateef</option>
                        <option>Harmattan</option>
                        <option>Noto Naskh Arabic</option>
                    </select>
                    <div class="flex items-center gap-3 bg-card px-4 py-2 rounded-2xl border border-theme custom-shadow">
                        <button @click="mushaf.fontSize = Math.max(20, mushaf.fontSize - 4)" class="text-muted hover:text-accent"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        <span class="text-[10px] font-black text-main" x-text="`${mushaf.fontSize}px`"></span >
                        <button @click="mushaf.fontSize = Math.min(60, mushaf.fontSize + 4)" class="text-muted hover:text-accent"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mushaf Content -->
        <div x-show="!quiz.active" x-transition class="bg-card rounded-[3rem] p-8 custom-shadow border border-theme relative min-h-[400px]">
            <div x-show="mushaf.loading" class="absolute inset-0 bg-card/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-[3rem]">
                <div class="flex flex-col items-center gap-4">
                    <div class="w-10 h-10 border-4 border-accent border-t-transparent rounded-full animate-spin"></div>
                    <p class="text-[10px] font-black text-muted uppercase tracking-widest animate-pulse">Memuatkan Kalamullah...</p>
                </div>
            </div>

            <!-- Error State -->
            <div x-show="!mushaf.loading && mushaf.verses.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
                <i data-lucide="wifi-off" class="w-12 h-12 text-red-300 mb-4"></i>
                <p class="text-xs font-bold text-muted mb-6 uppercase tracking-widest leading-relaxed">Gagal memuatkan data.<br>Sila periksa sambungan internet anda.</p>
                <button @click="fetchMushaf()" class="px-6 py-3 bg-inset text-accent font-black rounded-xl text-[10px] uppercase tracking-widest hover:bg-accent hover:text-white transition-all">
                    Cuba Lagi
                </button>
            </div>

            <!-- List View -->
            <div class="space-y-12" x-show="!mushaf.loading && mushaf.verses.length > 0 && mushaf.viewMode === 'list'">
                <template x-for="v in mushaf.verses" :key="v.number">
                    <div class="text-right">
                        <p class="quran-text text-main font-bold mb-4" dir="rtl" 
                           x-text="v.text" :style="`font-family: '${mushaf.fontFamily}', serif; --quran-font-size: ${Math.max(20, mushaf.fontSize)}px;`"></p>
                        <div class="flex justify-between items-center border-t border-theme pt-3">
                            <span class="text-[8px] font-black text-accent bg-accent/10 px-2 py-1 rounded-md" x-text="v.surah?.name ? `${v.surah.name} : ${v.numberInSurah}` : `Ayat ${v.numberInSurah}`"></span>
                            <div class="w-6 h-6 rounded-full border border-theme flex items-center justify-center text-[10px] font-black text-muted" x-text="v.numberInSurah"></div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Page/Continuous View -->
            <div x-show="!mushaf.loading && mushaf.verses.length > 0 && mushaf.viewMode === 'page'" class="flex flex-col h-full">
                <div class="quran-card quran-text text-main font-bold px-4 py-8 shadow-inner flex-1" dir="rtl" :style="`font-family: '${mushaf.fontFamily}', serif; --quran-font-size: ${Math.max(20, (mushaf.verses.map(v=>v.text).join(' ').length > 200 ? mushaf.fontSize - 6 : mushaf.fontSize))}px;`">
                    <template x-for="v in paginatedVerses" :key="v.number">
                        <span class="inline">
                            <span :style="`font-family: '${mushaf.fontFamily}', serif;`" 
                                class="text-main font-bold hover:bg-accent/5 transition-colors cursor-pointer" x-text="v.text"></span>
                            <span class="inline-flex w-8 h-8 rounded-full border-2 border-accent/30 items-center justify-center text-[10px] font-black text-accent mx-2 align-middle shadow-sm bg-white dark:bg-slate-800" x-text="v.numberInSurah"></span>
                        </span>
                    </template>
                </div>

                <!-- Pagination Controls -->
                <div class="mt-8 flex items-center justify-between gap-4">
                    <button @click="if(mushaf.currentPage > 1) { mushaf.currentPage--; if(mushaf.selectionMode === 'page') { quiz.selectionMode = 'page'; quiz.currentPage = mushaf.currentPage; fetchMushaf(false); } }" 
                        class="p-4 bg-inset rounded-2xl text-muted hover:text-accent transition-all disabled:opacity-30" :disabled="mushaf.currentPage === 1">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    
                    <div class="flex flex-col items-center">
                        <div class="flex items-center gap-2 mb-1">
                            <input type="number" x-model.number="mushaf.currentPage" @change="mushaf.currentPage = Math.max(1, Math.min(mushaf.currentPage, totalMushafPages)); if(mushaf.selectionMode === 'page') { quiz.selectionMode = 'page'; quiz.currentPage = mushaf.currentPage; fetchMushaf(false); }"
                                class="w-12 p-2 bg-inset rounded-lg border-none text-center font-black text-xs text-accent">
                            <span class="text-[10px] font-black text-muted uppercase tracking-widest">/ <span x-text="totalMushafPages"></span></span>
                        </div>
                        <span class="text-[8px] font-bold text-muted uppercase tracking-[0.2em]">Halaman</span>
                    </div>

                    <button @click="if(mushaf.currentPage < totalMushafPages) { mushaf.currentPage++; if(mushaf.selectionMode === 'page') { quiz.selectionMode = 'page'; quiz.currentPage = mushaf.currentPage; fetchMushaf(false); } }" 
                        class="p-4 bg-inset rounded-2xl text-muted hover:text-accent transition-all disabled:opacity-30" :disabled="mushaf.currentPage === totalMushafPages">
                        <i data-lucide="chevron-right" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Mushaf Page Footer -->
                <div class="mt-8 pt-6 border-t border-[#e6d5b8] dark:border-[#3d301e] flex justify-between items-center opacity-40">
                    <span class="text-[10px] font-black uppercase tracking-widest text-accent" x-text="mushaf.selectionMode === 'juz' ? `Juz ${mushaf.currentJuz}` : mushaf.surahNamesMalay[mushaf.surahs.find(s => s.number === mushaf.currentSurah)?.englishName] || mushaf.surahs.find(s => s.number === mushaf.currentSurah)?.englishName"></span>
                    <div class="w-2 h-2 rounded-full bg-accent"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-accent">Ramadan Mushaf</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Page -->
    <div x-show="view === 'stats'" x-cloak class="page-view text-center">
        <header class="mb-12 text-left">
            <h1 class="text-3xl font-black text-main tracking-tighter">Achievement</h1>
            <p class="text-muted font-medium">Rekod kehebatan <span class="text-accent font-bold" x-text="activeProfile?.name"></span></p>
        </header>

            <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme">
                <div class="absolute -top-4 -right-4 opacity-5">
                    <i data-lucide="award" class="w-32 h-32 text-accent"></i>
                </div>
                <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Total Experience</h2>
                <div class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6" x-text="`Setakat ${getMasihiDate(currentDay)}`"></div>
                <div class="text-7xl font-black text-gradient mb-2" x-text="activeProfile?.totalXP || 0"></div>
                <p class="text-[10px] font-black text-accent opacity-60 uppercase tracking-widest mb-8">XP Points Collected</p>
            
            <div class="grid grid-cols-2 gap-8 pt-8 border-t border-theme">
                <div>
                    <p class="text-3xl font-black text-main" x-text="calculateStreak()"></p>
                    <p class="text-[10px] font-bold text-muted uppercase tracking-widest mt-1">Current Streak</p>
                </div>
                <div>
                    <p class="text-3xl font-black text-main" x-text="getBestDay()"></p>
                    <p class="text-[10px] font-bold text-muted uppercase tracking-widest mt-1">Best Score</p>
                </div>
            </div>
        </div>

        <div x-show="prayer.enabled && (prayer.placement === 'profil' || prayer.placement === 'both')" class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme text-left">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="clock" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]" x-text="lang === 'en' ? 'Prayer Times' : 'Waktu Solat'"></h2>
            <p class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6" x-text="lang === 'en' ? 'Tap for full list' : 'Tap untuk senarai penuh'"></p>

            <button @click="showPrayerModal = true" class="w-full p-5 bg-inset rounded-2xl border border-theme">
                <div class="flex items-center justify-between gap-4">
                    <div>
                        <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="lang === 'en' ? 'Next' : 'Seterusnya'"></p>
                        <p class="text-xl font-black text-main tracking-tighter" x-text="prayer.nextLabel || (lang === 'en' ? 'Loading...' : 'Memuat...')"></p>
                        <p class="text-[10px] font-bold text-muted" x-show="prayer.countdown" x-text="prayer.countdown"></p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-muted"></i>
                </div>
            </button>

            <div class="mt-5 grid grid-cols-2 gap-3">
                <template x-for="row in prayerRows().slice(0, 4)" :key="row.k">
                    <div class="p-4 bg-card rounded-2xl border border-theme">
                        <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="row.label"></p>
                        <p class="text-[12px] font-black text-main mt-1" x-text="row.time"></p>
                    </div>
                </template>
            </div>
        </div>

        <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme text-left">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="egg" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Companion</h2>
            <p class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6">Telur retro yang akan evolve ikut level</p>

            <template x-if="!activeProfile?.pet || !activeProfile.pet.line">
                <div class="space-y-4">
                    <p class="text-xs font-bold text-main">Pilih jenis telur:</p>
                    <div class="grid grid-cols-3 gap-3">
                        <button @click="choosePetLine('flame')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="flame" class="w-6 h-6 text-orange-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Flame</p>
                        </button>
                        <button @click="choosePetLine('ocean')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="droplets" class="w-6 h-6 text-sky-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Ocean</p>
                        </button>
                        <button @click="choosePetLine('forest')" class="p-4 rounded-2xl border border-theme bg-inset text-center">
                            <i data-lucide="leaf" class="w-6 h-6 text-emerald-500 mx-auto"></i>
                            <p class="text-[9px] font-black text-main uppercase tracking-widest mt-2">Forest</p>
                        </button>
                    </div>
                </div>
            </template>

            <template x-if="activeProfile?.pet && activeProfile.pet.line">
                <div>
                    <div class="flex items-center justify-between gap-6">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-3xl flex items-center justify-center text-white shadow-accent"
                                :class="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).bgClass">
                                <i :data-lucide="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).icon" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="`Line: ${activeProfile.pet.line}`"></p>
                                <p class="text-xl font-black text-main tracking-tighter" x-text="getPetMeta(activeProfile.pet.line, getPetStage(getUserLevel().level)).name"></p>
                                <p class="text-[10px] font-bold text-muted" x-text="activeProfile.pet.hatched ? 'Hatched' : 'Belum menetas'" :class="activeProfile.pet.hatched ? 'text-green-600' : 'text-orange-600'"></p>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-[9px] font-black text-muted uppercase tracking-widest">Stage</p>
                            <p class="text-3xl font-black text-accent" x-text="getPetStage(getUserLevel().level) + 1"></p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div class="flex justify-between text-[10px] font-black text-muted uppercase tracking-widest mb-2">
                            <span x-text="'Progress Evolusi'"></span>
                            <span x-text="petProgressLabel(getUserLevel().level)"></span>
                        </div>
                        <div class="h-3 bg-inset rounded-full overflow-hidden">
                            <div class="h-full gradient-accent transition-all duration-700" :style="`width: ${petProgressPct(getUserLevel().level)}%`"></div>
                        </div>
                    </div>

                    <div class="mt-6" x-show="!activeProfile.pet.hatched">
                        <button @click="hatchPet()" class="w-full py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border"
                            :class="canHatchPet() ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'"
                            :disabled="!canHatchPet()">
                            <span x-text="canHatchPet() ? 'Hatch Sekarang' : 'Capai LVL 3 untuk hatch'"></span>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="book-open" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Quran Khatam Journey</h2>
            <div class="flex justify-between items-end mb-6">
                <div class="text-left">
                    <span class="text-5xl font-black text-gradient" x-text="calculateTotalJuz()"></span>
                    <span class="text-muted font-black text-xs uppercase ml-1">/ 30 Juz</span>
                </div>
                <div class="text-right">
                    <span class="text-xl font-black text-accent" x-text="`${Math.round((calculateTotalJuz() / 30) * 100)}%`"></span>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="h-3 bg-inset rounded-full overflow-hidden mb-8">
                <div class="h-full gradient-accent transition-all duration-1000" :style="`width: ${(calculateTotalJuz() / 30) * 100}%`"></div>
            </div>

            <!-- Juzu' Grid -->
            <div class="grid grid-cols-10 gap-1.5">
                <template x-for="j in 30" :key="j">
                    <div class="aspect-square rounded-md flex items-center justify-center text-[8px] font-black transition-all duration-500"
                         :class="calculateTotalJuz() >= j ? 'gradient-accent text-white shadow-sm scale-105' : 'bg-inset text-muted/30'"
                         x-text="j">
                    </div>
                </template>
            </div>
            <p class="text-[8px] font-bold text-muted uppercase tracking-[0.2em] mt-6 text-center">
                <i data-lucide="info" class="w-3 h-3 inline-block mr-1 -mt-0.5 opacity-50"></i>
                Setiap juzu' akan 'unlocked' secara automatik mengikut rekod bacaan harian anda.
            </p>
        </div>

        <div class="bg-card rounded-[3rem] p-10 custom-shadow mb-8 relative overflow-hidden border border-theme">
            <div class="absolute -top-4 -right-4 opacity-5">
                <i data-lucide="brain" class="w-32 h-32 text-accent"></i>
            </div>
            <h2 class="text-muted text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Hafazan Tracker</h2>
            <p class="text-[9px] font-bold text-muted uppercase tracking-widest mb-6">Heatmap ikut Juzu' (tap untuk detail)</p>

            <div class="grid grid-cols-10 gap-1.5">
                <template x-for="j in 30" :key="j">
                    <button @click="selectedHafazanJuz = j" class="aspect-square rounded-md flex items-center justify-center text-[8px] font-black transition-all duration-300"
                            :class="hafazanBoxClass(hafazanStatsForJuz(j).avg)"
                            x-text="j">
                    </button>
                </template>
            </div>

            <div class="mt-6 grid grid-cols-2 gap-3 text-left">
                <div class="p-4 bg-inset rounded-2xl border border-theme">
                    <p class="text-[9px] font-black text-muted uppercase tracking-widest">Cara Kiraan</p>
                    <p class="text-[10px] font-bold text-muted mt-2">Purata % score dari ujian hafazan (voice/mcq) yang anda buat dalam Juz tersebut.</p>
                </div>
                <div class="p-4 bg-inset rounded-2xl border border-theme">
                    <p class="text-[9px] font-black text-muted uppercase tracking-widest">Tip</p>
                    <p class="text-[10px] font-bold text-muted mt-2">Buat ujian pada selection mode Juz untuk data paling kemas.</p>
                </div>
            </div>
        </div>

        <!-- Badge Showcase -->
        <div class="mb-10 px-2">
            <h3 class="font-black text-main uppercase text-xs tracking-widest text-left ml-2 mb-6 flex items-center gap-2">
                <i data-lucide="award" class="w-4 h-4 text-yellow-500"></i>
                Koleksi Badge
            </h3>
            <div class="grid grid-cols-4 gap-3">
                <template x-for="badge in badgeDefinitions" :key="badge.id">
                    <button @click="selectedBadge = badge" class="flex flex-col items-center gap-2 transition-transform active:scale-90">
                        <div class="w-16 h-16 rounded-[1.5rem] flex items-center justify-center transition-all duration-500 relative group"
                             :class="hasBadge(badge.id) ? badge.colorClass : 'bg-slate-100 dark:bg-slate-800 grayscale opacity-40'">
                            <i :data-lucide="badge.icon" class="w-8 h-8 text-white"></i>
                        </div>
                        <span class="text-[8px] font-black text-muted uppercase tracking-tighter text-center leading-tight" x-text="badge.name"></span>
                    </button>
                </template>
            </div>
        </div>

        <div class="space-y-4 text-left px-2">
            <h3 class="font-black text-main uppercase text-xs tracking-widest ml-2">Prestasi Mengikut Fasa</h3>
            <div class="grid grid-cols-1 gap-3">
                <template x-for="part in [1, 2, 3]" :key="part">
                    <div class="bg-card p-6 rounded-[2.5rem] custom-shadow flex items-center justify-between border border-theme">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-inset flex items-center justify-center font-black text-accent" x-text="part"></div>
                            <div>
                                <p class="text-xs font-black text-main uppercase tracking-tighter" x-text="part === 1 ? 'Fasa Rahmat' : (part === 2 ? 'Fasa Maghfirah' : 'Fasa Pembebasan')"></p>
                                <p class="text-[9px] font-bold text-muted uppercase" x-text="`Day ${part*10-9} to ${part*10}`"></p>
                            </div>
                        </div>
                        <p class="text-2xl font-black text-accent" x-text="`${calculatePartAverage(part)}%`"></p>
                    </div>
                </template>
            </div>
        </div>

        <div class="mt-10 bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme text-left">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <p class="text-[9px] font-black text-muted uppercase tracking-[0.2em]" x-text="lang === 'en' ? 'Daily Reminder' : 'Peringatan Harian'"></p>
                    <h2 class="text-lg font-black text-main tracking-tighter" x-text="lang === 'en' ? 'Islamic Quote' : 'Quote Islam'"></h2>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="copyIslamicQuote()" class="px-3 py-2 rounded-2xl bg-inset border border-theme text-[9px] font-black uppercase tracking-widest text-muted hover:text-accent transition-all flex items-center gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        <span x-text="lang === 'en' ? 'Copy' : 'Salin'"></span>
                    </button>
                    <button @click="randomizeIslamicQuote(true)" class="px-3 py-2 rounded-2xl bg-inset border border-theme text-[9px] font-black uppercase tracking-widest text-muted hover:text-accent transition-all flex items-center gap-2">
                        <i data-lucide="shuffle" class="w-4 h-4"></i>
                        <span x-text="lang === 'en' ? 'Random' : 'Rawak'"></span>
                    </button>
                </div>
            </div>

            <div class="p-5 bg-inset rounded-2xl border border-theme">
                <p class="text-sm font-bold text-main leading-relaxed" x-text="getIslamicQuote().text"></p>
                <div class="mt-4 pt-4 border-t border-theme">
                    <p class="text-[9px] font-black text-muted uppercase tracking-widest" x-text="getIslamicQuote().source"></p>
                    <p class="text-[10px] font-bold text-muted" x-text="getIslamicQuote().ref"></p>
                </div>
                <p class="text-[9px] font-black text-accent mt-4" x-show="quoteCopyStatus" x-text="quoteCopyStatus"></p>
            </div>
        </div>
    </div>

    <!-- Profile Selection Screen -->
    <div x-show="view === 'profiles'" x-cloak class="page-view">
        <header class="mb-12">
            <h1 class="text-3xl font-black text-main tracking-tighter">Arena Keluarga</h1>
            <p class="text-muted font-medium">Pilih karakter untuk teruskan misi</p>
        </header>

        <div class="grid grid-cols-1 gap-4 mb-12">
            <template x-for="p in allProfiles" :key="p.id">
                <button @click="switchProfile(p.id)" 
                    class="p-6 rounded-[2.5rem] bg-card border border-theme custom-shadow flex items-center justify-between transition-all relative overflow-hidden"
                    :class="activeProfileId === p.id ? 'ring-4 ring-accent ring-opacity-30 scale-[1.02]' : 'opacity-70'">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-3xl flex items-center justify-center font-black text-2xl text-white uppercase shadow-accent"
                             :class="activeProfileId === p.id ? 'gradient-accent' : 'bg-slate-200 dark:bg-slate-700'" x-text="p.name[0]"></div>
                        <div class="text-left">
                            <p class="font-black text-xl text-main tracking-tighter" x-text="p.name"></p>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-black text-white gradient-accent px-2.5 py-1 rounded-full uppercase shadow-sm border border-white/10" x-text="`LVL ${Math.floor((p.totalXP || 0) / 500) + 1}`"></span>
                                <span class="text-[9px] font-bold text-muted uppercase tracking-widest" x-text="modeLabel(p.mode)"></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-black text-accent tracking-tighter" x-text="p.totalXP || 0"></p>
                        <p class="text-[9px] font-bold text-muted uppercase tracking-widest">Total XP</p>
                    </div>
                </button>
            </template>
        </div>

        <button @click="view = 'onboarding'" 
            class="w-full py-6 border-4 border-dashed border-slate-100 dark:border-slate-800 rounded-[2.5rem] text-slate-300 dark:text-slate-700 font-black text-lg hover:border-accent hover:text-accent transition-all flex items-center justify-center gap-3">
            <i data-lucide="user-plus" class="w-6 h-6"></i>
            Tambah Ahli Baru
        </button>
    </div>

    <!-- Config Page -->
    <div x-show="view === 'settings'" x-cloak class="page-view">
        <header class="mb-12">
            <h1 class="text-3xl font-black text-main tracking-tighter">Tetapan</h1>
            <p class="text-muted font-medium">Urus ibadah & profil anda</p>
        </header>

        <div class="space-y-6">
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="clock" class="w-5 h-5 text-accent"></i>
                    <span x-text="lang === 'en' ? 'Prayer Times' : 'Waktu Solat'"></span>
                </h2>

                <div class="space-y-5">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-main" x-text="lang === 'en' ? 'Enable' : 'Aktifkan'"></span>
                        <button @click="prayer.enabled = !prayer.enabled; if(prayer.enabled) ensurePrayerTimes(); save();" 
                                class="w-12 h-6 rounded-full transition-colors relative"
                                :class="prayer.enabled ? 'gradient-accent' : 'bg-slate-200 dark:bg-slate-700'">
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"
                                 :class="prayer.enabled ? 'translate-x-6' : ''"></div>
                        </button>
                    </div>

                    <div>
                        <span class="text-[10px] font-black text-muted uppercase tracking-widest block mb-3" x-text="lang === 'en' ? 'Placement' : 'Lokasi Paparan'"></span>
                        <select x-model="prayer.placement" @change="save();" class="w-full p-4 bg-inset rounded-2xl border border-theme text-[10px] font-black text-main">
                            <option value="tracker" x-text="lang === 'en' ? 'Tracker' : 'Tracker'"></option>
                            <option value="profil" x-text="lang === 'en' ? 'Profile (Profil)' : 'Profil'"></option>
                            <option value="both" x-text="lang === 'en' ? 'Both' : 'Dua-dua'"></option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-[10px] font-black text-muted uppercase tracking-widest block mb-1" x-text="lang === 'en' ? 'Zone' : 'Zon'"></span>
                            <span class="text-sm font-bold text-main" x-text="prayer.zone === 'detecting' ? (lang === 'en' ? 'Detecting...' : 'Mengesan...') : prayer.zone"></span>
                        </div>
                        <button @click="prayer.zone = 'detecting'; detectAndSetZone().then(() => ensurePrayerTimes());" 
                                class="px-4 py-2 bg-inset rounded-xl font-black text-[10px] uppercase tracking-widest border border-theme hover:bg-accent hover:text-white transition-all"
                                x-text="lang === 'en' ? 'Refresh' : 'Segar'">
                        </button>
                    </div>

                    <p class="text-[10px] font-bold text-muted" x-text="lang === 'en' ? 'Uses your GPS location. Tap the card to view today\'s full list.' : 'Guna lokasi GPS. Tap kad untuk lihat senarai penuh hari ini.'"></p>
                </div>
            </div>

            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="languages" class="w-5 h-5 text-accent"></i>
                    Bahasa
                </h2>
                <div class="flex gap-3">
                    <button @click="lang = 'ms'; save();" class="flex-1 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border transition-all"
                        :class="lang === 'ms' ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'">BM</button>
                    <button @click="lang = 'en'; save();" class="flex-1 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest border transition-all"
                        :class="lang === 'en' ? 'gradient-accent text-white border-transparent shadow-accent' : 'bg-inset text-muted border-theme'">EN</button>
                </div>
            </div>
            <!-- Theme Settings -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="palette" class="w-5 h-5 text-accent"></i>
                    Penampilan
                </h2>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-main">Dark Mode</span>
                        <button @click="darkMode = !darkMode" 
                                class="w-12 h-6 rounded-full transition-colors relative"
                                :class="darkMode ? 'gradient-accent' : 'bg-slate-200 dark:bg-slate-700'">
                            <div class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"
                                 :class="darkMode ? 'translate-x-6' : ''"></div>
                        </button>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-muted uppercase tracking-widest block mb-3">Warna Tema</span>
                        <div class="flex flex-wrap gap-4">
                            <button @click="theme = 'emerald'" class="w-10 h-10 rounded-full bg-emerald-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'emerald' ? 'ring-emerald-200 scale-110' : ''"></button>
                            <button @click="theme = 'navy'" class="w-10 h-10 rounded-full bg-[#1e3a8a] ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'navy' ? 'ring-blue-200 scale-110' : ''"></button>
                            <button @click="theme = 'rose'" class="w-10 h-10 rounded-full bg-rose-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'rose' ? 'ring-rose-200 scale-110' : ''"></button>
                            <button @click="theme = 'ocean'" class="w-10 h-10 rounded-full bg-sky-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'ocean' ? 'ring-sky-200 scale-110' : ''"></button>
                            <button @click="theme = 'purple'" class="w-10 h-10 rounded-full bg-purple-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'purple' ? 'ring-purple-200 scale-110' : ''"></button>
                            <button @click="theme = 'pink'" class="w-10 h-10 rounded-full bg-pink-500 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'pink' ? 'ring-pink-200 scale-110' : ''"></button>
                            <button @click="theme = 'gold'" class="w-10 h-10 rounded-full bg-amber-400 ring-4 ring-offset-2 ring-transparent transition-all" :class="theme === 'gold' ? 'ring-amber-200 scale-110' : ''"></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Actions -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest">Akaun</h2>
                <div class="space-y-3">
                    <button @click="view = 'profiles'" class="w-full py-5 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-accent hover:border-opacity-20">
                        <i data-lucide="users" class="w-5 h-5 text-accent"></i>
                        Tukar Akaun
                    </button>
                    <button @click="logout()" class="w-full py-5 bg-red-50 dark:bg-red-900/20 text-red-500 font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-red-200">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        Logout Hero
                    </button>
                </div>
            </div>

            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 flex items-center gap-2 uppercase text-xs tracking-widest">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-accent"></i>
                    Misi Kustom
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-2 ml-1">Nama Ibadah</label>
                        <input type="text" x-model="newItem.name" placeholder="Contoh: Selawat 100x" class="w-full p-5 bg-inset rounded-2xl border-none font-bold text-sm text-main focus:ring-2 ring-accent ring-opacity-20 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-bold text-muted uppercase tracking-[0.2em] mb-2 ml-1">Pilihan Skor & Deskripsi</label>
                        <div class="space-y-3">
                            <template x-for="(opt, index) in newItem.options" :key="index">
                                <div class="flex gap-2">
                                    <div class="w-20">
                                        <input type="number" x-model.number="opt.v" placeholder="XP" class="w-full p-4 bg-inset rounded-xl border-none text-xs font-black text-center text-accent">
                                    </div>
                                    <div class="flex-1">
                                        <input type="text" x-model="opt.l" placeholder="Deskripsi (Contoh: Ya / 2 Rakaat)" class="w-full p-4 bg-inset rounded-xl border-none text-xs font-bold text-main">
                                    </div>
                                    <button @click="newItem.options.splice(index, 1)" x-show="newItem.options.length > 1" class="p-2 text-red-400 hover:text-red-500 transition-colors">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                        <button @click="newItem.options.push({v: 1, l: ''})" class="mt-3 w-full py-3 border-2 border-dashed border-theme rounded-xl text-[10px] font-black text-muted hover:text-accent hover:border-accent transition-all flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Tambah Pilihan Skor
                        </button>
                    </div>

                    <button @click="addItem()" class="w-full py-5 gradient-accent text-white font-black rounded-2xl shadow-accent active:scale-95 transition-transform mt-4">Simpan Misi</button>
                </div>
            </div>

            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest flex justify-between items-center">
                    Senarai Misi Semasa
                    <button @click="syncTemplate()" class="text-[8px] bg-accent/10 text-accent px-2 py-1 rounded-md hover:bg-accent hover:text-white transition-all">
                        <i data-lucide="refresh-cw" class="w-2 h-2 inline-block mr-1"></i> Sync Template
                    </button>
                </h2>
                <div class="space-y-3 max-h-[300px] overflow-y-auto pr-2 scrollbar-hide">
                    <template x-for="(item, index) in activeProfile?.ibadahList" :key="item.id">
                        <div class="flex items-center justify-between p-4 bg-inset rounded-2xl">
                            <div>
                                <p class="font-black text-main text-sm" x-text="item.name"></p>
                                <p class="text-[9px] text-muted font-black uppercase tracking-widest" x-text="`${item.options.length - 1} Pilihan`"></p>
                            </div>
                            <button @click="removeItem(index)" class="p-2 text-red-300 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="deleteActiveProfile()" class="w-full py-5 bg-red-50 dark:bg-red-900/10 text-red-500 font-black rounded-[2rem] border-2 border-dashed border-red-100 dark:border-red-900/30">
                Padam Profil <span x-text="activeProfile?.name"></span>
            </button>

            <!-- Support & Credits -->
            <div class="bg-card rounded-[2.5rem] p-8 custom-shadow border border-theme mt-6">
                <h2 class="font-black text-main mb-6 uppercase text-xs tracking-widest flex items-center gap-2">
                    <i data-lucide="coffee" class="w-5 h-5 text-orange-400"></i>
                    Sokongan & Kredit
                </h2>
                <p class="text-[10px] font-bold text-muted uppercase tracking-widest leading-relaxed mb-6">
                    Dibina dengan  untuk manfaat ummah. Jika aplikasi ini membantu anda, anda boleh menyokong pembangun di sini:
                </p>
                <div class="space-y-3">
                    <a href="https://buymeacoffee.com/nikirfan" target="_blank" class="w-full py-5 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 font-black rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform border border-transparent hover:border-orange-200">
                        <i data-lucide="coffee" class="w-5 h-5"></i>
                        Buy Me a Coffee
                    </a>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="https://github.com/Nik-Irfan/Ramadan-Tracker" target="_blank" class="py-4 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-2 text-[10px] border border-transparent hover:border-theme">
                            <i data-lucide="github" class="w-4 h-4"></i>
                            GitHub
                        </a>
                        <a href="https://my.linkedin.com/in/nikirfan98" target="_blank" class="py-4 bg-slate-50 dark:bg-slate-800 text-main font-black rounded-2xl flex items-center justify-center gap-2 text-[10px] border border-transparent hover:border-theme">
                            <i data-lucide="linkedin" class="w-4 h-4"></i>
                            LinkedIn
                        </a>
                    </div>
                </div>
            </div>

            <!-- Version Timestamp -->
            <div class="text-center py-8">
                <p class="text-[8px] font-black text-slate-300 dark:text-slate-600 uppercase tracking-[0.3em]">Last Updated: 2026-02-27 02:35</p>
                <p class="text-[8px] font-bold text-slate-200 dark:text-slate-700 mt-1 uppercase tracking-widest">v2.4.5-quiz-pro</p>
            </div>
        </div>
    </div>

    <!-- Badge Description Modal -->
    <div x-show="selectedBadge" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="selectedBadge = null" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme animate-float">
            <div class="text-center">
                <div class="w-24 h-24 rounded-[2.5rem] flex items-center justify-center mx-auto mb-6"
                     :class="hasBadge(selectedBadge?.id) ? selectedBadge?.colorClass : 'bg-slate-100 dark:bg-slate-800 grayscale opacity-40'">
                    <i :data-lucide="selectedBadge?.icon" class="w-12 h-12 text-white"></i>
                </div>
                <h3 class="text-2xl font-black text-main mb-2 tracking-tighter" x-text="selectedBadge?.name"></h3>
                <div class="mb-6">
                    <template x-if="hasBadge(selectedBadge?.id)">
                        <span class="bg-green-100 text-green-600 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Unlocked</span>
                    </template>
                    <template x-if="!hasBadge(selectedBadge?.id)">
                        <span class="bg-slate-100 text-slate-400 text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-widest">Locked</span>
                    </template>
                </div>
                <p class="text-sm font-medium text-muted leading-relaxed mb-8" x-text="selectedBadge?.desc"></p>
                <button @click="selectedBadge = null" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent">Faham!</button>
            </div>
        </div>
    </div>

    <!-- Hafazan Juz Detail Modal -->
    <div x-show="selectedHafazanJuz" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="selectedHafazanJuz = null" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div class="text-left">
                    <p class="text-[9px] font-black text-muted uppercase tracking-[0.2em]">Hafazan Detail</p>
                    <h3 class="text-2xl font-black text-main tracking-tighter" x-text="`Juz ${selectedHafazanJuz}`"></h3>
                </div>
                <button @click="selectedHafazanJuz = null" class="p-2 rounded-xl bg-inset text-muted hover:text-red-500">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="p-4 bg-inset rounded-2xl border border-theme mb-4 text-left">
                <template x-if="hafazanStatsForJuz(selectedHafazanJuz).count === 0">
                    <p class="text-[10px] font-bold text-muted">Belum ada rekod ujian untuk Juz ini.</p>
                </template>
                <template x-if="hafazanStatsForJuz(selectedHafazanJuz).count > 0">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-main" x-text="`Purata: ${hafazanStatsForJuz(selectedHafazanJuz).avg}%`"></p>
                        <p class="text-[10px] font-bold text-muted" x-text="`Success Rate: ${hafazanStatsForJuz(selectedHafazanJuz).successRate}%`"></p>
                        <p class="text-[10px] font-bold text-muted" x-text="`Jumlah attempt: ${hafazanStatsForJuz(selectedHafazanJuz).count}`"></p>
                    </div>
                </template>
            </div>

            <div class="max-h-60 overflow-y-auto space-y-2 text-left">
                <template x-for="h in (activeProfile?.hafazanHistory || []).filter(x => x && x.juz === selectedHafazanJuz).slice(0, 30)" :key="h.ts">
                    <div class="p-3 rounded-2xl border border-theme flex items-center justify-between" :class="h.success ? 'bg-green-50' : 'bg-red-50'">
                        <div>
                            <p class="text-[9px] font-black uppercase tracking-widest" :class="h.success ? 'text-green-700' : 'text-red-700'" x-text="h.success ? 'Success' : 'Try Again'"></p>
                            <p class="text-[10px] font-bold text-muted" x-text="`${new Date(h.ts).toLocaleString()}`"></p>
                            <p class="text-[10px] font-bold text-muted" x-text="`Mode: ${h.mode}`"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xl font-black" :class="h.success ? 'text-green-700' : 'text-red-700'" x-text="`${h.score || 0}%`"></p>
                        </div>
                    </div>
                </template>
            </div>

            <button @click="selectedHafazanJuz = null" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent mt-6">Tutup</button>
        </div>
    </div>

    <div x-show="showPrayerModal" x-cloak class="absolute inset-0 z-[200] flex items-center justify-center p-6">
        <div @click="showPrayerModal = false" class="absolute inset-0 modal-backdrop"></div>
        <div class="bg-card w-full max-w-sm rounded-[3rem] p-8 relative z-10 custom-shadow border border-theme">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div class="text-left">
                    <p class="text-[9px] font-black text-muted uppercase tracking-[0.2em]" x-text="lang === 'en' ? 'Prayer Times' : 'Waktu Solat'"></p>
                    <h3 class="text-2xl font-black text-main tracking-tighter" x-text="getMasihiDate(currentDay)"></h3>
                </div>
                <button @click="showPrayerModal = false" class="p-2 rounded-xl bg-inset text-muted hover:text-red-500">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="space-y-2 text-left">
                <template x-if="!prayer.timings">
                    <div class="p-4 bg-inset rounded-2xl border border-theme">
                        <p class="text-[10px] font-bold text-muted" x-text="lang === 'en' ? 'Loading timings...' : 'Memuat waktu solat...'"></p>
                    </div>
                </template>
                <template x-if="prayer.timings">
                    <div class="space-y-2">
                        <template x-for="row in prayerRows()" :key="row.k">
                            <div class="p-4 bg-inset rounded-2xl border border-theme flex items-center justify-between">
                                <p class="text-[10px] font-black text-main" x-text="row.label"></p>
                                <p class="text-[10px] font-black text-accent" x-text="row.time"></p>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <button @click="showPrayerModal = false" class="w-full py-4 gradient-accent text-white font-black rounded-2xl shadow-accent mt-6" x-text="lang === 'en' ? 'Close' : 'Tutup'"></button>
        </div>
    </div>
    </div> <!-- Close page-wrapper -->

    <!-- Bottom Nav -->
    <nav x-show="view !== 'onboarding'" class="nav-fixed bg-card/90 backdrop-blur-2xl rounded-[3rem] p-4 custom-shadow flex justify-around items-center border border-theme">
        <button @click="view = 'tracker'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'tracker' ? 'nav-active' : 'text-muted'">
            <i data-lucide="list-checks" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_amalan')"></span>
        </button>
        <button @click="view = 'mushaf'; fetchMushaf()" class="flex flex-col items-center gap-1 transition-all" :class="view === 'mushaf' ? 'nav-active' : 'text-muted'">
            <i data-lucide="book-open" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_quran')"></span>
        </button>
        <button @click="view = 'stats'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'stats' ? 'nav-active' : 'text-muted'">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_karakter')"></span>
        </button>
        <button @click="view = 'profiles'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'profiles' ? 'nav-active' : 'text-muted'">
            <i data-lucide="swords" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_arena')"></span>
        </button>
        <button @click="view = 'settings'" class="flex flex-col items-center gap-1 transition-all" :class="view === 'settings' ? 'nav-active' : 'text-muted'">
            <i data-lucide="settings-2" class="w-5 h-5"></i>
            <span class="text-[8px] font-black uppercase tracking-tighter" x-text="t('nav_tetapan')"></span>
        </button>
    </nav>

    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }

        function trackerApp() {
            const templates = {
                'EASY': {
                    description: 'Mode untuk mula konsisten dengan mengutamakan amalan utama.',
                    list: [
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'2 Rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'< 20 min'}] },
                        { id: 'alkahfi_1', name: 'Al-Kahfi', icon: 'book-open', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'dhuha', name: 'Dhuha', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'2 Rakaat'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'< 20 min'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'< 20 min'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'< 20 min'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'< 20 min'}] },
                        { id: 'tarawih', name: 'Tarawih', icon: 'moon', options: [{v:0, l:'0'}, {v:1, l:'8 Rakaat'}] },
                        { id: 'witir', name: 'Witir', icon: 'star', options: [{v:0, l:'0'}, {v:1, l:'1 Rakaat'}, {v:3, l:'3 Rakaat'}] },
                        { id: 'quran_ms', name: 'Al-Quran (MS)', icon: 'book-open', options: [{v:0, l:'0'}, {v:1, l:'10 ms'}, {v:2, l:'20 ms'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0'}, {v:1, l:'50x'}, {v:2, l:'100x'}] },
                        { id: 'selawat', name: 'Selawat', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'50x'}, {v:2, l:'100x'}] },
                        { id: 'sedekah', name: 'Sedekah', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] }
                    ]
                },
                'NORMAL': {
                    description: 'Kombinasi seimbang antara fardu, sunat rawatib dan amalan harian.',
                    list: [
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'2 Rakaat'}, {v:4, l:'4 Rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'Awal Waktu'}] },
                        { id: 'dhuha', name: 'Dhuha', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'2 Rakaat'}, {v:4, l:'4 Rakaat'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'Awal Waktu'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'Awal Waktu'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'Awal Waktu'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0, l:'0'}, {v:1, l:'Berjemaah'}, {v:2, l:'Awal Waktu'}] },
                        { id: 'tarawih', name: 'Tarawih', icon: 'moon', options: [{v:0, l:'0'}, {v:8, l:'8 Rakaat'}, {v:20, l:'20 Rakaat'}] },
                        { id: 'witir', name: 'Witir', icon: 'star', options: [{v:0, l:'0'}, {v:1, l:'1 Rakaat'}, {v:3, l:'3 Rakaat'}] },
                        { id: 'quran', name: 'Al-Quran (Juz)', icon: 'book-open', options: [{v:0, l:'0'}, {v:1, l:'1 Juz'}, {v:2, l:'2 Juz'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0'}, {v:1, l:'100x'}, {v:2, l:'200x'}] },
                        { id: 'selawat', name: 'Selawat', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'100x'}, {v:2, l:'200x'}] },
                        { id: 'sedekah', name: 'Sedekah', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] }
                    ]
                },
                'HARD': {
                    description: 'Cabaran ibadah penuh merangkumi rawatib lengkap, zikir dan tadabbur Quran.',
                    list: [
                        { id: 'tahajud', name: 'Tahajud', icon: 'moon', options: [{v:0, l:'0'}, {v:4, l:'4 Rakaat'}, {v:8, l:'8 Rakaat'}] },
                        { id: 'sahur', name: 'Sahur', icon: 'utensils', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'sunat_subuh', name: 'Sunat Subuh', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'subuh', name: 'Subuh', icon: 'sunrise', options: [{v:0, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Awal Waktu'}] },
                        { id: 'dhuha', name: 'Dhuha', icon: 'sun', options: [{v:0, l:'0'}, {v:4, l:'4 Rakaat'}, {v:8, l:'8 Rakaat'}] },
                        { id: 'rawatib_zohor', name: 'Rawatib Zohor', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Qobliah'}, {v:4, l:'Lengkap'}] },
                        { id: 'zohor', name: 'Zohor', icon: 'sun', options: [{v:0, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Awal Waktu'}] },
                        { id: 'rawatib_asar', name: 'Rawatib Asar', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'asar', name: 'Asar', icon: 'cloud-sun', options: [{v:0, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Awal Waktu'}] },
                        { id: 'doa_iftar', name: 'Doa Sebelum Iftar', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'Ya'}] },
                        { id: 'rawatib_maghrib', name: 'Rawatib Maghrib', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'maghrib', name: 'Maghrib', icon: 'sunset', options: [{v:0, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Awal Waktu'}] },
                        { id: 'rawatib_isyak', name: 'Rawatib Isyak', icon: 'clock', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] },
                        { id: 'isyak', name: 'Isyak', icon: 'moon', options: [{v:0, l:'0'}, {v:2, l:'Berjemaah'}, {v:3, l:'Awal Waktu'}] },
                        { id: 'tarawih', name: 'Tarawih', icon: 'moon', options: [{v:0, l:'0'}, {v:8, l:'8 Rakaat'}, {v:20, l:'20 Rakaat'}] },
                        { id: 'witir', name: 'Witir', icon: 'star', options: [{v:0, l:'0'}, {v:1, l:'1 Rakaat'}, {v:3, l:'3 Rakaat'}] },
                        { id: 'quran', name: 'Al-Quran (Juz)', icon: 'book-open', options: [{v:0, l:'0'}, {v:1, l:'1 Juz'}, {v:2, l:'2 Juz'}, {v:4, l:'4 Juz'}] },
                        { id: 'istighfar', name: 'Istighfar', icon: 'message-circle', options: [{v:0, l:'0'}, {v:1, l:'100x'}, {v:2, l:'200x'}, {v:4, l:'500x'}] },
                        { id: 'selawat', name: 'Selawat', icon: 'heart', options: [{v:0, l:'0'}, {v:1, l:'100x'}, {v:2, l:'200x'}, {v:4, l:'500x'}] },
                        { id: 'sedekah', name: 'Sedekah Harian', icon: 'heart', options: [{v:0, l:'0'}, {v:2, l:'Ya'}] }
                    ]
                }
            };

            const badgeDefinitions = [
                { id: 'baitul_jannah', name: 'Baitul Jannah', icon: 'home', colorClass: 'gradient-green', desc: 'Lengkapkan sekurang-kurangnya 12 Rakaat Solat Sunat dalam sehari.' },
                { id: 'ramadan_rookie', name: 'Ramadan Rookie', icon: 'award', colorClass: 'gradient-blue', desc: 'Mula menjejak ibadah untuk hari pertama Ramadan.' },
                { id: 'fast_learner', name: 'Fast Learner', icon: 'zap', colorClass: 'gradient-purple', desc: 'Capai Level 5 dengan mengumpul XP melalui ibadah.' },
                { id: 'streak_starter', name: 'Streak Starter', icon: 'flame', colorClass: 'gradient-yellow', desc: 'Istiqamah beribadah selama 3 hari berturut-turut.' },
                { id: 'perfect_day', name: 'Perfect Day', icon: 'crown', colorClass: 'gradient-red', desc: 'Lengkapkan kesemua misi harian dengan skor 100%.' },
                { id: 'gold_hero', name: 'Gold Hero', icon: 'star', colorClass: 'gradient-yellow', desc: 'Kumpul jumlah keseluruhan sebanyak 5,000 XP.' },
                { id: 'silver_hero', name: 'Silver Hero', icon: 'star', colorClass: 'gradient-blue', desc: 'Kumpul jumlah keseluruhan sebanyak 2,500 XP.' },
                { id: 'bronze_hero', name: 'Bronze Hero', icon: 'star', colorClass: 'gradient-red', desc: 'Kumpul jumlah keseluruhan sebanyak 1,000 XP.' }
            ];

            return {
                view: 'onboarding',
                currentDay: 1,
                activeProfileId: null,
                allProfiles: [],
                lang: 'ms',
                showPrayerModal: false,
                prayer: {
                    enabled: false,
                    placement: 'both',
                    zone: 'detecting', // will auto-detect on first enable
                    cacheKey: '',
                    dateKey: '',
                    timings: null,
                    nextLabel: '',
                    countdown: ''
                },
                islamicQuoteIndex: 0,
                islamicQuoteDateKey: '',
                quoteCopyStatus: '',
                islamicQuotes: [
                    {
                        text: {
                            ms: 'Sesungguhnya dengan mengingati Allah hati menjadi tenang.',
                            en: 'Surely in the remembrance of Allah do hearts find comfort.'
                        },
                        source: 'Quran',
                        ref: 'Surah Ar-Ra\u2019d 13:28'
                    },
                    {
                        text: {
                            ms: 'Dan bersabarlah; sesungguhnya Allah bersama orang-orang yang sabar.',
                            en: 'And be patient. Indeed, Allah is with the patient.'
                        },
                        source: 'Quran',
                        ref: 'Surah Al-Anfal 8:46'
                    },
                    {
                        text: {
                            ms: 'Amalan yang paling dicintai Allah ialah amalan yang berterusan walaupun sedikit.',
                            en: 'The most beloved deeds to Allah are those that are consistent, even if small.'
                        },
                        source: 'Hadith (Sahih)',
                        ref: 'Sahih al-Bukhari & Sahih Muslim (meaning)'
                    },
                    {
                        text: {
                            ms: 'Sesiapa yang beriman kepada Allah dan Hari Akhirat, hendaklah dia berkata baik atau diam.',
                            en: 'Whoever believes in Allah and the Last Day should speak good or remain silent.'
                        },
                        source: 'Hadith (Sahih)',
                        ref: 'Sahih al-Bukhari & Sahih Muslim (meaning)'
                    },
                    {
                        text: {
                            ms: 'Wahai orang-orang yang beriman, bertakwalah kepada Allah dan lihatlah apa yang telah kamu sediakan untuk hari esok.',
                            en: 'O believers, be mindful of Allah and let every soul look to what it has sent forth for tomorrow.'
                        },
                        source: 'Quran',
                        ref: 'Surah Al-Hashr 59:18'
                    }
                ],
                templates: templates,
                badgeDefinitions: badgeDefinitions,
                onboarding: { name: '', mode: 'NORMAL' },
                newItem: { name: '', options: [{v: 0, l: 'Tiada'}, {v: 1, l: 'Ya'}] },
                darkMode: false,
                theme: 'theme-navy',
                selectedBadge: null,
                selectedHafazanJuz: null,
                showCalendar: false,
                editMode: false,
                showUserMenu: false,
                mushaf: {
                    loading: false,
                    selectionMode: 'page', // 'juz', 'surah', or 'page'
                    currentJuz: 1,
                    currentSurah: 1,
                    currentPage: 1,
                    verses: [],
                    surahs: [],
                    fontSize: 32,
                    fontFamily: 'Amiri Quran',
                    viewMode: 'page',
                    searchSurah: '',
                    showSelector: false,
                    juzPages: {
                        1: 1, 2: 22, 3: 42, 4: 62, 5: 82, 6: 102, 7: 122, 8: 142, 9: 162, 10: 182,
                        11: 202, 12: 222, 13: 242, 14: 262, 15: 282, 16: 302, 17: 322, 18: 342, 19: 362, 20: 382,
                        21: 402, 22: 422, 23: 442, 24: 462, 25: 482, 26: 502, 27: 522, 28: 542, 29: 562, 30: 582
                    },
                    surahNamesMalay: {
                        'Al-Faatiha': 'Al-Fatihah', 'Al-Baqara': 'Al-Baqarah', 'Aal-i-Imraan': 'Ali \'Imran', 'An-Nisaa': 'An-Nisa\'',
                        'Al-Maaida': 'Al-Ma\'idah', 'Al-An\'aam': 'Al-An\'am', 'Al-A\'raaf': 'Al-A\'raf', 'Al-Anfaal': 'Al-Anfal',
                        'At-Tawba': 'At-Taubah', 'Yunus': 'Yunus', 'Hud': 'Hud', 'Yusuf': 'Yusuf', 'Ar-Ra\'d': 'Ar-Ra\'d',
                        'Ibrahim': 'Ibrahim', 'Al-Hijr': 'Al-Hijr', 'An-Nahl': 'An-Nahl', 'Al-Israa': 'Al-Isra\'',
                        'Al-Kahf': 'Al-Kahf', 'Maryam': 'Maryam', 'Ta-Ha': 'Taha', 'Al-Anbiyaa': 'Al-Anbiya\'',
                        'Al-Hajj': 'Al-Hajj', 'Al-Mu\'minoon': 'Al-Mu\'minun', 'An-Noor': 'An-Nur', 'Al-Furqaan': 'Al-Furqan',
                        'Ash-Shu\'araa': 'Asy-Syu\'ara\'', 'An-Naml': 'An-Naml', 'Al-Qasas': 'Al-Qasas', 'Al-Ankaboot': 'Al-\'Ankabut',
                        'Ar-Room': 'Ar-Rum', 'Luqman': 'Luqman', 'As-Sajda': 'As-Sajdah', 'Al-Ahzaab': 'Al-Ahzab',
                        'Saba': 'Saba\'', 'Faatir': 'Fatir', 'Ya-Seen': 'Yasin', 'As-Saaffaat': 'As-Saffat', 'Saad': 'Sad',
                        'Az-Zumar': 'Az-Zumar', 'Ghafir': 'Ghafir', 'Fussilat': 'Fussilat', 'Ash-Shura': 'Asy-Syura',
                        'Az-Zukhruf': 'Az-Zukhruf', 'Ad-Dukhaan': 'Ad-Dukhan', 'Al-Jaathiya': 'Al-Jatsiyah', 'Al-Ahqaaf': 'Al-Ahqaf',
                        'Muhammad': 'Muhammad', 'Al-Fath': 'Al-Fath', 'Al-Hujuraat': 'Al-Hujurat', 'Qaaf': 'Qaf',
                        'Adh-Dhaariyat': 'Adz-Dzariyat', 'At-Toor': 'At-Tur', 'An-Najm': 'An-Najm', 'Al-Qamar': 'Al-Qamar',
                        'Ar-Rahmaan': 'Ar-Rahman', 'Al-Waaqi\'a': 'Al-Waqi\'ah', 'Al-Hadeed': 'Al-Hadid', 'Al-Mujaadila': 'Al-Mujadilah',
                        'Al-Hashr': 'Al-Hasyr', 'Al-Mumtahina': 'Al-Mumtahanah', 'As-Saff': 'As-Saff', 'Al-Jumu\'a': 'Al-Jumu\'ah',
                        'Al-Munaafiqoon': 'Al-Munafiqun', 'At-Taghaabun': 'At-Taghabun', 'At-Talaaq': 'At-Talaq', 'At-Tahreem': 'At-Tahrim',
                        'Al-Mulk': 'Al-Mulk', 'Al-Qalam': 'Al-Qalam', 'Al-Haaqqa': 'Al-Haqqah', 'Al-Ma\'aarij': 'Al-Ma\'arij',
                        'Nooh': 'Nuh', 'Al-Jinn': 'Al-Jinn', 'Al-Muzzammil': 'Al-Muzzammil', 'Al-Muddaththir': 'Al-Muddatsir',
                        'Al-Qiyaama': 'Al-Qiyamah', 'Al-Insaan': 'Al-Insan', 'Al-Mursalaat': 'Al-Mursalat', 'An-Naba': 'An-Naba\'',
                        'An-Naazi\'aat': 'An-Nazi\'at', 'Abasa': 'Abasa', 'At-Takweer': 'At-Takwir', 'Al-Infitaar': 'Al-Infitar',
                        'Al-Mutaffifeen': 'Al-Mutaffifin', 'Al-Inshiqaaq': 'Al-Insyiqaq', 'Al-Burooj': 'Al-Buruj', 'At-Taariq': 'At-Tariq',
                        'Al-A\'laa': 'Al-A\'la', 'Al-Gaashiya': 'Al-Ghasyiyah', 'Al-Fajr': 'Al-Fajr', 'Al-Balad': 'Al-Balad',
                        'Ash-Shams': 'Asy-Syams', 'Al-Layl': 'Al-Lail', 'Ad-Duhaa': 'Ad-Duha', 'Ash-Sharh': 'Asy-Syarh',
                        'At-Teen': 'At-Tin', 'Al-Alaq': 'Al-\'Alaq', 'Al-Qadr': 'Al-Qadr', 'Al-Bayyina': 'Al-Bayyinah',
                        'Az-Zalzala': 'Az-Zalzalah', 'Al-Aadiyaat': 'Al-\'Adiyat', 'Al-Qaari\'a': 'Al-Qari\'ah', 'At-Takaathur': 'At-Takatsur',
                        'Al-Asr': 'Al-\'Asr', 'Al-Humaza': 'Al-Humazah', 'Al-Feel': 'Al-Fil', 'Quraish': 'Quraisy',
                        'Al-Maa\'oon': 'Al-Ma\'un', 'Al-Kawthar': 'Al-Kautsar', 'Al-Kaafiroon': 'Al-Kafirun', 'An-Nasr': 'An-Nasr',
                        'Al-Masad': 'Al-Masad', 'Al-Ikhlaas': 'Al-Ikhlas', 'Al-Falaq': 'Al-Falaq', 'An-Naas': 'An-Nas'
                    }
                },
                quiz: {
                    active: false,
                    loading: false,
                    testMode: 'mcq',
                    selectionMode: 'juz',
                    currentJuz: 1,
                    currentSurah: 1,
                    currentPage: 1,
                    verse: null,
                    targetContinuationText: '',
                    recording: false,
                    transcript: '',
                    detectedSegment: '',
                    recitedText: '',
                    voiceStage: 'idle',
                    voiceProgress: 0,
                    voiceCompleted: false,
                    hintWordsUnlocked: 0,
                    status: 'idle',
                    feedback: '',
                    session: { correct: 0, wrong: 0, total: 0 },
                    matchedWords: [],
                    idleTimer: null,
                    mcqOptions: [],
                    mcqCorrectIndex: -1,
                    mcqPhase: 0,
                    mcqBuiltText: '',
                    mcqPhases: []
                },

                init() {
                    const saved = localStorage.getItem('ramadan_rpg_data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.allProfiles = data.profiles || [];
                        this.activeProfileId = data.activeId;
                        this.darkMode = data.darkMode || false;
                        this.theme = data.theme || 'emerald';
                        this.lang = data.lang || 'ms';
                        this.islamicQuoteIndex = Number.isFinite(data.islamicQuoteIndex) ? data.islamicQuoteIndex : 0;
                        this.islamicQuoteDateKey = data.islamicQuoteDateKey || '';
                        if (Number.isFinite(data.mushafFontSize)) {
                            this.mushaf.fontSize = Math.max(20, Math.min(60, Number(data.mushafFontSize)));
                        }
                        if (typeof data.mushafFontFamily === 'string' && data.mushafFontFamily.trim()) {
                            this.mushaf.fontFamily = data.mushafFontFamily;
                        }
                        if (data.prayer && typeof data.prayer === 'object') {
                            this.prayer.enabled = !!data.prayer.enabled;
                            this.prayer.placement = typeof data.prayer.placement === 'string' ? data.prayer.placement : 'both';
                            this.prayer.cacheKey = data.prayer.cacheKey || '';
                            this.prayer.dateKey = data.prayer.dateKey || '';
                            this.prayer.timings = data.prayer.timings || null;
                        }
                        this.prayer.method = Number.isFinite(data.prayer.method) ? data.prayer.method : 11;
                        this.prayer.cacheKey = data.prayer.cacheKey || '';
                        this.prayer.dateKey = data.prayer.dateKey || '';
                        this.prayer.timings = data.prayer.timings || null;
                    }
                    (this.allProfiles || []).forEach(p => this.ensurePet(p));

                    this.ensureDailyIslamicQuote();

                    this.$nextTick(() => {
                        setInterval(() => this.updateNextPrayer(), 30000);
                    });
                    
                    this.fetchSurahList();
                    this.startLocationTracking();
                    this.fetchMushaf(false);
                    
                    // Auto-sync Ramadan Date
                    // Ramadan 2026 starts around Feb 18
                    const ramadanStart = new Date('2026-02-18T00:00:00');
                    const today = new Date();
                    const diffTime = today.getTime() - ramadanStart.getTime();
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    if (diffDays >= 1 && diffDays <= 30) {
                        this.currentDay = diffDays;
                    }

                    this.$nextTick(() => {
                        lucide.createIcons();
                        this.scrollToCurrentDay();
                        // #region agent log
                        try {
                            const trackerEl = document.getElementById('view-tracker');
                            const mushafEl = document.getElementById('view-mushaf');
                            console.log('[DEBUG:init_nextTick]', {
                                view: this.view,
                                scrollY: window.scrollY,
                                innerHeight: window.innerHeight,
                                docHeight: document.documentElement.scrollHeight,
                                trackerTop: trackerEl ? trackerEl.getBoundingClientRect().top : null,
                                mushafTop: mushafEl ? mushafEl.getBoundingClientRect().top : null
                            });
                        } catch (e) {}
                        // #endregion
                    });
                    this.$watch('view', (newView, oldView) => this.$nextTick(() => {
                        lucide.createIcons();
                        // #region agent log
                        try {
                            const trackerEl = document.getElementById('view-tracker');
                            const mushafEl = document.getElementById('view-mushaf');
                            console.log('[DEBUG:view_watch]', {
                                oldView,
                                newView,
                                scrollY: window.scrollY,
                                innerHeight: window.innerHeight,
                                docHeight: document.documentElement.scrollHeight,
                                trackerTop: trackerEl ? trackerEl.getBoundingClientRect().top : null,
                                mushafTop: mushafEl ? mushafEl.getBoundingClientRect().top : null,
                                trackerInnerLength: trackerEl ? trackerEl.innerHTML.length : null,
                                hasActiveProfile: !!this.activeProfile,
                                ibadahCount: this.activeProfile?.ibadahList?.length ?? null
                            });
                        } catch (e) {}
                        // #endregion
                        // Always reset scroll position when switching "pages"
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        document.documentElement.scrollTop = 0;
                        document.body.scrollTop = 0;
                    }));
                    this.$watch('currentDay', () => this.$nextTick(() => { lucide.createIcons(); this.scrollToCurrentDay(); }));
                    this.$watch('darkMode', () => this.saveGlobal());
                    this.$watch('theme', () => this.saveGlobal());
                    this.$watch('lang', () => this.saveGlobal());
                    this.$watch('mushaf.fontSize', () => this.saveGlobal());
                    this.$watch('mushaf.fontFamily', () => this.saveGlobal());
                    this.$watch('prayer.enabled', () => { if (this.prayer.enabled) this.ensurePrayerTimes(); this.saveGlobal(); });
                    this.$watch('prayer.placement', () => this.saveGlobal());
                    this.$watch('selectedBadge', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('selectedHafazanJuz', () => this.$nextTick(() => lucide.createIcons()));

                    // Run Self-Tests on startup
                    this.runTests();
                },

                get activeProfile() {
                    return this.allProfiles.find(p => p.id === this.activeProfileId);
                },

                randomizeIslamicQuote(persistForToday = false) {
                    const len = (this.islamicQuotes || []).length;
                    if (!len) {
                        this.islamicQuoteIndex = 0;
                        return;
                    }
                    this.islamicQuoteIndex = Math.floor(Math.random() * len);
                    if (persistForToday) {
                        this.islamicQuoteDateKey = this.getTodayKey();
                        this.save();
                    }
                    this.$nextTick(() => lucide.createIcons());
                },

                getTodayKey() {
                    const d = new Date();
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                },

                ensureDailyIslamicQuote() {
                    const today = this.getTodayKey();
                    const len = (this.islamicQuotes || []).length;
                    if (!len) {
                        this.islamicQuoteDateKey = today;
                        this.islamicQuoteIndex = 0;
                        return;
                    }
                    if (this.islamicQuoteDateKey !== today || !Number.isFinite(this.islamicQuoteIndex) || this.islamicQuoteIndex < 0 || this.islamicQuoteIndex >= len) {
                        this.islamicQuoteIndex = Math.floor(Math.random() * len);
                        this.islamicQuoteDateKey = today;
                        this.save();
                    }
                    this.$nextTick(() => lucide.createIcons());
                },

                async copyIslamicQuote() {
                    const q = this.getIslamicQuote();
                    const text = `${q.text}\n\n${q.source}\n${q.ref}`.trim();
                    const setStatus = (msg) => {
                        this.quoteCopyStatus = msg;
                        setTimeout(() => { this.quoteCopyStatus = ''; }, 1400);
                    };
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(text);
                            setStatus(this.lang === 'en' ? 'Copied!' : 'Disalin!');
                            return;
                        }
                    } catch (e) {}

                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.setAttribute('readonly', '');
                        ta.style.position = 'fixed';
                        ta.style.left = '-9999px';
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        setStatus(this.lang === 'en' ? 'Copied!' : 'Disalin!');
                    } catch (e) {
                        setStatus(this.lang === 'en' ? 'Copy failed' : 'Gagal salin');
                    }
                },

                getIslamicQuote() {
                    const q = (this.islamicQuotes || [])[this.islamicQuoteIndex] || (this.islamicQuotes || [])[0] || null;
                    if (!q) return { text: '', source: '', ref: '' };
                    const textObj = q.text || {};
                    const text = (this.lang === 'en' ? (textObj.en || textObj.ms) : (textObj.ms || textObj.en)) || '';
                    return { text, source: q.source || '', ref: q.ref || '' };
                },

                t(key) {
                    const dict = {
                        ms: {
                            nav_amalan: 'Amalan',
                            nav_quran: 'Al-Quran',
                            nav_karakter: 'Profil',
                            nav_arena: 'Karakter',
                            nav_tetapan: 'Tetapan'
                        },
                        en: {
                            nav_amalan: 'Tracker',
                            nav_quran: 'Quran',
                            nav_karakter: 'Profile',
                            nav_arena: 'Character',
                            nav_tetapan: 'Settings'
                        }
                    };
                    const lang = this.lang || 'ms';
                    return (dict[lang] && dict[lang][key]) ? dict[lang][key] : key;
                },

                ensurePet(p) {
                    if (!p) return;
                    if (!p.pet || typeof p.pet !== 'object') {
                        p.pet = { line: '', hatched: false, ts: null };
                    }
                    if (typeof p.pet.line !== 'string') p.pet.line = '';
                    if (typeof p.pet.hatched !== 'boolean') p.pet.hatched = false;
                },

                choosePetLine(line) {
                    const p = this.activeProfile;
                    if (!p) return;
                    this.ensurePet(p);
                    p.pet.line = line;
                    p.pet.hatched = false;
                    p.pet.ts = Date.now();
                    this.save();
                    this.$nextTick(() => lucide.createIcons());
                },

                canHatchPet() {
                    const p = this.activeProfile;
                    if (!p) return false;
                    this.ensurePet(p);
                    const lvl = this.getUserLevel().level || 1;
                    return !!p.pet.line && lvl >= 3;
                },

                hatchPet() {
                    const p = this.activeProfile;
                    if (!p) return;
                    this.ensurePet(p);
                    if (!this.canHatchPet()) return;
                    p.pet.hatched = true;
                    p.pet.hatchedAt = Date.now();
                    this.save();
                },

                getPetStage(level) {
                    const lvl = Number(level || 1);
                    if (lvl >= 12) return 4;
                    if (lvl >= 8) return 3;
                    if (lvl >= 5) return 2;
                    if (lvl >= 3) return 1;
                    return 0;
                },

                getPetMeta(line, stage) {
                    const l = (line || '').toString();
                    const s = Number(stage || 0);
                    const base = {
                        flame: {
                            bg: 'gradient-red',
                            stages: [
                                { name: 'Telur Bara', icon: 'egg' },
                                { name: 'Retak Api', icon: 'egg' },
                                { name: 'Pyro Cub', icon: 'flame' },
                                { name: 'Inferno Rogue', icon: 'swords' },
                                { name: 'Phoenix Lord', icon: 'crown' }
                            ]
                        },
                        ocean: {
                            bg: 'gradient-blue',
                            stages: [
                                { name: 'Telur Ombak', icon: 'egg' },
                                { name: 'Retak Air', icon: 'egg' },
                                { name: 'Aqua Sprite', icon: 'droplets' },
                                { name: 'Tidal Knight', icon: 'shield' },
                                { name: 'Leviathan', icon: 'award' }
                            ]
                        },
                        forest: {
                            bg: 'gradient-green',
                            stages: [
                                { name: 'Telur Rimba', icon: 'egg' },
                                { name: 'Retak Daun', icon: 'egg' },
                                { name: 'Mossling', icon: 'leaf' },
                                { name: 'Wild Ranger', icon: 'target' },
                                { name: 'Ancient Guardian', icon: 'shield-check' }
                            ]
                        }
                    };
                    const picked = base[l] || base.forest;
                    const meta = picked.stages[Math.min(Math.max(s, 0), 4)];
                    return { name: meta.name, icon: meta.icon, bgClass: picked.bg };
                },

                petProgressPct(level) {
                    const lvl = Number(level || 1);
                    const bands = [1, 3, 5, 8, 12];
                    const s = this.getPetStage(lvl);
                    const start = bands[s] || 1;
                    const end = bands[s + 1] || (start + 1);
                    const pct = Math.max(0, Math.min(1, (lvl - start) / (end - start)));
                    return Math.round(pct * 100);
                },

                petProgressLabel(level) {
                    const lvl = Number(level || 1);
                    const s = this.getPetStage(lvl);
                    const nextReq = [3, 5, 8, 12, null][s];
                    if (!nextReq) return 'MAX';
                    return `LVL ${lvl} / ${nextReq}`;
                },

                isStreakDay(day) {
                    const d = Number(day);
                    const scores = this.activeProfile?.scores || {};
                    const startDay = (() => {
                        let anchor = this.currentDay;
                        if (!scores[anchor] || Object.keys(scores[anchor] || {}).length === 0) {
                            anchor = Math.max(1, anchor - 1);
                        }
                        const len = this.calculateStreak();
                        return Math.max(1, anchor - len + 1);
                    })();
                    const endDay = (() => {
                        let anchor = this.currentDay;
                        if (!scores[anchor] || Object.keys(scores[anchor] || {}).length === 0) {
                            anchor = Math.max(1, anchor - 1);
                        }
                        return anchor;
                    })();
                    if (!Number.isFinite(d)) return false;
                    return d >= startDay && d <= endDay && (this.getDailyPct(d) > 0);
                },

                modeLabel(mode) {
                    const m = (mode || '').toString().toUpperCase();
                    const labels = {
                        ms: { EASY: 'Permulaan', NORMAL: 'Biasa', HARD: 'Intensif' },
                        en: { EASY: 'Beginner', NORMAL: 'Standard', HARD: 'Intensive' }
                    };
                    const lang = this.lang || 'ms';
                    return (labels[lang] && labels[lang][m]) ? labels[lang][m] : m;
                },

                createProfile() {
                    if (!this.onboarding.name) return;
                    // Security: Sanitize name
                    const sanitizedName = this.onboarding.name.replace(/<[^>]*>?/gm, '').substring(0, 20);
                    const id = 'p_' + Date.now();
                    const newProfile = {
                        id: id,
                        name: sanitizedName,
                        mode: this.onboarding.mode,
                        ibadahList: JSON.parse(JSON.stringify(this.templates[this.onboarding.mode].list)),
                        scores: {},
                        totalXP: 0,
                        pet: { line: '', hatched: false, ts: null },
                        badges: []
                    };
                    this.allProfiles.push(newProfile);
                    this.activeProfileId = id;
                    this.onboarding = { name: '', mode: 'NORMAL' };
                    this.view = 'tracker';
                    this.save();
                },

                switchProfile(id) {
                    const p = this.allProfiles.find(x => x.id === id);
                    if (confirm(`Masuk sebagai ${p.name}?`)) {
                        this.activeProfileId = id;
                        this.view = 'tracker';
                        this.save();
                    }
                },

                logout() {
                    this.activeProfileId = null;
                    this.view = 'onboarding';
                    this.save();
                },

                deleteActiveProfile() {
                    if (confirm(`Padam profil ${this.activeProfile.name}?`)) {
                        this.allProfiles = this.allProfiles.filter(p => p.id !== this.activeProfileId);
                        this.activeProfileId = this.allProfiles.length > 0 ? this.allProfiles[0].id : null;
                        this.view = this.activeProfileId ? 'profiles' : 'onboarding';
                        this.save();
                    }
                },

                updateScore(itemId, value) {
                    const profile = this.activeProfile;
                    if (!profile.scores[this.currentDay]) profile.scores[this.currentDay] = {};
                    profile.scores[this.currentDay][itemId] = value;
                    this.recalculateTotalXP();
                    this.checkBadges();
                    this.save();
                },

                getScore(itemId) {
                    return (this.activeProfile?.scores[this.currentDay] && this.activeProfile.scores[this.currentDay][itemId]) || 0;
                },

                calculateTotal(day, profileId = null) {
                    const p = profileId ? this.allProfiles.find(x => x.id === profileId) : this.activeProfile;
                    if (!p || !p.scores[day]) return 0;
                    return Object.values(p.scores[day]).reduce((a, b) => a + b, 0);
                },

                getDailyPct(day) {
                    return Math.min(Math.round((this.calculateTotal(day) / 50) * 100), 100);
                },

                getProgressColor(total) {
                    const pct = (total / 50) * 100;
                    if (pct < 40) return 'gradient-red';
                    if (pct < 80) return 'gradient-yellow';
                    return 'gradient-green';
                },

                recalculateTotalXP() {
                    const p = this.activeProfile;
                    let xp = 0;
                    for (let d = 1; d <= 30; d++) {
                        xp += this.calculateTotal(d);
                        // Full Solat Bonus (+50 XP)
                        const solatIds = ['subuh', 'zohor', 'asar', 'maghrib', 'isyak'];
                        const hasAllSolat = solatIds.every(id => (p.scores[d] && p.scores[d][id] > 0));
                        if (hasAllSolat) xp += 50;
                    }
                    p.totalXP = xp;
                },

                getUserLevel(customXP = null) {
                    const xp = customXP !== null ? customXP : (this.activeProfile?.totalXP || 0);
                    const level = Math.floor(xp / 500) + 1;
                    const progress = ((xp % 500) / 500) * 100;
                    return { level, progress };
                },

                runTests() {
                    console.group(' Ramadan RPG Self-Test Suite');
                    const tests = [
                        { name: 'Level 1 at 0 XP', result: this.getUserLevel(0).level === 1 },
                        { name: 'Level 2 at 500 XP', result: this.getUserLevel(500).level === 2 },
                        { name: 'Level 3 at 1200 XP', result: this.getUserLevel(1200).level === 3 },
                        { name: 'Progress 50% at 250 XP', result: this.getUserLevel(250).progress === 50 },
                        { name: 'Masihi Date Feb 18 for Day 1', result: this.getMasihiDate(1).includes('18 Feb') },
                        { name: 'Masihi Date Mar 19 for Day 30', result: this.getMasihiDate(30).includes('19 Mac') }
                    ];

                    tests.forEach(t => console.log(`${t.result ? '' : ''} ${t.name}`));
                    console.groupEnd();
                    return tests.every(t => t.result);
                },

                calculateStreak() {
                    const scores = this.activeProfile?.scores || {};
                    let streak = 0;
                    // Check backwards from current day (or day before if today empty)
                    for (let d = 30; d >= 1; d--) {
                        if (this.calculateTotal(d) > 0) {
                            streak++;
                        } else if (streak > 0) {
                            break;
                        }
                    }
                    return streak;
                },

                checkFullSolatBonus() {
                    const p = this.activeProfile;
                    const solatIds = ['subuh', 'zohor', 'asar', 'maghrib', 'isyak'];
                    return solatIds.every(id => (p?.scores[this.currentDay] && p.scores[this.currentDay][id] > 0));
                },

                checkBadges() {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (!p.badges) p.badges = [];

                    // 1. Baitul Jannah (12 Rakaat Sunat)
                    const sunatIds = ['tahajud', 'sunat_subuh', 'dhuha', 'rawatib_zohor', 'rawatib_asar', 'rawatib_maghrib', 'rawatib_isyak', 'tarawih', 'witir'];
                    let totalSunat = 0;
                    sunatIds.forEach(id => {
                        const score = p.scores[this.currentDay]?.[id] || 0;
                        totalSunat += score;
                    });
                    if (totalSunat >= 12 && !p.badges.includes('baitul_jannah')) p.badges.push('baitul_jannah');

                    // 2. Rookie (Tracked 1 day)
                    if (this.getTotalDaysTracked() >= 1 && !p.badges.includes('ramadan_rookie')) p.badges.push('ramadan_rookie');

                    // 3. Fast Learner (Level 5)
                    if (this.getUserLevel().level >= 5 && !p.badges.includes('fast_learner')) p.badges.push('fast_learner');

                    // 4. Streak Starter (3 Days)
                    if (this.calculateStreak() >= 3 && !p.badges.includes('streak_starter')) p.badges.push('streak_starter');

                    // 5. Perfect Day
                    if (this.getDailyPct(this.currentDay) >= 100 && !p.badges.includes('perfect_day')) p.badges.push('perfect_day');

                    // Tiers
                    if (p.totalXP >= 5000 && !p.badges.includes('gold_hero')) p.badges.push('gold_hero');
                    if (p.totalXP >= 2500 && !p.badges.includes('silver_hero')) p.badges.push('silver_hero');
                    if (p.totalXP >= 1000 && !p.badges.includes('bronze_hero')) p.badges.push('bronze_hero');
                },

                hasBadge(id) {
                    return this.activeProfile?.badges?.includes(id);
                },

                calculateMonthlyAverage(profileId = null) {
                    let totalPct = 0;
                    let count = 0;
                    for (let i = 1; i <= 30; i++) {
                        const dayTotal = this.calculateTotal(i, profileId);
                        if (dayTotal > 0) {
                            totalPct += (dayTotal / 50) * 100;
                            count++;
                        }
                    }
                    return count === 0 ? 0 : Math.round(totalPct / count);
                },

                getTotalDaysTracked() {
                    return Object.keys(this.activeProfile?.scores || {}).filter(d => this.calculateTotal(d) > 0).length;
                },

                getBestDay() {
                    let max = 0;
                    for (let i = 1; i <= 30; i++) {
                        max = Math.max(max, this.calculateTotal(i));
                    }
                    return max;
                },

                calculateTotalJuz() {
                    const p = this.activeProfile;
                    if (!p) return 0;
                    let totalJuz = 0;
                    for (let d = 1; d <= 30; d++) {
                        // Support both 'quran' (Juz unit) and 'quran_ms' (Page unit)
                        const juzVal = p.scores[d]?.quran || 0;
                        const msVal = p.scores[d]?.quran_ms || 0;
                        
                        totalJuz += juzVal;
                        if (msVal > 0) {
                            // In Easy mode, 10ms = 1pt, 20ms = 2pt. 
                            // 1 Juz is approx 20 pages. So 10ms = 0.5 Juz, 20ms = 1 Juz.
                            totalJuz += (msVal * 10) / 20; 
                        }
                    }
                    return Math.min(totalJuz, 30);
                },

                hafazanStatsForJuz(juzNum) {
                    const history = this.activeProfile?.hafazanHistory || [];
                    const entries = history.filter(h => h && h.juz === juzNum);
                    if (entries.length === 0) return { count: 0, avg: 0, last: null, successRate: 0 };

                    const avg = Math.round(entries.reduce((a, e) => a + (e.score || 0), 0) / entries.length);
                    const successCount = entries.filter(e => e.success).length;
                    const last = entries[0];
                    const successRate = Math.round((successCount / entries.length) * 100);
                    return { count: entries.length, avg, last, successRate };
                },

                hafazanBoxClass(avg) {
                    if (avg >= 80) return 'bg-green-500 text-white shadow-sm scale-105';
                    if (avg >= 60) return 'bg-emerald-400 text-white';
                    if (avg >= 40) return 'bg-yellow-400 text-white';
                    if (avg > 0) return 'bg-red-400 text-white';
                    return 'bg-inset text-muted/30';
                },

                calculatePartAverage(part) {
                    let totalPct = 0;
                    let count = 0;
                    const start = (part - 1) * 10 + 1;
                    const end = part * 10;
                    for (let i = start; i <= end; i++) {
                        const dayTotal = this.calculateTotal(i);
                        if (dayTotal > 0) {
                            totalPct += (dayTotal / 50) * 100;
                            count++;
                        }
                    }
                    return count === 0 ? 0 : Math.round(totalPct / count);
                },

                addItem() {
                    if (!this.newItem.name) return;
                    // Security: Sanitize custom item name
                    const sanitizedItemName = this.newItem.name.replace(/<[^>]*>?/gm, '').substring(0, 30);
                    const id = 'c_' + Date.now();
                    // Ensure options have content
                    const cleanOptions = this.newItem.options.filter(o => o.l.trim() !== '');
                    if (cleanOptions.length === 0) {
                        alert('Sila tambah sekurang-kurangnya satu pilihan skor dengan deskripsi.');
                        return;
                    }

                    // Security: Sanitize option labels
                    const sanitizedOptions = cleanOptions.map(o => ({
                        v: parseInt(o.v) || 0,
                        l: o.l.replace(/<[^>]*>?/gm, '').substring(0, 20)
                    }));

                    // Always include a 0 option if not present
                    if (!sanitizedOptions.find(o => o.v === 0)) {
                        sanitizedOptions.unshift({v: 0, l: 'Tiada'});
                    }

                    this.activeProfile.ibadahList.push({ 
                        id: id, 
                        name: sanitizedItemName, 
                        icon: 'star', 
                        options: sanitizedOptions 
                    });
                    this.newItem = { name: '', options: [{v: 0, l: 'Tiada'}, {v: 1, l: 'Ya'}] };
                    this.save();
                },

                getMasihiDate(day) {
                    const ramadanStart = new Date('2026-02-18T00:00:00');
                    const targetDate = new Date(ramadanStart.getTime() + (day - 1) * 24 * 60 * 60 * 1000);
                    const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogo', 'Sep', 'Okt', 'Nov', 'Dis'];
                    return `${targetDate.getDate()} ${months[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
                },

                removeItem(index) {
                    if (confirm('Padam ibadah ini?')) {
                        this.activeProfile.ibadahList.splice(index, 1);
                        this.save();
                    }
                },

                async fetchJuzData(juz) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 15000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Source 1: Quran.com API (Primary - More Reliable)
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?juz_number=${juz}`);
                        const data = await res.json();
                        if (data.verses && data.verses.length > 0) {
                            return data.verses.map(v => ({
                                text: v.text_uthmani,
                                surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                numberInSurah: v.verse_key.split(':')[1],
                                number: v.id
                            }));
                        }
                    } catch (e) { console.warn('Quran.com API failed, trying AlQuran.cloud...'); }

                    // Source 2: AlQuran.cloud (Fallback 1)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/juz/${juz}/quran-uthmani`);
                        const data = await res.json();
                        if (data.code === 200) return data.data.verses;
                    } catch (e) { console.warn('AlQuran.cloud Uthmani failed'); }

                    // Source 3: AlQuran.cloud (Fallback 2 - Simple)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/juz/${juz}`);
                        const data = await res.json();
                        if (data.code === 200) return data.data.verses;
                    } catch (e) { console.error('All Quran API sources failed'); }

                    throw new Error('Semua sumber API gagal dicapai.');
                },

                async fetchSurahList() {
                    try {
                        const res = await fetch('https://api.alquran.cloud/v1/surah');
                        const data = await res.json();
                        if (data.code === 200) {
                            this.mushaf.surahs = data.data;
                        }
                    } catch (e) { console.error('Failed to fetch surahs:', e); }
                },

                async fetchSurahData(surahId) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Source 1: Quran.com API (Primary)
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahId}`);
                        const data = await res.json();
                        if (data.verses && data.verses.length > 0) {
                            return data.verses.map(v => ({
                                text: v.text_uthmani,
                                surah: { name: 'Surah ' + surahId },
                                numberInSurah: v.verse_key.split(':')[1],
                                number: v.id
                            }));
                        }
                    } catch (e) { console.warn('Quran.com Surah API failed, trying AlQuran.cloud...'); }

                    // Source 2: AlQuran.cloud (Fallback)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/surah/${surahId}/quran-uthmani`);
                        const data = await res.json();
                        if (data.code === 200) {
                            return data.data.verses.map(v => ({
                                text: v.text,
                                surah: { name: data.data.name },
                                numberInSurah: v.numberInSurah,
                                number: v.number
                            }));
                        }
                    } catch (e) { console.error('Surah API failed:', e); }
                    return [];
                },

                async fetchMushaf(resetPage = true) {
                    this.mushaf.loading = true;
                    try {
                        if (this.mushaf.selectionMode === 'page') {
                            this.mushaf.verses = await this.fetchPageData(this.mushaf.currentPage);
                        } else if (this.mushaf.selectionMode === 'juz') {
                            this.mushaf.verses = await this.fetchJuzData(this.mushaf.currentJuz);
                            if (resetPage) this.mushaf.currentPage = 1;
                        } else {
                            this.mushaf.verses = await this.fetchSurahData(this.mushaf.currentSurah);
                            if (resetPage) this.mushaf.currentPage = 1;
                        }
                    } catch (e) {
                        console.error('Mushaf Error:', e);
                        alert('Gagal memuatkan Quran. Sila periksa internet.');
                    } finally {
                        this.mushaf.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                async fetchPageData(page) {
                    const fetchWithTimeout = async (url, options = {}, timeout = 15000) => {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), timeout);
                        try {
                            const response = await fetch(url, { ...options, signal: controller.signal });
                            clearTimeout(id);
                            return response;
                        } catch (err) {
                            clearTimeout(id);
                            throw err;
                        }
                    };

                    // Source 1: Quran.com API (Primary)
                    try {
                        const res = await fetchWithTimeout(`https://api.quran.com/api/v4/quran/verses/uthmani?page_number=${page}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.verses && data.verses.length > 0) {
                                return data.verses.map(v => ({
                                    text: v.text_uthmani,
                                    surah: { name: 'Surah ' + v.verse_key.split(':')[0] },
                                    numberInSurah: v.verse_key.split(':')[1],
                                    number: v.id
                                }));
                            }
                        }
                    } catch (e) { console.warn('Quran.com Page API failed, trying AlQuran.cloud...'); }

                    // Source 2: AlQuran.cloud (Fallback)
                    try {
                        const res = await fetchWithTimeout(`https://api.alquran.cloud/v1/page/${page}/quran-uthmani`);
                        if (!res.ok) throw new Error('Bad response');
                        const data = await res.json();
                        if (data.code === 200) {
                            return data.data.verses.map(v => ({
                                text: v.text,
                                surah: { name: v.surah.name },
                                numberInSurah: v.numberInSurah,
                                number: v.number
                            }));
                        }
                    } catch (e) { console.error('Page API failed:', e); }

                    throw new Error('Semua sumber API gagal dicapai.');
                },

                get filteredSurahs() {
                    if (!this.mushaf.searchSurah) return this.mushaf.surahs;
                    return this.mushaf.surahs.filter(s => 
                        s.englishName.toLowerCase().includes(this.mushaf.searchSurah.toLowerCase()) ||
                        s.name.includes(this.mushaf.searchSurah)
                    );
                },

                get paginatedVerses() {
                    if (this.mushaf.viewMode === 'list' || this.mushaf.selectionMode === 'page') return this.mushaf.verses;
                    const perPage = 10;
                    const start = (this.mushaf.currentPage - 1) * perPage;
                    return this.mushaf.verses.slice(start, start + perPage);
                },

                get totalMushafPages() {
                    if (this.mushaf.selectionMode === 'page') return 604;
                    const perPage = 10;
                    return Math.ceil(this.mushaf.verses.length / perPage) || 1;
                },

                startLocationTracking() {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.watchPosition(
                            (pos) => {
                                this.userLocation = {
                                    lat: pos.coords.latitude,
                                    lng: pos.coords.longitude
                                };
                                this.updateNextPrayer();
                            }, (err) => {
                                console.warn('Geolocation error:', err);
                            }, { enableHighAccuracy: true });
                    }
                },

                prayerCacheKey() {
                    const zone = this.prayer.zone || 'WLY01';
                    const today = new Date();
                    return `${zone}-${today.getFullYear()}-${today.getMonth() + 1}`;
                },

                async ensurePrayerTimes() {
                    if (!this.prayer.enabled) return;
                    if (!this.userLocation) return;

                    const key = this.prayerCacheKey();
                    const today = new Date();
                    if (!key) return;

                    if (this.prayer.cacheKey === key && this.prayer.timings && this.prayer.dateKey === today.toDateString()) {
                        this.updateNextPrayer();
                        return;
                    }

                    // Auto-detect zone if not set or if user wants refresh
                    if (!this.prayer.zone || this.prayer.zone === 'detecting') {
                        await this.fetchPrayerTimes();
                    }
                },

                tsToTime(ts) {
                    const h = Math.floor(ts / 3600);
                    const m = Math.floor((ts % 3600) / 60);
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                },

                parsePrayerTimeToDate(hhmm) {
                    const m = (hhmm || '').match(/^(\d{1,2}):(\d{2})/);
                    if (!m) return null;
                    const d = new Date();
                    d.setHours(Number(m[1]), Number(m[2]), 0, 0);
                    return d;
                },

                updateNextPrayer() {
                    const t = this.prayer.timings;
                    if (!t) {
                        this.prayer.nextLabel = this.lang === 'en' ? 'No data' : 'Tiada data';
                        this.prayer.countdown = '';
                        return;
                    }

                    const order = [
                        { k: 'Fajr', labelMs: 'Subuh', labelEn: 'Fajr' },
                        { k: 'Dhuhr', labelMs: 'Zohor', labelEn: 'Dhuhr' },
                        { k: 'Asr', labelMs: 'Asar', labelEn: 'Asr' },
                        { k: 'Maghrib', labelMs: 'Maghrib', labelEn: 'Maghrib' },
                        { k: 'Isha', labelMs: 'Isyak', labelEn: 'Isha' }
                    ];

                    const now = new Date();
                    let next = null;

                    for (const it of order) {
                        const d = this.parsePrayerTimeToDate(t[it.k]);
                        if (d && d.getTime() > now.getTime()) {
                            next = { ...it, time: t[it.k], date: d };
                            break;
                        }
                    }

                    if (next) {
                        this.prayer.nextLabel = this.lang === 'en' ? next.labelEn : next.labelMs;
                        const diff = Math.floor((next.date.getTime() - now.getTime()) / 60000);
                        if (diff > 0) {
                            const h = Math.floor(diff / 60);
                            const m = diff % 60;
                            this.prayer.countdown = this.lang === 'en'
                                ? `${h > 0 ? `${h}h ` : ''}${m}m`
                                : `${h > 0 ? `${h}j ` : ''}${m}m`;
                        } else {
                            this.prayer.countdown = '';
                        }
                    } else {
                        // After Isha, show Fajr of next day
                        this.prayer.nextLabel = this.lang === 'en' ? 'Fajr (tomorrow)' : 'Subuh (esok)';
                        this.prayer.countdown = '';
                    }
                },

                prayerRows() {
                    const t = this.prayer.timings || {};
                    const tr = (ms, en) => (this.lang === 'en' ? en : ms);
                    const rows = [
                        { k: 'Fajr', label: tr('Subuh', 'Fajr') },
                        { k: 'Sunrise', label: tr('Syuruk', 'Sunrise') },
                        { k: 'Dhuhr', label: tr('Zohor', 'Dhuhr') },
                        { k: 'Asr', label: tr('Asar', 'Asr') },
                        { k: 'Maghrib', label: tr('Maghrib', 'Maghrib') },
                        { k: 'Isha', label: tr('Isyak', 'Isha') }
                    ];
                    return rows.map(r => ({ ...r, time: (t[r.k] || '--:--').toString().trim() }));
                },

                async startQuiz() {
                    this.quiz.active = true;
                    this.quiz.status = 'idle';
                    this.quiz.transcript = '';
                    this.quiz.detectedSegment = '';
                    this.quiz.recitedText = '';
                    this.quiz.voiceStage = 'idle';
                    this.quiz.voiceProgress = 0;
                    this.quiz.voiceCompleted = false;
                    this.quiz.hintWordsUnlocked = 0;
                    this.quiz.matchedWords = [];
                    this.quiz.targetContinuationText = '';
                    this.quiz.loading = true;
                    this.quiz.selectedMcqIndex = -1;
                    this.quiz.mcqPhase = 0;
                    this.quiz.mcqBuiltText = '';
                    this.quiz.mcqPhases = [];
                    
                    try {
                        let verses;
                        if (this.quiz.selectionMode === 'page') {
                            const page = this.quiz.currentPage || this.mushaf.currentPage;
                            verses = await this.fetchPageData(page);
                        } else if (this.quiz.selectionMode === 'juz') {
                            verses = await this.fetchJuzData(this.quiz.currentJuz);
                        } else {
                            verses = await this.fetchSurahData(this.quiz.currentSurah);
                        }
                        
                        if (!verses || verses.length < 2) throw new Error('Not enough verses');

                        const idx = Math.floor(Math.random() * (verses.length - 1));
                        const verse = verses[idx];
                        const nextVerse = verses[idx + 1];

                        this.quiz.verse = {
                            text: verse.text,
                            nextText: nextVerse.text,
                            surah: verse.surah.name,
                            numberInSurah: verse.numberInSurah,
                            juz: verse.juz || this.quiz.currentJuz || null
                        };

                        this.quiz.targetContinuationText = this.buildContinuationTarget(verses, idx, 200, 20);

                        if (this.quiz.testMode === 'mcq') this.generateMcqPhases(verses, idx + 1);

                        this.quiz.session.total++;
                    } catch (e) {
                        console.error('Quiz Error:', e);
                        alert('Gagal memuatkan ayat. Sila periksa internet.');
                        this.quiz.active = false;
                    } finally {
                        this.quiz.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                generateMcqPhases(verses, correctIdx) {
                    const correctFull = verses[correctIdx].text;
                    const words = (correctFull || '').split(/\s+/).filter(Boolean);
                    const targetMaxChars = 200;
                    const chunks = [];

                    const pushChunk = (w) => {
                        if (!w || w.length === 0) return;
                        chunks.push(w.join(' '));
                    };

                    const chunkCount = 3;
                    const perChunk = Math.max(1, Math.ceil(words.length / chunkCount));
                    for (let i = 0; i < chunkCount; i++) {
                        pushChunk(words.slice(i * perChunk, (i + 1) * perChunk));
                    }

                    const trimmedChunks = [];
                    let running = '';
                    for (const c of chunks) {
                        if (!c) continue;
                        const next = (running ? (running + ' ' + c) : c);
                        if (next.length > targetMaxChars) break;
                        trimmedChunks.push(c);
                        running = next;
                        if (trimmedChunks.length === 3) break;
                    }

                    while (trimmedChunks.length < 3 && trimmedChunks.length > 0) trimmedChunks.push('');
                    if (trimmedChunks.length === 0) {
                        trimmedChunks.push(correctFull.slice(0, Math.min(correctFull.length, targetMaxChars)));
                        while (trimmedChunks.length < 3) trimmedChunks.push('');
                    }

                    const distractorPool = verses
                        .filter((_, i) => i !== correctIdx)
                        .map(v => v.text)
                        .filter(Boolean);

                    const phases = trimmedChunks.map((correctText) => {
                        let wrongText = '';
                        if (distractorPool.length > 0) {
                            const src = distractorPool[Math.floor(Math.random() * distractorPool.length)];
                            const srcWords = src.split(/\s+/).filter(Boolean);
                            const take = Math.max(2, (correctText || '').split(/\s+/).filter(Boolean).length);
                            wrongText = srcWords.slice(0, take).join(' ');
                            if (!wrongText) wrongText = src.slice(0, Math.min(src.length, 60));
                        }
                        const options = [correctText, wrongText].filter(v => v !== '');
                        if (options.length === 1) options.push(options[0]);
                        if (Math.random() > 0.5) [options[0], options[1]] = [options[1], options[0]];
                        return {
                            correctText,
                            options,
                            correctIndex: options.indexOf(correctText)
                        };
                    });

                    this.quiz.mcqPhases = phases;
                    this.quiz.mcqPhase = 0;
                    this.quiz.mcqOptions = phases[0]?.options || [];
                    this.quiz.mcqCorrectIndex = phases[0]?.correctIndex ?? -1;
                    this.quiz.mcqBuiltText = '';
                },

                checkMcqAnswer(index) {
                    if (this.quiz.status !== 'idle') return;
                    
                    this.quiz.selectedMcqIndex = index;
                    const phase = this.quiz.mcqPhases[this.quiz.mcqPhase];
                    if (!phase) return;

                    if (index === phase.correctIndex) {
                        if (phase.correctText) {
                            this.quiz.mcqBuiltText = (this.quiz.mcqBuiltText ? (this.quiz.mcqBuiltText + ' ') : '') + phase.correctText;
                        }

                        if (this.quiz.mcqPhase < 2) {
                            this.quiz.mcqPhase++;
                            const next = this.quiz.mcqPhases[this.quiz.mcqPhase];
                            this.quiz.mcqOptions = next?.options || [];
                            this.quiz.mcqCorrectIndex = next?.correctIndex ?? -1;
                            this.quiz.selectedMcqIndex = -1;
                            return;
                        }

                        this.quiz.status = 'success';
                        this.quiz.feedback = 'Masha Allah! Jawapan anda tepat.';
                        this.quiz.session.correct++;
                        this.activeProfile.totalXP += 5;
                    } else {
                        this.quiz.status = 'error';
                        this.quiz.feedback = 'Jawapan kurang tepat. Sila cuba lagi.';
                        this.quiz.session.wrong++;
                    }

                    this.save();
                    this.$nextTick(() => lucide.createIcons());
                },

                unlockHintWord() {
                    const target = (this.quiz.targetContinuationText || '').trim();
                    if (!target) return;
                    const displayed = (this.quiz.verse?.text || '').trim();
                    const continuation = target.startsWith(displayed) ? target.slice(displayed.length).trim() : target;
                    const words = continuation.split(/\s+/).filter(Boolean);
                    this.quiz.hintWordsUnlocked = Math.min(words.length, (this.quiz.hintWordsUnlocked || 0) + 1);
                },

                buildContinuationTarget(verses, startIdx, targetChars = 200, finishAyahThreshold = 20) {
                    const parts = [];
                    let running = '';

                    for (let i = startIdx; i < verses.length; i++) {
                        const t = (verses[i]?.text || '').trim();
                        if (!t) continue;
                        const next = running ? (running + ' ' + t) : t;

                        if (next.length <= targetChars) {
                            parts.push(t);
                            running = next;
                            continue;
                        }

                        const remaining = next.length - targetChars;
                        if (remaining <= finishAyahThreshold) {
                            parts.push(t);
                            running = next;
                        }
                        break;
                    }

                    return parts.join(' ').trim();
                },

                normalizeArabic(str) {
                    return (str || '')
                        .replace(/[\u064B-\u0652\u06D6-\u06ED]/g, "")
                        .replace(/[]/g, "")
                        .replace(//g, "")
                        .replace(//g, "")
                        .replace(/\s+/g, ' ')
                        .trim();
                },

                computeOrderedMatchScore(userText, targetText) {
                    const u = this.normalizeArabic(userText).split(/\s+/).filter(Boolean);
                    const t = this.normalizeArabic(targetText).split(/\s+/).filter(Boolean);
                    if (t.length === 0) return { score: 0, matched: 0, total: 0 };

                    let ti = 0;
                    let matched = 0;
                    for (const w of u) {
                        while (ti < t.length) {
                            const tw = t[ti];
                            if (tw.includes(w) || w.includes(tw)) {
                                matched++;
                                ti++;
                                break;
                            }
                            ti++;
                        }
                        if (ti >= t.length) break;
                    }

                    return { score: matched / t.length, matched, total: t.length };
                },

                recordHafazanAttempt(success, score) {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (!p.hafazanHistory) p.hafazanHistory = [];
                    p.hafazanHistory.unshift({
                        ts: Date.now(),
                        juz: this.quiz.selectionMode === 'juz' ? this.quiz.currentJuz : (this.quiz.verse?.juz || null),
                        mode: this.quiz.testMode,
                        success: !!success,
                        score: Math.round((score || 0) * 100)
                    });
                    p.hafazanHistory = p.hafazanHistory.slice(0, 500);
                    this.save();
                },

                randomizeAyat() {
                    this.randomizeAyatWithinScope();
                },

                async randomizeAyatWithinScope() {
                    this.quiz.status = 'idle';
                    this.quiz.transcript = '';
                    this.quiz.matchedWords = [];
                    this.quiz.selectedMcqIndex = -1;
                    this.quiz.loading = true;

                    try {
                        let verses;

                        if (this.mushaf.selectionMode === 'page') {
                            verses = await this.fetchPageData(this.mushaf.currentPage);
                            this.quiz.selectionMode = 'page';
                        } else if (this.mushaf.selectionMode === 'juz') {
                            verses = await this.fetchJuzData(this.mushaf.currentJuz);
                            this.quiz.selectionMode = 'juz';
                            this.quiz.currentJuz = this.mushaf.currentJuz;
                        } else {
                            verses = await this.fetchSurahData(this.mushaf.currentSurah);
                            this.quiz.selectionMode = 'surah';
                            this.quiz.currentSurah = this.mushaf.currentSurah;
                        }

                        if (!verses || verses.length < 2) throw new Error('Not enough verses');

                        const idx = Math.floor(Math.random() * (verses.length - 1));
                        const verse = verses[idx];
                        const nextVerse = verses[idx + 1];

                        this.quiz.verse = {
                            text: verse.text,
                            nextText: nextVerse.text,
                            surah: verse.surah?.name,
                            numberInSurah: verse.numberInSurah,
                            juz: verse.juz || this.quiz.currentJuz || null
                        };

                        this.quiz.targetContinuationText = this.buildContinuationTarget(verses, idx, 200, 20);

                        if (this.quiz.testMode === 'mcq') this.generateMcqPhases(verses, idx + 1);
                    } catch (e) {
                        console.error('Randomize Ayat Error:', e);
                        alert('Gagal memuatkan ayat. Sila periksa internet anda.');
                    } finally {
                        this.quiz.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                toggleRecitation() {
                    if (this.quiz.recording) {
                        this.stopRecitation();
                    } else {
                        this.startRecitation();
                    }
                },

                startRecitation() {
                    // Check for MediaRecorder support
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Maaf, pelayar anda tidak menyokong rakaman audio. Sila gunakan Chrome atau Edge.');
                        return;
                    }

                    // Start audio recording
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            this.mediaRecorder = new MediaRecorder(stream);
                            this.audioChunks = [];
                            
                            this.mediaRecorder.ondataavailable = (event) => {
                                this.audioChunks.push(event.data);
                            };
                            
                            this.mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                                await this.transcribeWithWhisper(audioBlob);
                                stream.getTracks().forEach(track => track.stop());
                            };
                            
                            this.mediaRecorder.start();
                            this.quiz.recording = true;
                            this.quiz.voiceStage = 'recording';
                            this.quiz.status = 'idle';
                            this.quiz.transcript = '';
                            this.resetQuizIdleTimer();
                        })
                        .catch(error => {
                            console.error('Error accessing microphone:', error);
                            alert('Tidak dapat mengakses mikrofon. Sila periksa kebenaran mikrofon.');
                        });
                },

                resetQuizIdleTimer() {
                    if (this.quiz.idleTimer) clearTimeout(this.quiz.idleTimer);
                    this.quiz.idleTimer = setTimeout(() => {
                        if (this.quiz.recording) {
                            this.stopRecitation();
                        }
                    }, 5000); // 5 seconds of silence = finish
                },

                stopRecitation() {
                    if (this.quiz.idleTimer) clearTimeout(this.quiz.idleTimer);
                    this.quiz.recording = false;
                    
                    if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                        this.mediaRecorder.stop();
                    }

                    if (this.quiz.recitedText && this.quiz.recitedText.trim()) {
                        this.quiz.voiceStage = 'review';
                    } else {
                        this.quiz.voiceStage = 'idle';
                    }
                },

                async transcribeWithWhisper(audioBlob) {
                    try {
                        this.quiz.loading = true;
                        
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('model', 'whisper-large-v3-turbo');
                        formData.append('language', 'ar');
                        formData.append('response_format', 'json');
                        
                        const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer YOUR_OPENAI_API_KEY' // Replace with actual API key
                            },
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Whisper API request failed');
                        }
                        
                        const result = await response.json();
                        const seg = (result.text || '').trim();
                        this.quiz.detectedSegment = seg;
                        this.quiz.transcript = seg;

                        if (seg) {
                            this.quiz.recitedText = (this.quiz.recitedText ? (this.quiz.recitedText + ' ') : '') + seg;
                        }

                        this.quiz.voiceStage = 'review';
                        
                        const target = this.quiz.targetContinuationText || this.quiz.verse?.text || '';
                        const scoreObj = this.computeOrderedMatchScore(this.quiz.recitedText, target);
                        this.quiz.voiceProgress = Math.min(1, scoreObj.score);

                        const recitedLen = (this.quiz.recitedText || '').trim().length;
                        const targetLen = (target || '').trim().length;
                        const remaining = Math.max(0, targetLen - recitedLen);
                        const charHit = recitedLen >= 200;
                        const nearEnd = remaining > 0 && remaining <= 20;
                        this.quiz.voiceCompleted = !!(charHit || nearEnd || scoreObj.score >= 0.72);
                        
                    } catch (error) {
                        console.error('Whisper API Error:', error);
                        this.quiz.status = 'error';
                        this.quiz.feedback = 'Ralat transkripsi. Sila cuba lagi.';
                    } finally {
                        this.quiz.loading = false;
                    }
                },

                async analyzeWithTarteel(audioBlob) {
                    try {
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('reference_text', this.quiz.verse.text);
                        
                        const response = await fetch('https://api.tarteel.ai/v1/analyze', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer YOUR_TARTEEL_API_KEY', // Replace with actual API key
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                audio: await this.blobToBase64(audioBlob),
                                reference_text: this.quiz.verse.text,
                                analysis_type: 'recitation_errors'
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Tarteel API request failed');
                        }
                        
                        const result = await response.json();
                        
                        // Process Tarteel analysis results
                        if (result.errors && result.errors.length > 0) {
                            this.quiz.feedback = `Ditemui ${result.errors.length} ralat bacaan. Sila perbaiki: ${result.errors.slice(0, 3).join(', ')}`;
                            this.quiz.status = 'warning';
                        } else {
                            this.quiz.feedback = 'Masha Allah! Bacaan anda tepat.';
                            this.quiz.status = 'success';
                            this.quiz.session.correct++;
                            this.activeProfile.totalXP += 5;
                        }
                        
                        this.save();
                        
                    } catch (error) {
                        console.error('Tarteel API Error:', error);
                        // Fallback to basic text comparison if Tarteel fails
                        this.checkQuizAnswer(this.quiz.transcript);
                    }
                },

                blobToBase64(blob) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                },

                checkQuizAnswer(userText) {
                    const target = (this.quiz.targetContinuationText || this.quiz.verse?.text || '').trim();
                    const scoreObj = this.computeOrderedMatchScore(userText, target);

                    if (scoreObj.score >= 0.72) {
                        this.quiz.status = 'success';
                        this.quiz.feedback = `Masha Allah! Hafalan mantap.`;
                        this.quiz.session.correct++;
                        this.activeProfile.totalXP += 10;
                        this.recordHafazanAttempt(true, scoreObj.score);
                        this.save();
                    } else {
                        this.quiz.status = 'error';
                        this.quiz.feedback = `Hampir tepat! Cuba sambung lagi sebelum semak.`;
                        this.quiz.session.wrong++;
                        this.recordHafazanAttempt(false, scoreObj.score);
                    }

                    this.$nextTick(() => lucide.createIcons());
                },

                syncTemplate() {
                    const p = this.activeProfile;
                    if (!p) return;
                    if (confirm(`Kemaskini senarai amalan untuk ${p.name} kepada template ${p.mode} yang terbaru? (Amalan kustom anda tidak akan dipadam)`)) {
                        const templateList = JSON.parse(JSON.stringify(this.templates[p.mode].list));
                        
                        // Keep custom items (those starting with c_)
                        const customItems = p.ibadahList.filter(item => item.id.startsWith('c_'));
                        
                        // Replace standard items with template, then add back custom ones
                        p.ibadahList = [...templateList, ...customItems];
                        this.save();
                        alert('Senarai amalan telah dikemaskini!');
                        location.reload(); // Reload to refresh icons and UI
                    }
                },

                scrollToCurrentDay() {
                    const el = document.querySelector(`[data-day="${this.currentDay}"]`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                },

                saveGlobal() {
                    this.save();
                },

                save() {
                    localStorage.setItem('ramadan_rpg_data', JSON.stringify({
                        activeId: this.activeProfileId,
                        profiles: this.allProfiles,
                        darkMode: this.darkMode,
                        theme: this.theme,
                        lang: this.lang,
                        islamicQuoteIndex: this.islamicQuoteIndex,
                        islamicQuoteDateKey: this.islamicQuoteDateKey,
                        mushafFontSize: this.mushaf?.fontSize,
                        mushafFontFamily: this.mushaf?.fontFamily,
                        prayer: {
                            enabled: this.prayer.enabled,
                            placement: this.prayer.placement,
                            zone: this.prayer.zone,
                            cacheKey: this.prayer.cacheKey,
                            dateKey: this.prayer.dateKey,
                            timings: this.prayer.timings,
                            nextLabel: this.prayer.nextLabel,
                            countdown: this.prayer.countdown
                        }
                    }));
                }
            }
        }
    </script>
</body>
</html>
